/*! textae 4.0.3 23-06-2014 */
!function(a){var c=function(){var a=function(){var a={};return{bind:function(b,c){if(!_.isFunction(c))throw new Error("Only a function is bindable!");return a[b]=a[b]||[],a[b].push(c),this},unbind:function(b,c){return a[b]?(a[b]=_.reject(a[b],function(a){return a===c}),this):this},trigger:function(b,c){return a[b]&&a[b].forEach(function(a){a(c)}),c}}};return{ajaxAccessor:function(){var a=function(a){return!a||""===a};return{getSync:function(b){if(!a(b)){var c=null;return $.ajax({type:"GET",url:b,async:!1}).done(function(a){c=a}),c}},getAsync:function(b,c,d){a(b)||$.ajax({type:"GET",url:b,cache:!1}).done(function(a){void 0!==c&&c(a)}).fail(function(){alert("connection failed.")}).always(function(){void 0!==d&&d()})},post:function(b,c,d,e,f){a(b)||(console.log("POST data",c),$.ajax({type:"post",url:b,contentType:"application/json",data:c,crossDomain:!0,xhrFields:{withCredentials:!0}}).done(d).fail(e).always(f))}}}(),getUrlParameters:function(a){var b=a?String(a).replace(/^\?(.*)/,"$1"):"",c=b.length>0?b.split("&"):[];return c.map(function(a){var b=a.split("=");return{key:b[0],val:b[1]}}).reduce(function(a,b){return a[b.key]=b.val?b.val:!0,a},{})},makeInformationModal:function(){var a=function(){var a=function(){var a=$("."+this.className);return 0===a.length&&(a=$("<div>").addClass("textae__information-modal").addClass(this.className).hide(),this.addContentsFunc.call(a),$("body").append(a)),a},b=function(a){var b=$(window);a.css({position:"absolute",top:(b.height()-a.height())/2+b.scrollTop(),left:(b.width()-a.width())/2+b.scrollLeft()})};$(".textae__information-modal").hide();var c=a.call(this);b(c),c.show()},b=function(){$("."+this.className).hide()},c=function(c){return{show:a.bind(c),hide:b.bind(c)}};return $(function(){$("body").on("mouseup",".textae__information-modal",function(){$(this).hide()})}),c}(),getDialog:function(){var a={};return function(b,c,d,e,f){var g=function(a){var b=$("<div>").attr("id",a).attr("title",d).hide().append(e);return $.extend(b,{open:function(){this.dialog({resizable:!1,width:550,height:220,modal:!0,buttons:f?{}:{Cancel:function(){$(this).dialog("close")}}})},close:function(){this.dialog("close")}}),b},h=b+"."+c;if(a.hasOwnProperty(h))return a[h];var i=g(h);return $.extend(e,{dialogClose:function(){i.close()}}),$("body").append(i),a[h]=i,i}}(),extendBindable:function(b){return _.extend({},b,a())}}}(),d=function(a){var b=[];return{makeSpanId:function(b,c){return a.editorId+"__S"+b+"_"+c},parseSpanId:function(b){var c=b.replace(a.editorId+"__S","").split("_");return{begin:Number(c[0]),end:Number(c[1])}},makeTypeId:function(a,c){return-1===b.indexOf(c)&&b.push(c),a+"-"+b.indexOf(c)},makeEntityDomId:function(b){return a.editorId+"__E"+b},makeParagraphId:function(b){return a.editorId+"__P"+b}}},e=function(a){var b=function(){var d,e=function(a,b){var c=b().filter(function(b){return b[0]===a}).map(function(a){return a.slice(1)});return a+(0===c.length?1:Math.max.apply(null,c)+1)},f=function(){var c={},d=[],e=function(d){var e={isChildOf:function(b){if(!b)return!1;var e=a.makeSpanId(b.begin,b.end);if(!c[e])throw new Error("maybeParent is removed. "+b.toStringOnlyThis());return b.begin<=d.begin&&d.end<=b.end},toStringOnlyThis:function(){return"span "+this.begin+":"+this.end+":"+b.sourceDoc.substring(this.begin,this.end)},toString:function(a){a=a||1;var b=this.children&&this.children.length>0?"\n"+this.children.map(function(b){return new Array(a+1).join("	")+b.toString(a+1)}).join("\n"):"";return this.toStringOnlyThis()+b},getBigBrother:function(){var a;return this.parent?(a=this.parent.children.indexOf(this),0===a?null:this.parent.children[a-1]):(a=b.span.topLevel().indexOf(this),0===a||b.span.topLevel()[a-1].paragraph!==this.paragraph?null:b.span.topLevel()[a-1])},getTypes:function(){var c=this.id;return b.entity.all().filter(function(a){return c===a.span}).reduce(function(b,c){var d=a.makeTypeId(c.span,c.type),e=b.filter(function(a){return a.id===d});return e.length>0?e[0].entities.push(c.id):b.push({id:d,name:c.type,entities:[c.id]}),b},[])},getEntities:function(){return _.flatten(this.getTypes().map(function(a){return a.entities}))}},f=a.makeSpanId(d.begin,d.end);if(!b.span.get(f)){var g=$.extend({id:f,paragraph:j.findParagraph(d)},d,e);return c[f]=g,g}},f=function(a,b){return a.begin-b.begin||b.end-a.end},g=function(){var a=b.span.all().sort(f),c=[];a.map(function(a,b,c){return $.extend(a,{children:[],left:0!==b?c[b-1]:null,right:b!==c.length-1?c[b+1]:null})}).forEach(function(a){var b=c[c.length-1];a.isChildOf(a.left)?(a.left.children.push(a),a.parent=a.left):a.left&&a.isChildOf(a.left.parent)?(a.left.parent.children.push(a),a.parent=a.left.parent):a.isChildOf(b)?(b.children.push(a),a.parent=b):(a.parent=null,c.push(a))}),c.toString=function(){return this.map(function(a){return a.toString()}).join("\n")},d=c},h={add:function(a){var c=e(a);return g(),b.trigger("span.add",c)},concat:function(a){a&&(a.forEach(e),g())},get:function(a){return c[a]},all:function(){return $.map(c,function(a){return a})},range:function(a,b){var d=c[a],e=c[b];if(f(d,e)>0){var g=d;d=e,e=g}return Object.keys(c).filter(function(a){var b=c[a];return d.begin<=b.begin&&b.end<=e.end})},topLevel:function(){return d},multiEntities:function(){return b.span.all().filter(function(a){var b=a.getTypes().filter(function(a){return a.entities.length>1});return b.length>0})},remove:function(a){var d=b.span.get(a);delete c[a],g(),b.trigger("span.remove",d)},clear:function(){c={},d=[]}};return h}(),g=function(){var a={},c=function(){return Object.keys(a)},d=_.partial(e,"E",c),f=function(b){return b.id=b.id||d(),a[b.id]=b,b},g={add:function(a){return b.trigger("entity.add",f(a))},concat:function(a){a&&a.forEach(f)},get:function(b){return a[b]},all:function(){return _.map(a,_.identity)},types:function(){return b.entity.all().map(function(a){return a.type})},assosicatedRelations:function(a){return b.relation.all().filter(function(b){return b.obj===a||b.subj===a}).map(function(a){return a.id})},changeType:function(a,c){var d=b.entity.get(a);return d.type=c,b.trigger("entity.change",d),d},remove:function(c){var d=b.entity.get(c);return d&&(delete a[c],b.trigger("entity.remove",d)),d},clear:function(){a={}}};return g}(),h=function(){var a={},c=function(){return Object.keys(a)},d=_.partial(e,"R",c),f=function(b){return b.id=b.id||d(),a[b.id]=b,b},g={add:function(a){return b.trigger("relation.add",f(a))},concat:function(a){a&&a.forEach(f)},get:function(b){return a[b]},all:function(){return _.map(a,_.identity)},some:function(){return _.some(a)},types:function(){return Object.keys(a).map(function(b){return a[b].pred})},changePredicate:function(c,d){a[c].pred=d,b.trigger("relation.change",a[c])},remove:function(c){b.trigger("relation.remove",a[c]),delete a[c]},clear:function(){a={}}};return g}(),i=function(){var a=[];return{concat:function(b){b&&(a=a.concat(b))},all:function(){return a},clear:function(){a=[]}}}(),j=function(){var b;return{set:function(c){var d=0;b=c.split("\n").map(function(b,c){var e={id:a.makeParagraphId(c),begin:d,end:d+b.length};return d+=b.length+1,e})},get:function(){return b},findParagraph:function(a){var c=b.filter(function(b){return a.begin>=b.begin&&a.end<=b.end});return c.length>0?c[0]:null}}}(),k=c.extendBindable({span:f,entity:g,relation:h,modification:i,sourceDoc:"",reset:function(){var c=function(a){return d=a,a},e=function(a,b){var c=b.text;if(!c)throw"read failed.";return a.sourceDoc=c,j.set(c),k.trigger("change-text",{sourceDoc:c,paragraphs:j.get()}),b},f=function(b,c){var d=c.denotations;return b.span.clear(),b.entity.clear(),d&&(b.span.concat(d.map(function(a){return a.span})),b.entity.concat(d.map(function(b){return{id:b.id,span:a.makeSpanId(b.span.begin,b.span.end),type:b.obj}}))),c},g=function(a,b){var c=b.relations;return a.relation.clear(),a.relation.concat(c),b},h=function(a,b){var c=b.modifications;return a.modification.clear(),a.modification.concat(c),b};return function(a){var d=_.compose(_.partial(h,this),_.partial(g,this),_.partial(f,this),_.partial(e,this),c);try{d(a),k.trigger("all.change",b)}catch(i){throw alert(i),i}}}(),toJson:function(){var a=b.entity.all().map(function(a){var c=b.span.get(a.span);return{id:a.id,span:{begin:c.begin,end:c.end},obj:a.type}});return JSON.stringify($.extend(d,{denotations:a,relations:b.relation.all()}))}});return k}(),d=function(){var a=function(a){var b={},c=function(){f.trigger(a+".change")},d={name:a,add:function(d){b[d]=d,f.trigger(a+".select",d),c()},all:function(){return _.toArray(b)},has:function(a){return _.contains(b,a)},some:function(){return _.some(b)},single:function(){var a=d.all();return 1===a.length?a[0]:null},toggle:function(a){d.has(a)?d.remove(a):d.add(a)},remove:function(d){delete b[d],f.trigger(a+".deselect",d),c()},clear:function(){_.each(d.all(),d.remove),b={},c()}};return d},b=function(a){_.each(a,function(a){a.clear()})},d=function(a){return a.map(function(a){return a.some()}).reduce(function(a,b){return a||b})},e=["span","entity","relation"].map(function(b){return a(b)}),f=c.extendBindable(_.extend(e.reduce(function(a,b){return a[b.name]=b,a},{}),{clear:_.partial(b,e),some:_.partial(d,e)}));return f}();return{annotationData:b,selectionModel:d,getReplicationSpans:function(a,c){var d=function(a){for(var c=String.prototype.indexOf.bind(b.sourceDoc,b.sourceDoc.substring(a.begin,a.end)),d=a.end-a.begin,e=[],f=0,g=c(f);-1!==g;g=c(f))e.push({begin:g,end:g+d}),f=g+d;return e},e=function(b){return b.begin===a.begin},f=function(a){var d=b.sourceDoc.charAt(a.begin-1),e=b.sourceDoc.charAt(a.end);return c.isDelimiter(d)&&c.isDelimiter(e)},g=function(a){return b.span.all().filter(function(b){return b.begin===a.begin&&b.end===a.end}).length>0},h=function(a){return b.span.all().filter(function(b){return b.begin<a.begin&&a.begin<b.end&&b.end<a.end||a.begin<b.begin&&b.begin<a.end&&a.end<b.end}).length>0};return d(a).filter(function(a){return!e(a)&&f(a)&&!g(a)&&!h(a)})}}},f=function(a,b){var d="",e=function(a){var b=function(){this.addClass("textae-editor_wait")},c=function(){this.removeClass("textae-editor_wait")};return{startWait:b.bind(a),endWait:c.bind(a)}}(a),f=function(a){return function(){if($messageArea=a.find(".textae-editor__footer .textae-editor__footer__message"),0===$messageArea.length){$messageArea=$("<div>").addClass("textae-editor__footer__message");var b=$("<div>").addClass("textae-editor__footer").append($messageArea);a.append(b)}return $messageArea}}(a),g=function(a){""!==a&&(f().html('(Target: <a href="'+a+'">'+a+"</a>)"),d=a)},h=function(a){e.startWait(),c.ajaxAccessor.getAsync(a,function(b){j.trigger("load",b),g(a)},function(){e.endWait()})},i=function(){var a=function(a){return a.openAndSetParam||(a.openAndSetParam=_.compose(a.open.bind(a),function(b){this.find('[type="text"].url').val(d).trigger("keyup"),a.params=b})),a},i=_.compose(a,c.getDialog),k=function(a){var c=function(a){var b=new FileReader;b.onload=function(){var a=JSON.parse(this.result);j.trigger("load",a)},b.readAsText(a.files[0])},d=function(a){return $('<input type="button" value="Open" disabled="disabled" />').addClass(a)},e=function(){return!l.params||window.confirm(b)},f=d("server"),g=d("local"),k=$("<div>").append($('<div class="textae-editor__load-dialog__row">').append($('<label class="textae-editor__load-dialog__label">Server</label>'),$('<input type="text" class="textae-editor__load-dialog__file-name url" />'),f)).on("keyup",'[type="text"]',function(){this.value?f.removeAttr("disabled"):f.attr("disabled","disabled")}).on("click","input.server",function(){if(e()){var a=k.find(".textae-editor__load-dialog__file-name").val();h(a)}k.dialogClose()}).append($('<div class="textae-editor__load-dialog__row">').append($('<label class="textae-editor__load-dialog__label">Local</label>'),$('<input class="textae-editor__load-dialog__file" type="file" />'),g)).on("change",'[type="file"]',function(){this.files.length>0?g.removeAttr("disabled"):g.attr("disabled","disabled")}).on("click","input.local",function(){e()&&c(k.find('[type="file"]')[0]),k.dialogClose()}),l=i(a,"textae.dialog.load","Load Annotations",k);return l},l=function(a){var b=function(){f().html("annotation saved").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),g(d)}),j.trigger("save"),e.endWait()},h=function(){f().html("could not save").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),g(d)}),e.endWait()},l=function(a,d){e.startWait(),c.ajaxAccessor.post(a,{annotations:d},b,h,function(){e.endWait()})},m=function(a){var b=new Blob([a],{type:"application/json"});return URL.createObjectURL(b)},n=function(){var b=k(a).find("input[type='file']"),c=b.prop("files")[0];return c?c.name:"annotations.json"},o=$("<div>").append($('<div class="textae-editor__save-dialog__row">').append($('<label class="textae-editor__save-dialog__label">Server</label>'),$('<input type="text" class="textae-editor__save-dialog__server-file-name url" />'),$('<input type="button" class="textae-editor__save-dialog__save-server-button" value="Save" />'))).on("click",".textae-editor__save-dialog__save-server-button",function(){var a=o.find(".textae-editor__save-dialog__server-file-name").val();l(a,p.params),o.dialogClose()}).append($('<div class="textae-editor__save-dialog__row">').append($('<label class="textae-editor__save-dialog__label">Local</label>'),$('<input type="text" class="textae-editor__save-dialog__local-file-name">'),$('<a class="download" href="#">Download</a>'))).on("click","a.download",function(){var a=m(p.params);$(this).attr("href",a).attr("download",o.find(".textae-editor__save-dialog__local-file-name").val()),j.trigger("save"),o.dialogClose()}).append($('<div class="textae-editor__save-dialog__row">').append($('<label class="textae-editor__save-dialog__label"></label>'),$('<a class="viewsource" href="#">Click to see the json source in a new window.</a>'))).on("click","a.viewsource",function(){var a=m(p.params);return window.open(a,"_blank"),j.trigger("save"),o.dialogClose(),!1}),p=i(a,"textae.dialog.save","Save Annotations",o);return p.on("dialogopen",function(){var a=n();p.find(".textae-editor__save-dialog__local-file-name").val(a)}),p};return{showLoad:function(a,b){k(a).openAndSetParam(b)},showSave:function(a,b){l(a).openAndSetParam(b)}}}(),j=c.extendBindable({getAnnotationFromServer:h,showAccess:_.partial(i.showLoad,a.editorId),showSave:_.partial(i.showSave,a.editorId)});return j},h=function(){var a={BLOCK_THRESHOLD:100},h=d(this),i=e(h),j=function(a){var c={},d=function(a){return c[a]},e=function(){var c=function(a,b){var c={},d="something";return{setDefinedTypes:function(a){c=a},setDefaultType:function(a){d=a},getDefaultType:function(){return d||this.getSortedNames()[0]},getColor:function(a){return c[a]&&c[a].color||b},getUri:function(a){return c[a]&&c[a].uri||void 0},getSortedNames:function(){if(a){var b=a().concat(Object.keys(c)).reduce(function(a,b){return a[b]=a[b]?a[b]+1:1,a},{}),d=Object.keys(b);return d.sort(function(a,c){var d=b[c]-b[a];return 0!==d?d:a>c?1:a>c?-1:0}),d}return[]}}},d=function(a,b){void 0!==b&&(a.setDefinedTypes(b.map(function(a){return a}).reduce(function(a,b){return a[b.name]=b,a},{})),a.setDefaultType(b.filter(function(a){return a["default"]===!0}).map(function(a){return a.name}).shift()||""))},f=c(i.annotationData.entity.types,"#77DDDD"),h=c(i.annotationData.relation.types,"#555555");return{clipBoard:[],modeAccordingToButton:function(){var b=function(b){var c=!1,d=function(a){return void 0===a?c:(c=a,void f())},e=function(){c=!c,f()},f=function(){a.tool.push(b,c)};return{name:b,value:d,toggle:e,propagate:f}},c=["replicate-auto","relation-edit-mode"].map(b).reduce(function(a,b){return a[b.name]=b,a},{});return _.extend(c,{propagate:function(){_.each(this,function(a){a.propagate&&a.propagate()})}})}(),buttonStateHelper:function(){var b=function(){return i.selectionModel.entity.some()||i.selectionModel.relation.some()},c={},d=function(a,b){b?delete c[a]:c[a]=!1},e=function(){d("entity",i.selectionModel.span.some())},f=function(){d("paste",j.viewModel.clipBoard.length>0&&i.selectionModel.span.some())},g=function(){d("replicate",i.selectionModel.span.single())},h=function(){d("pallet",b())},k=function(){d("change-label",b())},l=function(){d("delete",i.selectionModel.some())},m=function(){d("copy",i.selectionModel.span.some()||i.selectionModel.entity.some())},n=function(){l(),m()},o=function(){a.tool.changeButtonState(a,c),j.viewModel.modeAccordingToButton.propagate()};return{propagate:o,init:function(){n(),e(),f(),g(),h(),k(),o()},enabled:function(a,b){d(a,b),o()},updateBySpan:function(){n(),e(),f(),g(),o()},updateByEntity:function(){n(),h(),k(),o()},updateByRelation:function(){l(),h(),k(),o()}}}(),viewMode:function(){var b=function(b){a.removeClass("textae-editor_term-mode").removeClass("textae-editor_instance-mode").removeClass("textae-editor_relation-mode").addClass("textae-editor_"+b+"-mode")},c=function(a){j.viewModel.modeAccordingToButton["relation-edit-mode"].value(a)},d=function(a){var b=l.selector.entity.get(a),c=b.parent(),d=c.prev();c.children().length===c.find(".ui-selected").length?k.addClass(d):k.removeClass(d),j.viewModel.buttonStateHelper.updateByEntity()};return{marginBottomOfGrid:0,isTerm:function(){return a.hasClass("textae-editor_term-mode")},setTerm:function(){b("term"),c(!1),j.viewModel.viewMode.marginBottomOfGrid=0,j.renderer.helper.redraw(),i.selectionModel.unbind("entity.select",d).unbind("entity.deselect",d).unbind("entity.change",d).bind("entity.select",d).bind("entity.deselect",d).bind("entity.change",e.buttonStateHelper.updateByEntity)},setInstance:function(){b("instance"),c(!1),j.viewModel.viewMode.marginBottomOfGrid=2,j.renderer.helper.redraw(),i.selectionModel.unbind("entity.select",d).unbind("entity.deselect",d).unbind("entity.change",e.buttonStateHelper.updateByEntity).bind("entity.select",d).bind("entity.deselect",d).bind("entity.change",e.buttonStateHelper.updateByEntity)},setRelation:function(){b("relation"),c(!0),j.viewModel.viewMode.marginBottomOfGrid=2,j.renderer.helper.redraw(),i.selectionModel.unbind("entity.select",d).unbind("entity.deselect",d).unbind("entity.change",e.buttonStateHelper.updateByEntity)},setEditable:function(b){b?a.addClass("textae-editor_editable"):a.removeClass("textae-editor_editable")}}}(),typeContainer:{entity:f,setDefinedEntityTypes:_.partial(d,f),relation:h,setDefinedRelationTypes:_.partial(d,h)},getConnectorStrokeStyle:function(a){var c=function(a){var c=a.slice(1);return r=parseInt(c.substr(0,2),16),g=parseInt(c.substr(2,2),16),b=parseInt(c.substr(4,2),16),"rgba("+r+", "+g+", "+b+", 1)"},d=i.annotationData.relation.get(a).pred,e=j.viewModel.typeContainer.relation.getColor(d);return{lineWidth:1,strokeStyle:c(e,1)}}}}(),f=function(){var b,f,g={},i=function(a,b,c){var d=a+c;return g[d]?g[d]:g[d]=b(c)},l={reset:function(){g={},f=a.find(".textae-editor__body__text-box").offset()},getSpan:_.partial(i,"S",function(a){var b=j.domUtil.selector.span.get(a);if(0===b.length)throw new Error("span is not renderd : "+a);var c=b.offset();return{top:c.top-f.top,left:c.left-f.left,width:b.outerWidth(),height:b.outerHeight(),center:b.get(0).offsetLeft+b.outerWidth()/2}}),getGrid:_.partial(i,"G",function(a){return j.domUtil.selector.grid.get(a).offset()}),getEntity:function(a){var c=b.annotationData.entity.get(a).span,d=j.domUtil.selector.entity.get(a);if(0===d.length)throw new Error("entity is not rendered : "+a);var e=l.getGrid(c),f=d.get(0);return{top:e.top+f.offsetTop,center:e.left+f.offsetLeft+d.outerWidth()/2}}},m=function(a,b,c){var d=a.find("."+c);return 0===d.length&&(d=$("<"+b+">").addClass(c),a.append(d)),d},n=_.partial(m,a,"div","textae-editor__body"),o=function(){return m(n(),"div","textae-editor__body__annotation-box")},p=function(a){var b=function(){return m(n(),"div","textae-editor__body__text-box")},c=function(a){return a.split("\n").map(function(a){return'<p class="textae-editor__body__text-box__paragraph-margin"><span class="textae-editor__body__text-box__paragraph">'+a+"</span></p>"}).join("\n")},d=function(a){var c={};return b().find(".textae-editor__body__text-box__paragraph").each(function(b,d){var e=$(d),f=$.extend({},a[b],{element:e});e.attr("id",f.id),c[f.id]=f}),c};b().html(c(a.sourceDoc)),j.renderer.paragraphs=d(a.paragraphs)},q=function(a){var b=function(a){a.span.topLevel().forEach(function(a){s.span.render(a)})},c=function(a){s.relation.reset(),a.relation.all().forEach(function(a){_.defer(_.partial(s.relation.render,a))})};o().empty(),l.reset(),r.reset(),b(a),c(a)},r=function(){var a={},c=function(b,c){var d=a[b.id];return d&&d.top===c.top&&d.left===c.left?void 0:c},e=function(a){_.compact(_.flatten(a.getEntities().map(b.annotationData.entity.assosicatedRelations)).map(d)).forEach(function(a){a.arrangePosition()})},f=function(a){return a?j.domUtil.selector.grid.get(a.id):void 0},g=function(b,c){return c?(f(b).css(c),a[b.id]=c,e(b),b):void 0},h=function(a){var b=function(a){var b=l.getSpan(a.id);return{top:b.top-j.viewModel.viewMode.marginBottomOfGrid-f(a).outerHeight(),left:b.left}},c=function(a){var b=function(a){var c=0===a.children.length?0:Math.max.apply(null,a.children.map(function(a){return b(a)}));return f(a).outerHeight()+c+j.viewModel.viewMode.marginBottomOfGrid},c=l.getSpan(a.id),d=b(a);return{top:c.top-j.viewModel.viewMode.marginBottomOfGrid-d,left:c.left}};return 0===a.children.length?b(a):c(a)},i=function(a){return a&&a.hasClass("hidden")?a:void 0},k=function(a){a&&a.removeClass("hidden")},m=function(a){var b=_.compose(_.partial(g,a),_.partial(c,a));_.compose(k,i,f,b,h)(a)},n=function(a){a.children.forEach(function(a){n(a)}),a.getTypes().length>0&&m(a)},o=function(){l.reset(),b.annotationData.span.topLevel().forEach(function(a){_.defer(_.partial(n,a))})},p=function(){a={}},q=function(b){delete a[b]};return{arrangePositionAll:_.debounce(o,10),reset:p,destroy:q}}(),s=function(){var e=function(a){return a.remove()},f=function(a){e(j.domUtil.selector.grid.get(a)),r.destroy(a)},g=function(){var a=function(a,b){var c=l.getSpan(b),d=$("<div>").attr("id","G"+b).addClass("textae-editor__grid").addClass("hidden").css({width:c.width});return a.append(d),d},b=function(b){g.render=_.partial(a,b)};return{init:b,render:null}}(),i=function(){var a=function(a){var b=function(a,b){var c=a.begin-b,d=a.end-b;return{start:c,end:d}},c=function(a,b,c){if(a.start<0||b.length<a.end)throw new Error("oh my god! I cannot render this span. "+c.toStringOnlyThis()+", textNode "+b.textContent)},d=function(a,b){var c=document.createRange();return c.setStart(a,b.start),c.setEnd(a,b.end),c},e=function(a,e,f){var g=b(a,e);return c(g,f,a),d(f,g)},f=function(){return 3===this.nodeType},g=function(a){return a.contents().filter(f).get(0)},h=function(a){return j.renderer.paragraphs[a].element},i=function(a,b,c){var d=_.compose(g,a),f=d(c.id);return e(b,c.begin,f)},k=_.partial(i,j.domUtil.selector.span.get),l=_.partial(i,h),m=a.getBigBrother();return m?e(a,m.end,document.getElementById(m.id).nextSibling):a.parent?k(a,a.parent):l(a,a.paragraph)},c=function(b,c){return a(b).surroundContents(c),b},d=function(a){var b=document.createElement("span");return b.setAttribute("id",a.id),b.setAttribute("title",a.id),b.setAttribute("class","textae-editor__span"),b},g=function(a){return c(a,d(a))},h=function(a){a.entities.forEach(_.compose(k.render,b.annotationData.entity.get))},i=function(a){return a.getTypes().forEach(h),a},l=function(a){return null!==document.getElementById(a.id)},m=function(a){return!a},n=function(a){for(var b=document.getElementById(a.id),c=b.parentNode;b.firstChild;)c.insertBefore(b.firstChild,b);e($(b)),c.normalize(),f(a.id)},o=function(a){var b=function(a){a.children.forEach(function(a){b(a)}),n(a)};return a.children.filter(l).forEach(b),a},p=function(a){return a.children.filter(_.compose(m,l)).forEach(q),a},q=_.compose(p,i,g,o),s=_.partial(_.compose,r.arrangePositionAll);return{render:s(q),remove:s(n)}}(),k=function(){var a=function(a,b){return $("#"+h.makeTypeId(a,b))},c=function(a){var b=a.outerWidth(),c=a.find(".textae-editor__entity").toArray().map(function(a){return a.offsetWidth}).reduce(function(a,b){return a+b},0);a.css({left:c>b?(b-c)/2:0})},d=function(a){return 0===b.annotationData.span.get(a).getTypes().length},i=function(d){var f=function(a){return 0===b.annotationData.span.get(d.span).getTypes().filter(function(b){return b.name===a}).length},g=e(j.domUtil.selector.entity.get(d.id)).attr("type");f(g)?a(d.span,g).remove():c(a(d.span,g).find(".textae-editor__entity-pane"))},k=function(a){i(a),l(a)},l=function(d){var e=function(b,c){var d=function(a){return String(a).indexOf("http")>-1},e=function(a){if(d(a)){var b=/\(?(?:(http|https|ftp):\/\/)?(?:((?:[^\W\s]|\.|-|[:]{1})+)@{1})?((?:www.)?(?:[^\W\s]|\.|-)+[\.][^\W\s]{2,4}|localhost(?=\/)|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::(\d*))?([\/]?[^\s\?]*[\/]{1})*(?:\/?([^\s\n\?\[\]\{\}\#]*(?:(?=\.)){1}|[^\s\n\?\[\]\{\}\.\#]*)?([\.]{1}[^\s\?\#]*)?)?(?:\?{1}([^\s\n\#\[\]]*))?([\#][^\s\n]*)?\)?/gi,c=b.exec(a);return c[6]?c[6]+(c[7]||""):c[5]?c[5].split("/").filter(function(a){return""!==a}).pop():c[3]}return a},f=function(a){return d(a)?a:j.viewModel.typeContainer.entity.getUri(a)?j.viewModel.typeContainer.entity.getUri(a):void 0},i=function(a,b){var c=h.makeTypeId(a,b),d=$("<div>").attr("id","P-"+c).addClass("textae-editor__entity-pane"),g=$("<div>").addClass("textae-editor__type-label").css({"background-color":j.viewModel.typeContainer.entity.getColor(b)}),i=f(b);return i?g.append($('<a target="_blank"/>').attr("href",i).text(e(b))):g.text(e(b)),$("<div>").attr("id",c).addClass("textae-editor__type").append(g).append(d)},k=function(a){var b=j.domUtil.selector.grid.get(a);return 0===b.length?g.render(a):b},l=a(b,c);return 0===l.length&&(l=i(b,c),k(b).append(l)),l},f=function(a){var c=$("<div>").attr("id",h.makeEntityDomId(a.id)).attr("title",a.id).attr("type",a.type).addClass("textae-editor__entity").css({"border-color":j.viewModel.typeContainer.entity.getColor(a.type)});return b.annotationData.modification.all().filter(function(b){return b.obj===a.id}).map(function(a){return"textae-editor__entity-"+a.pred.toLowerCase()}).forEach(function(a){c.addClass(a)}),c};d.type=String(d.type);var i=e(d.span,d.type).find(".textae-editor__entity-pane").append(f(d));c(i)},m=function(a){d(a.span)?f(a.span):i(a)};return{render:l,change:k,remove:m}}(),m=function(){var e,f=function(a){var b=jsPlumb.getInstance({ConnectionsDetachable:!1,Endpoint:["Dot",{radius:1}]});return b.setRenderMode(b.SVG),b.Defaults.Container=a,b},g=function(a){e=f(a)},h=function(a){var c=b.annotationData.relation.get(a).subj,d=b.annotationData.relation.get(a).obj,e=l.getEntity(c),f=l.getEntity(d),g=e.center,h=f.center,i=e.top,j=f.top,k=Math.abs(g-h),n=Math.abs(i-j),o=k*m.settings.xrate+n*m.settings.yrate+m.settings.c_offset;return o/=2.4},i={width:7,length:9,location:1,id:"normal-arrow"},k={width:14,length:18,location:1,id:"hover-arrow"},n={cssClass:"textae-editor__relation__label",id:"label"},o=function(a){var b=d(a);b.endpoints[0].repaint(),b.endpoints[1].repaint(),b.removeOverlay("normal-arrow"),b.setConnector(["Bezier",{curviness:h(a)}]),b.addOverlay(["Arrow",i])},p=function(a){var b=function(b){b.removeOverlay(i.id),b.addOverlay(["Arrow",k]),b.setPaintStyle(_.extend(a(),{lineWidth:3}))},c=function(b){b.removeOverlay(k.id),b.addOverlay(["Arrow",i]),b.setPaintStyle(_.extend(a(),{lineWidth:1}))},d=function(a){a.getOverlay(n.id).addClass("hover")},e=function(a){a.getOverlay(n.id).removeClass("hover")};return{pointup:function(){b(this),d(this)},pointdown:function(){this.hasClass("ui-selected")||(c(this),e(this))}}},q={hasClass:function(a){return this.connector.canvas.classList.contains(a)}},r=function(b){var d=_.partial(j.viewModel.getConnectorStrokeStyle,b.id),f=e.connect({source:j.domUtil.selector.entity.get(b.subj),target:j.domUtil.selector.entity.get(b.obj),anchors:["TopCenter","TopCenter"],connector:["Bezier",{curviness:h(b.id)}],paintStyle:d(),parameters:{id:b.id},cssClass:"textae-editor__relation",overlays:[["Arrow",i],["Label",_.extend(n,{label:"["+b.id+"] "+b.pred})]]});return f.arrangePosition=_.debounce(_.partial(o,b.id),20),_.extend(f,p(d),q),f.bind("mouseenter",function(a){a.pointup()}).bind("mouseexit",function(a){a.pointdown()}),c[b.id]=f,a.trigger("textae.editor.jsPlumbConnection.add",f),f},s=function(a){var b=d(a.id);if(!b)throw"no connector";var c=b.getOverlays().filter(function(a){return"Label"===a.type})[0];if(!c)throw"no label overlay";c.setLabel("["+a.id+"] "+a.pred),b.setPaintStyle(j.viewModel.getConnectorStrokeStyle(a.id))},t=function(a){e.detach(d(a.id)),delete c[a.id]};return{settings:{connOpacity:.6,xrate:.6,yrate:.05,c_offset:20},init:g,reset:function(){e.reset(),c={}},render:r,change:s,remove:t}}();return{init:function(a){g.init(a),m.init(a)},span:i,entity:k,relation:m}}(),t=function(a){return a.id},u=function(){var a=function(a){var b=j.domUtil.selector.span.get(a);k.addClass(b)},c=function(a){var b=j.domUtil.selector.span.get(a);k.removeClass(b)},f=function(a){var b=j.domUtil.selector.entity.get(a);k.addClass(b)},g=function(a){var b=j.domUtil.selector.entity.get(a);k.removeClass(b)},h=function(a){var b=function(a){a&&(a.addClass("ui-selected"),a.pointup())},c=_.compose(b,d);c(a)},i=function(a){var b=function(a){a&&(a.removeClass("ui-selected"),a.pointdown())},c=_.compose(b,d);c(a)};b.selectionModel.bind("span.select",a).bind("span.deselect",c).bind("span.change",e.buttonStateHelper.updateBySpan).bind("entity.select",f).bind("entity.deselect",g).bind("relation.select",h).bind("relation.deselect",i).bind("relation.change",e.buttonStateHelper.updateByRelation)};return{init:function(a){s.init(o()),b=a,b.annotationData.bind("change-text",p).bind("all.change",_.compose(b.selectionModel.clear,q)).bind("span.add",s.span.render).bind("span.remove",s.span.remove).bind("span.remove",_.compose(b.selectionModel.span.remove,t)).bind("entity.add",_.compose(r.arrangePositionAll,s.entity.render)).bind("entity.change",_.compose(r.arrangePositionAll,s.entity.change)).bind("entity.remove",_.compose(r.arrangePositionAll,s.entity.remove)).bind("entity.remove",_.compose(b.selectionModel.entity.remove,t)).bind("relation.add",s.relation.render).bind("relation.change",s.relation.change).bind("relation.remove",s.relation.remove).bind("relation.remove",_.compose(b.selectionModel.relation.remove,t)),u()},helper:function(){return{changeLineHeight:function(b){a.find(".textae-editor__body__text-box").css({"line-height":b+"px","margin-top":b/2+"px"})},getLineHeight:function(){return parseInt(a.find(".textae-editor__body__text-box").css("line-height"))/16},changeTypeGap:function(b){a.find(".textae-editor__type").css({height:18*b+18+"px","padding-top":18*b+"px"}),r.arrangePositionAll()},redraw:r.arrangePositionAll}}()}}(),k=function(){var a=function(a){return a.addClass("ui-selected")},b=function(a){return a.removeClass("ui-selected")};return{addClass:a,removeClass:b}}(),l={selector:{span:{get:function(b){return a.find("#"+b)}},entity:{get:function(a){return $("#"+h.makeEntityDomId(a))}},grid:{get:function(b){return a.find("#G"+b)}}},manipulate:{dismissBrowserSelection:function(){var a=window.getSelection();a.collapse(document.body,0)}},hover:function(){var a=function(a,b){i.annotationData.entity.assosicatedRelations(b).map(d).forEach(a)};return{on:_.partial(a,function(a){a.pointup()}),off:_.partial(a,function(a){a.pointdown()})}}()};return{init:function(){j.viewModel.buttonStateHelper.init(),j.renderer.init(i)},renderer:f,domUtil:l,viewModel:e}}(this),k=function(b){var d=function(a){a=a||window.event,a.cancelBubble=!0,a.bubbles=!1,a.stopPropagation&&a.stopPropagation()},e=function(a){var b,c=$(a).parent(),d=c.attr("id");if(c.hasClass("textae-editor__body__text-box__paragraph"))b=j.renderer.paragraphs[d].begin;else{if(!c.hasClass("textae-editor__span"))return void console.log(d);b=i.annotationData.span.get(d).begin}for(var e=a.parentElement.childNodes,f=0;e[f]!=a;f++)b+="#text"==e[f].nodeName?e[f].nodeValue.length:$("#"+e[f].id).text().length;return b},f=function(a){var b=e(a.focusNode);
return b+=a.focusOffset},g=function(a){var b=e(a.anchorNode);return b+a.anchorOffset},l=function(a){for(var b=a;k.spanConfig.isNonEdgeCharacter(i.annotationData.sourceDoc.charAt(b));)b++;for(;!k.spanConfig.isDelimiter(i.annotationData.sourceDoc.charAt(b))&&b>0&&!k.spanConfig.isDelimiter(i.annotationData.sourceDoc.charAt(b-1));)b--;return b},m=function(a){for(var b=a;k.spanConfig.isNonEdgeCharacter(i.annotationData.sourceDoc.charAt(b-1));)b--;for(;!k.spanConfig.isDelimiter(i.annotationData.sourceDoc.charAt(b))&&b<i.annotationData.sourceDoc.length;)b++;return b},n=function(a){for(var b=a;b<i.annotationData.sourceDoc.length&&(k.spanConfig.isNonEdgeCharacter(i.annotationData.sourceDoc.charAt(b))||!k.spanConfig.isDelimiter(i.annotationData.sourceDoc.charAt(b-1)));)b++;return b},o=function(a){for(var b=a;b>0&&(k.spanConfig.isNonEdgeCharacter(i.annotationData.sourceDoc.charAt(b-1))||!k.spanConfig.isDelimiter(i.annotationData.sourceDoc.charAt(b)));)b--;return b},p=function(b){if(b.anchorNode.parentElement.id!==b.focusNode.parentElement.id)return console.log(b.anchorNode.parentElement.id,b.focusNode.parentElement.id),!1;var c=g(b),d=f(b);if(c>d){var e=c;c=d,d=e}var n=i.annotationData.sourceDoc.substring(c,d);return k.spanConfig.nonEdgeCharacters.forEach(function(a){n=n.replace(a,"")}),0===n.length?(j.domUtil.manipulate.dismissBrowserSelection(),!0):(i.selectionModel.clear(),function(b,c){var d=h.makeSpanId(b,c);if(!i.annotationData.span.get(d)){var e=[I.factory.spanCreateCommand({begin:b,end:c})];j.viewModel.modeAccordingToButton["replicate-auto"].value()&&c-b<=a.BLOCK_THRESHOLD&&e.push(I.factory.spanReplicateCommand({begin:b,end:c})),I.invoke(e)}}(l(c),m(d)),!0)},q=function(a,b,c){return a!==h.makeSpanId(b,c)?[I.factory.spanMoveCommand(a,b,c)]:void 0},r=function(a,b){var c=[],d=f(b),e=b.getRangeAt(0),g=document.createRange();if(g.selectNode(b.anchorNode),e.compareBoundaryPoints(Range.START_TO_START,g)<0){var h=l(d);c=q(a,h,i.annotationData.span.get(a).end)}else{var j=m(d);c=q(a,i.annotationData.span.get(a).begin,j)}I.invoke(c)},s=function(a,b){var c=[],d=f(b),e=b.getRangeAt(0),g=document.createRange();g.selectNode(b.focusNode);var j,l=function(a){return[I.factory.spanRemoveCommand(a)]};if(e.compareBoundaryPoints(Range.START_TO_START,g)>0){var m=o(d);m>i.annotationData.span.get(a).begin?(j=h.makeSpanId(i.annotationData.span.get(a).begin,m),c=i.annotationData.span.get(j)?l(a):q(a,i.annotationData.span.get(a).begin,m)):(i.selectionModel.span.add(a),k.userEvent.editHandler.removeSelectedElements())}else{var p=n(d);p<i.annotationData.span.get(a).end?(j=h.makeSpanId(p,i.annotationData.span.get(a).end),c=i.annotationData.span.get(j)?l(a):q(a,p,i.annotationData.span.get(a).end)):(i.selectionModel.span.add(a),k.userEvent.editHandler.removeSelectedElements())}I.invoke(c)},t=function(a){var b=i.selectionModel.span.single();if(b){var c=i.annotationData.span.get(b);return c.begin<a&&a<c.end}return!1},u=function(a){if(a.anchorNode.parentNode.parentNode===a.focusNode.parentNode)return i.selectionModel.clear(),r(a.anchorNode.parentNode.id,a),j.domUtil.manipulate.dismissBrowserSelection(),!0;if(t(g(a))){var b=i.selectionModel.span.all()[0];return j.domUtil.selector.span.get(b).parent().attr("id")===a.focusNode.parentNode.id?(r(b,a),j.domUtil.manipulate.dismissBrowserSelection(),!0):(alert("A span cannot be expanded to make a boundary crossing."),j.domUtil.manipulate.dismissBrowserSelection(),!0)}return!1},v=function(a){if(a.anchorNode.parentNode===a.focusNode.parentNode.parentNode)return i.selectionModel.clear(),s(a.focusNode.parentNode.id,a),j.domUtil.manipulate.dismissBrowserSelection(),!0;if(t(f(a))){var b=i.selectionModel.span.all()[0];return a.focusNode.parentNode.id===b?(s(b,a),j.domUtil.manipulate.dismissBrowserSelection(),!0):(alert("A span cannot be shrinked to make a boundary crossing."),j.domUtil.manipulate.dismissBrowserSelection(),!0)}return!1},w=function(){alert("It is ambiguous for which span you want to adjust the boundary. Select the span, and try again."),j.domUtil.manipulate.dismissBrowserSelection()},x=function(a){return 3!==a.anchorNode.nodeType||3!==a.focusNode.nodeType?!0:p(a)?!1:u(a)?!1:(w(),!1)},y=function(a){return 3!==a.anchorNode.nodeType||3!==a.focusNode.nodeType?!0:p(a)?!1:u(a)?!1:v(a)?!1:(w(),!1)},z=function(){var a=window.getSelection();return a.isCollapsed?(k.userEvent.viewHandler.cancelSelect(),j.domUtil.manipulate.dismissBrowserSelection(),!0):x(a)},A=function(a){var b=window.getSelection();if(b.isCollapsed){var c=i.selectionModel.span.single();if(a.shiftKey&&c){var d=$(this).attr("id");i.selectionModel.clear(),i.annotationData.span.range(c,d).forEach(function(a){i.selectionModel.span.add(a)})}else a.ctrlKey||a.metaKey?i.selectionModel.span.toggle(a.target.id):(i.selectionModel.clear(),i.selectionModel.span.add(a.target.id));return!1}return y(b)},B=function(a,b,c){var d=function(a){a.each(function(){i.selectionModel.entity.add($(this).attr("title"))})},e=function(a){a.each(function(){i.selectionModel.entity.remove($(this).attr("title"))})};return a?b.hasClass("ui-selected")?e(c):d(c):(i.selectionModel.clear(),d(c)),!1},C=function(a){var b=$(a.target);return B(a.ctrlKey||a.metaKey,b,b.next().children())},D=function(a){var b=$(a.target);return B(a.ctrlKey||a.metaKey,b.prev(),b.children())},E=function(a,b){var c=a.getParameter("id");b.ctrlKey||b.metaKey?i.selectionModel.relation.toggle(c):(i.selectionModel.clear(),i.selectionModel.relation.add(c))},F=null,G=function(a,b){return F&&F(a,b),d(b),!1},H=function(){k.userEvent.viewHandler.hideDialogs(),b.tool.selectMe(),j.viewModel.buttonStateHelper.propagate()},I=c.extendBindable(function(){var a=function(){var a=-1,b=-1,c=[],d=function(){return b>-1},e=function(){return b<c.length-1},f=function(){return b!=a},g=function(){I.trigger("change",{hasAnythingToSave:f(),hasAnythingToUndo:d(),hasAnythingToRedo:e()})};return{reset:function(){a=-1,b=-1,c=[],g()},push:function(a){c.splice(b+1,c.length-b,a),b++,g()},next:function(){return b++,g(),c[b]},prev:function(){var a=c[b];return b--,g(),a},saved:function(){a=b,g()},hasAnythingToSave:f,hasAnythingToUndo:d,hasAnythingToRedo:e}}(),b=function(a){a.forEach(function(a){a.execute()})};return{reset:function(b){i.annotationData.reset(b),a.reset()},updateSavePoint:function(){a.saved()},hasAnythingToSave:a.hasAnythingToSave,invoke:function(c){c&&c.length>0&&(b(c),a.push(c))},undo:function(){var c=function(a){return a=Object.create(a),a.reverse(),a.map(function(a){return a.revert()})};a.hasAnythingToUndo()&&(i.selectionModel.clear(),b(c(a.prev())))},redo:function(){a.hasAnythingToRedo()&&(i.selectionModel.clear(),b(a.next()))},factory:function(){var a=function(a){console.log("[command.invoke]",a)};return{spanCreateCommand:function(b){return{execute:function(){var c=i.annotationData.span.add({begin:b.begin,end:b.end});i.selectionModel.span.add(c.id),this.revert=_.partial(I.factory.spanRemoveCommand,c.id),a("create a new span, spanId:"+c.id)}}},spanRemoveCommand:function(b){return{execute:function(){var c=i.annotationData.span.get(b);i.annotationData.span.remove(b),this.revert=_.partial(I.factory.spanCreateCommand,{begin:c.begin,end:c.end}),a("remove a span, spanId:"+b)}}},spanMoveCommand:function(b,c,d){return{execute:function(){var e=[],f=h.makeSpanId(c,d);i.annotationData.span.get(f)||(e.push(I.factory.spanRemoveCommand(b)),e.push(I.factory.spanCreateCommand({begin:c,end:d})),i.annotationData.span.get(b).getTypes().forEach(function(a){a.entities.forEach(function(b){e.push(I.factory.entityCreateCommand(f,a.name,b))})})),e.forEach(function(a){a.execute()});var g=h.parseSpanId(b);this.revert=_.partial(I.factory.spanMoveCommand,f,g.begin,g.end),a("move a span, spanId:"+b+", newBegin:"+c+", newEnd:"+d)}}},spanReplicateCommand:function(b){var c=function(c){var d=c.map(function(a){return a.revert()});return function(){return{execute:function(){d.forEach(function(a){a.execute()}),a("revert replicate a span, begin:"+b.begin+", end:"+b.end)}}}};return{execute:function(){var d=i.getReplicationSpans(b,k.spanConfig).map(I.factory.spanCreateCommand);d.forEach(function(a){a.execute()});d.map(function(a){return a.revert()});this.revert=c(d),a("replicate a span, begin:"+b.begin+", end:"+b.end)}}},entityCreateCommand:function(b,c,d){return{execute:function(){var e=i.annotationData.entity.add({id:d,span:b,type:c});i.selectionModel.entity.add(e.id),this.revert=_.partial(I.factory.entityRemoveCommand,e.id,b,c),a("create a new entity, spanId:"+b+", type:"+c+"  entityId:"+e.id)}}},entityRemoveCommand:function(b){return{execute:function(){var c=i.annotationData.entity.get(b);i.annotationData.entity.remove(b),this.revert=_.partial(I.factory.entityCreateCommand,c.span,c.type,b),a("remove a entity, spanId:"+c.span+", type:"+c.type+", entityId:"+b)}}},entityChangeTypeCommand:function(b,c){return{execute:function(){var d=i.annotationData.entity.get(b).type,e=i.annotationData.entity.changeType(b,c);this.revert=_.partial(I.factory.entityChangeTypeCommand,b,d),a("change type of a entity, spanId:"+e.span+", type:"+d+", entityId:"+b+", newType:"+c)}}},relationCreateCommand:function(b,c,d,e){return{execute:function(){var f=i.annotationData.relation.add({id:e,pred:d,subj:b,obj:c});_.delay(_.partial(i.selectionModel.relation.add,f.id),100),this.revert=_.partial(I.factory.relationRemoveCommand,f.id),a("create a new relation relationId:"+f.id+", subject:"+b+", object:"+c+", predicate:"+d)}}},relationRemoveCommand:function(b){return{execute:function(){var c=i.annotationData.relation.get(b),d=c.subj,e=c.obj,f=c.pred;i.annotationData.relation.remove(b),this.revert=_.partial(I.factory.relationCreateCommand,d,e,f,b),a("remove a relation relationId:"+b+", subject:"+d+", object:"+e+", predicate:"+f)}}},relationChangePredicateCommand:function(b,c){return{execute:function(){var d=i.annotationData.relation.get(b).pred;i.annotationData.relation.changePredicate(b,c),this.revert=_.partial(I.factory.relationChangePredicateCommand,b,d),a("change predicate of relation, relationId:"+b+", subject:"+i.annotationData.relation.get(b).subj+", object:"+i.annotationData.relation.get(b).obj+", predicate:"+d+", newPredicate:"+c)}}}}}()}}()),J=function(){var a;return{editHandler:function(){return{replicate:function(){var a=i.selectionModel.span.single();a?I.invoke([I.factory.spanReplicateCommand(i.annotationData.span.get(a))]):alert("You can replicate span annotation when there is only span selected.")},createEntity:function(){var a=i.selectionModel.span.all().map(function(a){return I.factory.entityCreateCommand(a,j.viewModel.typeContainer.entity.getDefaultType())});I.invoke(a)},setEntityType:function(){var b=$(this).attr("label");return a(b),!1},newLabel:function(){if(i.selectionModel.entity.some()||i.selectionModel.relation.some()){var b=prompt("Please enter a new label","");b&&a(b)}},removeSelectedElements:function(){var a=function(){var a=[],b=[],c=[];return{addSpanId:function(b){a.push(b)},addEntityId:function(a){b.push(a)},addRelations:function(a){c=c.concat(a)},getAll:function(){return _.uniq(c).map(I.factory.relationRemoveCommand).concat(_.uniq(b).map(function(a){return I.factory.entityRemoveCommand(a)}),_.uniq(a).map(I.factory.spanRemoveCommand))}}}(),b=function(b){a.addEntityId(b),a.addRelations(i.annotationData.entity.assosicatedRelations(b))};i.selectionModel.span.all().forEach(function(c){a.addSpanId(c),i.annotationData.span.get(c).getTypes().forEach(function(a){a.entities.forEach(function(a){b(a)})})}),i.selectionModel.entity.all().forEach(function(a){b(a)}),a.addRelations(i.selectionModel.relation.all()),I.invoke(a.getAll())},copyEntities:function(){j.viewModel.clipBoard=_.uniq(function(){return _.flatten(i.selectionModel.span.all().map(function(a){return i.annotationData.span.get(a).getEntities()}))}().concat(i.selectionModel.entity.all()))},pasteEntities:function(){var a=_.flatten(i.selectionModel.span.all().map(function(a){return j.viewModel.clipBoard.map(function(b){return I.factory.entityCreateCommand(a,i.annotationData.entity.get(b).type)})}));I.invoke(a)}}}(),viewHandler:function(){var d={},e=function(){var c=function(a,b,c){var d=a();if(d.length>0){var e=d.map(function(a){return b(a,c)});I.invoke(e)}},e=function(){return b.off("mouseup",".textae-editor__body").off("mouseup",".textae-editor__span").off("mouseup",".textae-editor__type-label").off("mouseup",".textae-editor__entity-pane").off("mouseup",".textae-editor__entity")};return{relationEdit:function(){var b=function(a){if(i.selectionModel.entity.some()){var b=i.selectionModel.entity.all()[0],c=$(a.target).attr("title");b===c?i.selectionModel.entity.remove(b):(i.selectionModel.entity.add(c),_.defer(function(){if(I.invoke([I.factory.relationCreateCommand(b,c,j.viewModel.typeContainer.relation.getDefaultType())]),a.ctrlKey||a.metaKey)i.selectionModel.entity.remove(c);else{if(a.shiftKey)return j.domUtil.manipulate.dismissBrowserSelection(),i.selectionModel.entity.remove(b),i.selectionModel.entity.add(c),!1;i.selectionModel.entity.remove(b),i.selectionModel.entity.remove(c)}}))}else i.selectionModel.clear(),i.selectionModel.entity.add($(a.target).attr("title"))};e().on("mouseup",".textae-editor__entity",b),d.typeContainer=j.viewModel.typeContainer.relation,a=_.partial(c,i.selectionModel.relation.all,I.factory.relationChangePredicateCommand),F=E},noRelationEdit:function(){var b=function(a){var b=$(a.target);return a.ctrlKey||a.metaKey?i.selectionModel.entity.toggle(b.attr("title")):(i.selectionModel.clear(),i.selectionModel.entity.add(b.attr("title"))),!1};e().on("mouseup",".textae-editor__body",z).on("mouseup",".textae-editor__span",A).on("mouseup",".textae-editor__type-label",C).on("mouseup",".textae-editor__entity-pane",D).on("mouseup",".textae-editor__entity",b),d.typeContainer=j.viewModel.typeContainer.entity,a=_.partial(c,i.selectionModel.entity.all,I.factory.entityChangeTypeCommand),F=null},noEdit:function(){e(),d.typeContainer=null,a=null,F=null}}}(),f=function(){var a=function(){k.userEvent.viewHandler.hideDialogs(),i.selectionModel.clear()},b={toTerm:function(){a(),e.noRelationEdit(),j.viewModel.viewMode.setTerm(),j.viewModel.viewMode.setEditable(!0),f=d.termCentric},toInstance:function(){a(),e.noRelationEdit(),j.viewModel.viewMode.setInstance(),j.viewModel.viewMode.setEditable(!0),f=d.instanceRelation},toRelation:function(){a(),e.relationEdit(),j.viewModel.viewMode.setRelation(),j.viewModel.viewMode.setEditable(!0),f=d.relationEdit},toViewTerm:function(){a(),e.noEdit(),j.viewModel.viewMode.setTerm(),j.viewModel.viewMode.setEditable(!1),f=d.viewTerm},toViewInstance:function(){a(),e.noEdit(),j.viewModel.viewMode.setInstance(),j.viewModel.viewMode.setEditable(!1),f=d.viewInstance}},c=function(){},d={termCentric:_.extend({},b,{name:"Term Centric",toTerm:c}),instanceRelation:_.extend({},b,{name:"Instance / Relation",toInstance:c}),relationEdit:_.extend({},b,{name:"Relation Edit",toRelation:c}),viewTerm:_.extend({},b,{name:"View Only",toTerm:c,toInstance:b.toViewInstance,toRelation:c,toViewTerm:c}),viewInstance:_.extend({},b,{name:"View Only",toTerm:b.toViewTerm,toInstance:c,toRelation:c,toViewInstance:c})};return{init:function(){b.toTerm()}}}(),g=function(){$(window).trigger("resize")},h=function(a){return _.debounce(a,300)},l=function(a){return 16*a},m=h(_.compose(g,j.renderer.helper.changeLineHeight,l)),n=h(j.renderer.helper.changeTypeGap);return{init:function(){f.init()},showPallet:function(){var a=function(a){return function(){k.userEvent.viewHandler.hidePallet(),a.call(this)}},b=function(b){var c=function(c){var d=$("<input>").addClass("textae-editor__entity-pallet__entity-type__radio").attr({type:"radio",name:"etype",label:c}).change(a(function(){return b.setDefaultType($(this).attr("label")),!1}));return c===b.getDefaultType()&&d.attr({title:"default type",checked:"checked"}),d},d=function(a){return a?$("<a>").attr({href:a,target:"_blank"}).append($("<span>").addClass("textae-editor__entity-pallet__link")):void 0},e=function(a){return a?$("<td>").append(a):$("<td>")},f=_.compose(e,c),g=function(a){return $("<td>").addClass("textae-editor__entity-pallet__entity-type__label").attr("label",a).text(a)},h=_.compose(e,d,b.getUri);return b.getSortedNames().map(function(a){var c=f(a),d=g(a),e=h(a);return $("<tr>").addClass("textae-editor__entity-pallet__entity-type").css({"background-color":b.getColor(a)}).append([c,d,e])})},c=function(b){return $("<div>").addClass("textae-editor__entity-pallet").append($("<table>")).css("position","fixed").on("click",".textae-editor__entity-pallet__entity-type__label",a(b)).hide()},e=function(a){var b=$(".textae-editor__entity-pallet");return 0!==b.length?b.find("table").empty().end().css("width","auto"):($("body").append(a),a)},f=function(a){return a.find("table").append(b(d.typeContainer)).end()},g=function(a){return a.outerHeight()+"px"===a.css("max-height")?a.css("overflow-y","scroll"):a.css("overflow-y","")},h=_.compose(g,f,e,c);return function(a){d.typeContainer&&d.typeContainer.getSortedNames().length>0&&h(k.userEvent.editHandler.setEntityType).css(a).show()}}(),hidePallet:function(){$(".textae-editor__entity-pallet").hide()},hideDialogs:function(){k.userEvent.viewHandler.hidePallet(),b.tool.cancel()},redraw:function(){j.renderer.helper.redraw()},cancelSelect:function(){return window.getSelection().isCollapsed?(i.selectionModel.clear(),void k.userEvent.viewHandler.hideDialogs()):(j.domUtil.manipulate.dismissBrowserSelection(),!0)},selectLeftSpan:function(){var a=i.selectionModel.span.single();if(a){var b=i.annotationData.span.get(a);i.selectionModel.clear(),b.left&&i.selectionModel.span.add(b.left.id)}},selectRightSpan:function(){var a=i.selectionModel.span.single();if(a){var b=i.annotationData.span.get(a);i.selectionModel.clear(),b.right&&i.selectionModel.span.add(b.right.id)}},showSettingDialog:function(){var a;return function(){var d=function(){return $("<div>").addClass("textae-editor__setting-dialog")},e=function(a){return a.append($("<div>").append('<label class="textae-editor__setting-dialog__label">Line Height').append($("<input>").attr({type:"number",step:1,min:3,max:10,value:j.renderer.helper.getLineHeight()}).addClass("textae-editor__setting-dialog__line-height"))).on("change",".textae-editor__setting-dialog__line-height",function(){m($(this).val())})},g=function(a){return a.append($("<div>").append('<label class="textae-editor__setting-dialog__label">Instance/Relation View').append($("<input>").attr({type:"checkbox"}).addClass("textae-editor__setting-dialog__term-centric-view"))).on("click",".textae-editor__setting-dialog__term-centric-view",function(){$(this).is(":checked")?f.toInstance():f.toTerm()})},h=function(b){return b.append($("<div>").append('<label class="textae-editor__setting-dialog__label">Type Gap').append($("<input>").attr({type:"number",step:1,min:0,max:5}).addClass("textae-editor__setting-dialog__type_gap"))).on("change",".textae-editor__setting-dialog__type_gap",function(){a=$(this).val(),n(a)})},i=function(a){return c.getDialog(b.editorId,"textae.dialog.setting","Chage Settings",a,!0)},k=function(a){return a.find(".textae-editor__setting-dialog__term-centric-view").prop({checked:j.viewModel.viewMode.isTerm()?null:"checked"}).end()},l=function(b){return b.find(".textae-editor__setting-dialog__type_gap").prop({value:a?a:j.viewModel.viewMode.isTerm()?0:1}).end()},o=function(a){return a.open()};_.compose(o,l,k,i,h,g,e,d)()}}(),toggleRelationEditMode:function(){j.viewModel.modeAccordingToButton["relation-edit-mode"].value()?f.toInstance():f.toRelation()},setViewMode:function(a){f["to"+a]&&f["to"+a]()}}}()}}(),K={delimiterCharacters:null,nonEdgeCharacters:null,defaults:{"delimiter characters":[" ",".","!","?",",",":",";","-","/","&","(",")","{","}","[","]","+","*","\\",'"',"'","\n",""],"non-edge characters":[" ","\n"]},set:function(a){var b=$.extend({},this.defaults,a);void 0!==b["delimiter characters"]&&(this.delimiterCharacters=b["delimiter characters"]),void 0!==b["non-edge characters"]&&(this.nonEdgeCharacters=b["non-edge characters"])},isNonEdgeCharacter:function(a){return this.nonEdgeCharacters.indexOf(a)>=0},isDelimiter:function(a){return this.delimiterCharacters.indexOf("ANY")>=0?1:this.delimiterCharacters.indexOf(a)>=0}};return{init:function(a){b.on("mousedown",function(a){return a.shiftKey?!1:void 0}).on("mousedown",".textae-editor__type",function(){return!1}).on("mousedown",".textae-editor__body__text-box__paragraph-margin",function(a){return"textae-editor__body__text-box__paragraph-margin"===a.target.className?!1:void 0}),b.on("mouseup",".textae-editor__body,.textae-editor__span,.textae-editor__grid,.textae-editor__entity",H).on("mouseenter",".textae-editor__entity",function(){j.domUtil.hover.on($(this).attr("title"))}).on("mouseleave",".textae-editor__entity",function(){j.domUtil.hover.off($(this).attr("title"))}),b.on("textae.editor.jsPlumbConnection.add",function(a,b){b.bind("click",G)}),I.bind("change",function(b){j.viewModel.buttonStateHelper.enabled("write",b.hasAnythingToSave),j.viewModel.buttonStateHelper.enabled("undo",b.hasAnythingToUndo),j.viewModel.buttonStateHelper.enabled("redo",b.hasAnythingToRedo),window.onbeforeunload=b.hasAnythingToSave?function(){return a}:null}),k.userEvent.viewHandler.init()},command:I,userEvent:J,spanConfig:K}}(this);return this.api=function(a){var b,d,e=function(a){var b=$.extend(c.getUrlParameters(location.search),{config:a.attr("config"),target:a.attr("target"),mode:a.attr("mode")}),d=a.text();return a.empty(),b.annotation={inlineAnnotation:d,url:b.target},b},g=function(){var a=23,b=_.max(i.annotationData.span.all().map(function(b){var c=a,d=function(a){c+=36*a.getTypes().length+j.viewModel.viewMode.marginBottomOfGrid,a.parent&&d(a.parent)};return d(b),c}));j.renderer.helper.changeLineHeight(b)},h=function(a){i.annotationData.relation.some()||i.annotationData.span.multiEntities().length>0?(k.userEvent.viewHandler.setViewMode(a+"Instance"),g()):k.userEvent.viewHandler.setViewMode(a+"Term")},l=_.partial(h,""),m=_.compose(function(){j.viewModel.buttonStateHelper.enabled("replicate-auto",!1),j.viewModel.buttonStateHelper.enabled("relation-edit-mode",!1)},_.partial(h,"View")),n=function(a,b){var d=function(a){var b=function(a){j.viewModel.typeContainer.setDefinedEntityTypes(a["entity types"]),j.viewModel.typeContainer.setDefinedRelationTypes(a["relation types"]),void 0!==a.css&&$("#css_area").html('<link rel="stylesheet" href="'+a.css+'"/>')};if(k.spanConfig.set(),""!==a.config){var d=c.ajaxAccessor.getSync(a.config);null!==d?(k.spanConfig.set(d),b(d)):alert("could not read the span configuration from the location you specified.")}},e=function(a){var b="edit"===a.mode?l:m;i.annotationData.bind("all.change",b)},f=function(a){var c=a.annotation;c&&(c.inlineAnnotation?(k.command.reset(JSON.parse(c.inlineAnnotation)),_.defer(k.userEvent.viewHandler.redraw)):c.url&&b.getAnnotationFromServer(c.url))};d(a),e(a),f(a)},o=function(c){var e=f(a,c);return e.bind("save",k.command.updateSavePoint),e.bind("load",k.command.reset),b=function(){e.showAccess(k.command.hasAnythingToSave())},d=function(){e.showSave(i.annotationData.toJson())},e},p=function(a,c){var e={A:b,C:k.userEvent.editHandler.copyEntities,D:k.userEvent.editHandler.removeSelectedElements,DEL:k.userEvent.editHandler.removeSelectedElements,E:k.userEvent.editHandler.createEntity,Q:k.userEvent.viewHandler.showPallet,R:k.userEvent.editHandler.replicate,S:d,V:k.userEvent.editHandler.pasteEntities,W:k.userEvent.editHandler.newLabel,X:k.command.redo,Y:k.command.redo,Z:k.command.undo,ESC:k.userEvent.viewHandler.cancelSelect,LEFT:k.userEvent.viewHandler.selectLeftSpan,RIGHT:k.userEvent.viewHandler.selectRightSpan};e[a]&&e[a](c)},q=function(a,c){var e={"textae.control.button.read.click":b,"textae.control.button.write.click":d,"textae.control.button.undo.click":k.command.undo,"textae.control.button.redo.click":k.command.redo,"textae.control.button.replicate.click":k.userEvent.editHandler.replicate,"textae.control.button.replicate_auto.click":j.viewModel.modeAccordingToButton["replicate-auto"].toggle,"textae.control.button.relation_edit_mode.click":k.userEvent.viewHandler.toggleRelationEditMode,"textae.control.button.entity.click":k.userEvent.editHandler.createEntity,"textae.control.button.change_label.click":k.userEvent.editHandler.newLabel,"textae.control.button.pallet.click":k.userEvent.viewHandler.showPallet,"textae.control.button.delete.click":k.userEvent.editHandler.removeSelectedElements,"textae.control.button.copy.click":k.userEvent.editHandler.copyEntities,"textae.control.button.paste.click":k.userEvent.editHandler.pasteEntities,"textae.control.button.setting.click":k.userEvent.viewHandler.showSettingDialog};e[a](c)},r=function(a){var b="There is a change that has not been saved. If you procceed now, you will lose it.",c=e(a);j.init(),k.init(b);var d=o(b);n(c,d)};return{start:r,handleKeyInput:p,handleButtonClick:q,redraw:k.userEvent.viewHandler.redraw}}(this),this},i=function(){var a={enable:function(a){a.removeClass("textae-control__icon--disabled")},disable:function(a){a.addClass("textae-control__icon--disabled")},isDisable:function(a){return a.hasClass("textae-control__icon--disabled")},push:function(a){a.addClass("textae-control__icon--pushed")},unpush:function(a){a.removeClass("textae-control__icon--pushed")},isPushed:function(a){return a.hasClass("textae-control__icon--pushed")}},b=function(a){var b=function(){return $("<span>").addClass("textae-control__title").append($("<a>").attr("href","http://bionlp.dbcls.jp/textae/").text("TextAE"))},c=function(){var a=function(a,b){var c=$("<span>").addClass("textae-control__icon").addClass("textae-control__"+a+"-button").attr("title",b);return f[a]={instance:c,eventName:"textae.control.button."+a.replace(/-/g,"_")+".click"},c},b=function(b){var c=[$("<span>").addClass("textae-control__separator")];return $.each(b,function(b,d){c.push(a(b,d))}),c};return $("<span>").append([{read:"Access [A]",write:"Save [S]"},{undo:"Undo [Z]",redo:"Redo [X]"},{replicate:"Replicate span annotation [R]","replicate-auto":"Auto replicate (Toggle)","relation-edit-mode":"Edit Relation"},{entity:"New entity [E]",pallet:"Select label [Q]","change-label":"Change label [W]"},{"delete":"Delete [D]",copy:"Copy [C]",paste:"Paste [V]"},{setting:"Setting"},{help:"Help [H]",about:"About"}].map(b).reduce(function(a,b){return a.concat(b)}))};a.append(b()).append(c())},c=function(b,d){if(1===arguments.length)$.each(arguments[0],function(a,b){c(a,b)});else if(2===arguments.length){var e=f[b],g="click",h=this.trigger.bind(this,"textae.control.button.click",e.eventName);e&&(d?(e.instance.off(g).on(g,h),a.enable(e.instance)):(e.instance.off(g),a.disable(e.instance)))}}.bind(this),d=function(a){c($.extend({},f,a))},e=function(b,c){var d=f[b].instance;c?a.push(d):a.unpush(d)},f={};return b(this),c({read:!0,"replicate-auto":!0,help:!0,about:!0}),this.updateAllButtonEnableState=d,this.updateButtonPushState=e,this},j=function(){{var a=function(){var a=c.makeInformationModal({className:"textae-control__help",addContentsFunc:function(){this.append($("<h3>").text("Help (Keyboard short-cuts)")).append($("<div>").addClass("textae-tool__key-help"))}}),b=c.makeInformationModal({className:"textae-control__about",addContentsFunc:function(){this.html("<h3>About TextAE (Text Annotation Editor)</h3><p>TextAEPubAnnotation</p><p>PubAnnotationPubMed</p><p>Entrez Gene ID</p><p></p><p>PubAnnotation</p><p></p>")}});return{control:null,editors:$.extend([],{getNewId:function(){return"editor"+this.length},select:function(a){this.selected=a,console.log(a.editorId)},selectFirst:function(){this.select(this[0])},selected:null}),infoModals:{help:a,about:b,hideAll:_.compose(a.hide,b.hide)}}}(),b=function(){var a={},b=function(b){a={top:b.clientY,left:b.clientX}},c=_.debounce(b,30);return $("html").on("mousemove",c),function(){return a}}(),d={handleKeyInput:function(c){"H"===c?a.infoModals.help.show():(a.editors.selected&&a.editors.selected.api.handleKeyInput(c,b()),"ESC"===c&&a.infoModals.hideAll())},handleButtonClick:function(c){switch(c){case"textae.control.button.help.click":a.infoModals.help.show();break;case"textae.control.button.about.click":a.infoModals.about.show();break;default:a.editors.selected&&a.editors.selected.api.handleButtonClick(c,b())}},handleEditor:{select:function(b){a.editors.select(b)},"public":{cancel:function(){a.infoModals.hideAll()},changeButtonState:function(b,c){a.control&&b===a.editors.selected&&a.control.updateAllButtonEnableState(c)},push:function(b,c){a.control&&a.control.updateButtonPushState(b,c)}}}};!function(){var b=function(){var a={27:"ESC",46:"DEL",37:"LEFT",39:"RIGHT"},b=function(b){return b>=65&&90>=b?String.fromCharCode(b):a[b]?a[b]:void 0},c=function(a){return a.keyCode},e=_.compose(d.handleKeyInput,b,c),f=e;$(document).on("keyup",function(a){f(a)}),$("body").on("dialogopen",".ui-dialog",function(){f=function(){}}).on("dialogclose",".ui-dialog",function(){f=e})},c=function(){$(window).on("resize",_.debounce(function(){a.editors.forEach(function(a){_.defer(a.api.redraw)})},20))};$(_.compose(c,b))}()}return{setControl:function(b){b.on("textae.control.button.click",function(){d.handleButtonClick.apply(null,_.rest(arguments))}),a.control=b},pushEditor:function(b){a.editors.push(b),$.extend(b,{editorId:a.editors.getNewId(),tool:$.extend({selectMe:_.partial(d.handleEditor.select,b)},d.handleEditor.public)})},selectFirstEditor:function(){a.editors.selectFirst()}}}();a.fn.textae=function(){return function(){if(this.hasClass("textae-editor"))this.each(function(){var a=$(this);return j.pushEditor(a),h.apply(a),a.api.start(a),a}),j.selectFirstEditor();else if(this.hasClass("textae-control")){var a=i.apply(this);return j.setControl(a),a}}}(),$(function(){$(".textae-control").textae(),$(".textae-editor").textae()})}(jQuery);