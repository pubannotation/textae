/*! textae 4.0.2 04-06-2014 */
!function(a){var c={ajaxAccessor:function(){var a=function(a){return!a||""===a};return{getSync:function(b){if(!a(b)){var c=null;return $.ajax({type:"GET",url:b,async:!1}).done(function(a){c=a}),c}},getAsync:function(b,c,d){a(b)||$.ajax({type:"GET",url:b,cache:!1}).done(function(a){void 0!==c&&c(a)}).fail(function(){alert("connection failed.")}).always(function(){void 0!==d&&d()})},post:function(b,c,d,e,f){a(b)||(console.log("POST data",c),$.ajax({type:"post",url:b,contentType:"application/json",data:c,crossDomain:!0,xhrFields:{withCredentials:!0}}).done(d).fail(e).always(f))}}}(),getUrlParameters:function(a){var b=a?String(a).replace(/^\?(.*)/,"$1"):"",c=b.length>0?b.split("&"):[];return c.map(function(a){var b=a.split("=");return{key:b[0],val:b[1]}}).reduce(function(a,b){return a[b.key]=b.val?b.val:!0,a},{})},makeInformationModal:function(){var a=function(){var a=function(){var a=$("."+this.className);return 0===a.length&&(a=$("<div>").addClass("textae__information-modal").addClass(this.className).hide(),this.addContentsFunc.call(a),$("body").append(a)),a},b=function(a){var b=$(window);a.css({position:"absolute",top:(b.height()-a.height())/2+b.scrollTop(),left:(b.width()-a.width())/2+b.scrollLeft()})};$(".textae__information-modal").hide();var c=a.call(this);b(c),c.show()},b=function(){$("."+this.className).hide()},c=function(c){return{show:a.bind(c),hide:b.bind(c)}};return $(function(){$("body").on("mouseup",".textae__information-modal",function(){$(this).hide()})}),c}(),getDialog:function(){var a={};return function(b,c,d,e,f){var g=function(a){var b=$("<div>").attr("id",a).attr("title",d).hide().append(e);return $.extend(b,{open:function(a){this.dialog({resizable:!1,width:550,height:220,modal:!0,buttons:f?{}:{Cancel:function(){$(this).dialog("close")}}}),a&&this.find('[type="text"]').val(a)},close:function(){this.dialog("close")}}),b},h=b+"."+c;if(a.hasOwnProperty(h))return a[h];var i=g(h);return $.extend(e,{dialogClose:function(){i.close()}}),$("body").append(i),a[h]=i,i}}(),flatten:function(a,b){return a.concat(b)}},d=function(a){var b=[];return{makeSpanId:function(b,c){return a.editorId+"__S"+b+"_"+c},parseSpanId:function(b){var c=b.replace(a.editorId+"__S","").split("_");return{begin:Number(c[0]),end:Number(c[1])}},makeTypeId:function(a,c){return-1===b.indexOf(c)&&b.push(c),a+"-"+b.indexOf(c)},makeEntityDomId:function(b){return a.editorId+"__E"+b},makeParagraphId:function(b){return a.editorId+"__P"+b}}},e=function(a){var b=function(){var a={};return{bind:function(b,c){if(!_.isFunction(c))throw new Error("Only a function is bindable!");return a[b]=c,this},trigger:function(b,c){return a[b]&&a[b](c),c}}},c=function(a){return _.extend({},a,b())},d=function(){var e,f=function(a,b){var c=b().filter(function(b){return b[0]===a}).map(function(a){return a.slice(1)});return a+(0===c.length?1:Math.max.apply(null,c)+1)},g=function(){var c={},e=[],f=function(e){var f={isChildOf:function(a){return a&&a.begin<=e.begin&&e.end<=a.end},toStringOnlyThis:function(){return"span "+this.begin+":"+this.end+":"+d.sourceDoc.substring(this.begin,this.end)},toString:function(a){a=a||1;var b=this.children&&this.children.length>0?"\n"+this.children.map(function(b){return new Array(a+1).join("	")+b.toString(a+1)}).join("\n"):"";return this.toStringOnlyThis()+b},getBigBrother:function(){var a;return this.parent?(a=this.parent.children.indexOf(this),0===a?null:this.parent.children[a-1]):(a=d.span.topLevel().indexOf(this),0===a||d.span.topLevel()[a-1].paragraph!==this.paragraph?null:d.span.topLevel()[a-1])},getTypes:function(){var b=this.id;return d.entity.all().filter(function(a){return b===a.span}).reduce(function(b,c){var d=a.makeTypeId(c.span,c.type),e=b.filter(function(a){return a.id===d});return e.length>0?e[0].entities.push(c.id):b.push({id:d,name:c.type,entities:[c.id]}),b},[])}},g=a.makeSpanId(e.begin,e.end);if(!d.span.get(g)){var h=$.extend({id:g,paragraph:k.findParagraph(e)},e,f,b());return c[g]=h,h}},g=function(){var a=d.span.all().sort(function(a,b){return a.begin-b.begin||b.end-a.end}),b=[];a.map(function(a,b,c){return $.extend(a,{children:[],left:0!==b?c[b-1]:null,right:b!==c.length-1?c[b+1]:null})}).forEach(function(a){var c=b[b.length-1];a.isChildOf(a.left)?(a.left.children.push(a),a.parent=a.left):a.left&&a.isChildOf(a.left.parent)?(a.left.parent.children.push(a),a.parent=a.left.parent):a.isChildOf(c)?(c.children.push(a),a.parent=c):b.push(a)}),b.toString=function(){return this.map(function(a){return a.toString()}).join("\n")},e=b},h={add:function(a){var b=f(a);return g(),d.trigger("span.add",b)},concat:function(a){a&&(a.forEach(f),g())},get:function(a){return c[a]},all:function(){return $.map(c,function(a){return a})},range:function(a,b){var d=c[a],e=c[b];return Object.keys(c).filter(function(a){var b=c[a];return d.begin<=b.begin&&b.end<=e.end})},topLevel:function(){return e},multiEntities:function(){return d.span.all().filter(function(a){var b=a.getTypes().filter(function(a){return a.entities.length>1});return b.length>0})},remove:function(a){var b=d.span.get(a);delete c[a],g(),d.trigger("span.remove",b)},clear:function(){c={},spanTree=[]}};return h}(),h=function(){var a={},b=function(){return Object.keys(a)},e=_.partial(f,"E",b),g=function(b){b.id=b.id||e();var d=c(b);return a[b.id]=d,d},h={add:function(a){return d.trigger("entity.add",g(a))},concat:function(a){a&&a.forEach(g)},get:function(b){return a[b]},all:function(){return _.map(a,_.identity)},types:function(){return d.entity.all().map(function(a){return a.type})},assosicatedRelations:function(a){return d.relation.all().filter(function(b){return b.obj===a||b.subj===a}).map(function(a){return a.id})},changeType:function(a,b){var c=d.entity.get(a);return c.type=b,d.trigger("entity.change",c),c},remove:function(b){var c=d.entity.get(b);return c&&(delete a[b],d.trigger("entity.remove",c)),c},clear:function(){a={}}};return h}(),i=function(){var a={},b=function(){return Object.keys(a)},e=_.partial(f,"R",b),g=function(b){b.id=b.id||e();var d=c(b);return a[b.id]=d,d},h={add:function(a){return d.trigger("relation.add",g(a))},concat:function(a){a&&a.forEach(g)},get:function(b){return a[b]},all:function(){return _.map(a,_.identity)},some:function(){return _.some(a)},types:function(){return Object.keys(a).map(function(b){return a[b].pred})},changePredicate:function(b,c){a[b].pred=c,d.trigger("relation.change",a[b])},remove:function(b){d.trigger("relation.remove",a[b]),delete a[b]},clear:function(){a={}}};return h}(),j=function(){var a=[];return{concat:function(b){b&&(a=a.concat(b))},all:function(){return a},clear:function(){a=[]}}}(),k=function(){var b;return{set:function(c){var d=0;b=c.split("\n").map(function(b,c){var e={id:a.makeParagraphId(c),begin:d,end:d+b.length};return d+=b.length+1,e})},get:function(){return b},findParagraph:function(a){var c=b.filter(function(b){return a.begin>=b.begin&&a.end<=b.end});return c.length>0?c[0]:null}}}(),l=c({span:g,entity:h,relation:i,modification:j,sourceDoc:"",reset:function(){var b=function(a){return e=a,a},c=function(a,b){var c=b.text;if(!c)throw"read failed.";return a.sourceDoc=c,k.set(c),l.trigger("change-text",{sourceDoc:c,paragraphs:k.get()}),b},f=function(b,c){var d=c.denotations;return b.span.clear(),b.entity.clear(),d&&(b.span.concat(d.map(function(a){return a.span})),b.entity.concat(d.map(function(b){return{id:b.id,span:a.makeSpanId(b.span.begin,b.span.end),type:b.obj}}))),c},g=function(a,b){var c=b.relations;return a.relation.clear(),a.relation.concat(c),b},h=function(a,b){var c=b.modifications;return a.modification.clear(),a.modification.concat(c),b};return function(a){var e=_.compose(_.partial(h,this),_.partial(g,this),_.partial(f,this),_.partial(c,this),b);try{e(a),l.trigger("all.change",d)}catch(i){throw alert(i),i}}}(),toJson:function(){var a=d.entity.all().map(function(a){var b=d.span.get(a.span);return{id:a.id,span:{begin:b.begin,end:b.end},obj:a.type}});return JSON.stringify($.extend(e,{denotations:a,relations:d.relation.all()}))}});return l}();return{annotationData:d,getReplicationSpans:function(a,b){var c=function(a){for(var b=String.prototype.indexOf.bind(d.sourceDoc,d.sourceDoc.substring(a.begin,a.end)),c=a.end-a.begin,e=[],f=0,g=b(f);-1!==g;g=b(f))e.push({begin:g,end:g+c}),f=g+c;return e},e=function(b){return b.begin===a.begin},f=function(a){var c=d.sourceDoc.charAt(a.begin-1),e=d.sourceDoc.charAt(a.end);return b.isDelimiter(c)&&b.isDelimiter(e)},g=function(a){return d.span.all().filter(function(b){return b.begin===a.begin&&b.end===a.end}).length>0},h=function(a){return d.span.all().filter(function(b){return b.begin<a.begin&&a.begin<b.end&&b.end<a.end||a.begin<b.begin&&b.begin<a.end&&a.end<b.end}).length>0};return c(a).filter(function(a){return!e(a)&&f(a)&&!g(a)&&!h(a)})}}},f=function(){var a={BLOCK_THRESHOLD:100},f=function(a){var b=function(){var b=function(){a.addClass("textae-editor_wait")},c=function(){a.removeClass("textae-editor_wait")};return{startWait:b,endWait:c}}(),d=function(){var d=function(){var b=$("<div>").append('<div><label class="textae-editor__load-dialog__label">Server</label><input type="text" class="textae-editor__load-dialog__file-name" /><input type="button" value="OK" /></div>').append('<div><label class="textae-editor__load-dialog__label">Local</label><input type="file" /></div>').on("change",'[type="file"]',function(){f.getAnnotationFromFile(this),b.dialogClose()}).on("click",'[type="button"]',function(){var a=b.find(".textae-editor__load-dialog__file-name").val();f.getAnnotationFromServer(a),b.dialogClose()});return c.getDialog(a.editorId,"textae.dialog.load","Load document with annotation.",b)},e=function(a,d){b.startWait(),c.ajaxAccessor.post(a,d,g,h,function(){b.endWait()}),k.command.updateSavePoint()},i=function(a,b){var c=function(a){var b=new Blob([a],{type:"application/json"});return URL.createObjectURL(b)},e=function(){var a=d().find("input[type='file']"),b=a.prop("files")[0];return b?b.name:"annotations.json"},f=function(a,b,c){a.find("a").text(c).attr("href",b).attr("download",c)},g=c(b),h=e();return f(a,g,h),a},j=function(b){var d=$("<div>").append('<div><label class="textae-editor__save-dialog__label">Server</label><input type="text" class="textae-editor__save-dialog__file-name" /><input type="button" value="OK" /></div>').append('<div><label class="textae-editor__save-dialog__label">Local</label><span class="span_link_place"><a target="_blank"/></span></div>').on("click","a",function(){k.command.updateSavePoint(),d.dialogClose()}).on("click",'[type="button"]',function(){var a=d.find(".textae-editor__save-dialog__file-name").val();e(a,b),d.dialogClose()}),f=c.getDialog(a.editorId,"textae.dialog.save","Save document with annotation.",d);return i(f,b)};return{showLoad:function(a){d().open(a)},showSave:function(a,b){j(b).open(a)}}}(),e=function(){if($messageArea=a.find(".textae-editor__footer .textae-editor__footer__message"),0===$messageArea.length){$messageArea=$("<div>").addClass("textae-editor__footer__message");var b=$("<div>").addClass("textae-editor__footer").append($messageArea);a.append(b)}return $messageArea},g=function(){e().html("annotation saved").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),j(l)}),k.command.updateSavePoint(),b.endWait()},h=function(){e().html("could not save").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),j(l)}),b.endWait()},j=function(a){if(""!==a){var b=a.replace(/\/annotations\.json$/,"");e().html("(Target: <a href='"+b+"'>"+b+"</a>)"),l=a}},l="";return{getAnnotationFromServer:function(a){b.startWait(),c.ajaxAccessor.getAsync(a,function(b){k.command.reset(b),j(a)},function(){b.endWait()})},getAnnotationFromFile:function(a){var b=new FileReader;b.onload=function(){var a=JSON.parse(this.result);k.command.reset(a)},b.readAsText(a.files[0])},showAccess:function(){d.showLoad(l)},showSave:function(){var a=i.annotationData.toJson();d.showSave(l,a)}}}(this),h=d(this),i=e(h),j=function(a){var d={},e=function(a){return d[a]},f=function(){var c=function(a,b){var c={},d="something";return{setDefinedTypes:function(a){c=a},setDefaultType:function(a){d=a},getDefaultType:function(){return d||this.getSortedNames()[0]},getColor:function(a){return c[a]&&c[a].color||b},getUri:function(a){return c[a]&&c[a].uri||void 0},getSortedNames:function(){if(a){var b=a().concat(Object.keys(c)).reduce(function(a,b){return a[b]=a[b]?a[b]+1:1,a},{}),d=Object.keys(b);return d.sort(function(a,c){var d=b[c]-b[a];return 0!==d?d:a>c?1:a>c?-1:0}),d}return[]}}},d=function(a,b){void 0!==b&&(a.setDefinedTypes(b.map(function(a){return a}).reduce(function(a,b){return a[b.name]=b,a},{})),a.setDefaultType(b.filter(function(a){return a["default"]===!0}).map(function(a){return a.name}).shift()||""))},e=c(i.annotationData.entity.types,"#77DDDD"),f=c(i.annotationData.relation.types,"#555555");return{clipBoard:[],modeAccordingToButton:function(){var b=[],c={propagate:function(){b.forEach(function(a){a()})}},d=_.partial(function(b,c,d){var e=!1,f=function(){a.tool.push(d,e)};b[d]={value:function(a){return void 0===a?e:(e=a,void f())},toggle:function(){e=!e,f()}},c.push(f)},c,b);return["replicate-auto","relation-edit-mode"].forEach(d),c}(),buttonStateHelper:function(){var b=function(){return j.domUtil.selector.entity.hasSelecteds()||j.domUtil.selector.relation.hasSelecteds()},c={},d=function(a,b){b?delete c[a]:c[a]=!1},e=function(){d("entity",j.domUtil.selector.span.hasSelecteds())},f=function(){d("paste",j.viewModel.clipBoard.length>0&&j.domUtil.selector.span.hasSelecteds())},g=function(){d("replicate",j.domUtil.selector.span.isSelectOne())},h=function(){d("pallet",b())},i=function(){d("change-label",b())},k=function(){d("delete",j.domUtil.selector.hasSelecteds())},l=function(){d("copy",j.domUtil.selector.span.hasSelecteds()||j.domUtil.selector.entity.hasSelecteds())},m=function(){k(),l()};return{propagate:function(){a.tool.changeButtonState(c),j.viewModel.modeAccordingToButton.propagate()},init:function(){m(),e(),f(),g(),h(),i(),this.propagate()},enabled:function(a,b){d(a,b),this.propagate()},updateBySpan:function(){m(),e(),f(),g(),this.propagate()},updateByEntity:function(){m(),h(),i(),this.propagate()},updateByRelation:function(){k(),h(),i(),this.propagate()}}}(),viewMode:function(){var b=function(b){a.removeClass("textae-editor_term-mode").removeClass("textae-editor_instance-mode").removeClass("textae-editor_relation-mode").addClass("textae-editor_"+b+"-mode")},c=function(a){j.viewModel.modeAccordingToButton["relation-edit-mode"].value(a)};return{marginBottomOfGrid:0,isTerm:function(){return a.hasClass("textae-editor_term-mode")},setTerm:function(){b("term"),c(!1),j.viewModel.viewMode.marginBottomOfGrid=0,j.renderer.helper.redraw()},setInstance:function(){b("instance"),c(!1),j.viewModel.viewMode.marginBottomOfGrid=2,j.renderer.helper.redraw()},setRelation:function(){b("relation"),c(!0),j.viewModel.viewMode.marginBottomOfGrid=2,j.renderer.helper.redraw()}}}(),typeContainer:{entity:e,setDefinedEntityTypes:_.partial(d,e),relation:f,setDefinedRelationTypes:_.partial(d,f)},getConnectorStrokeStyle:function(a){var c=function(a){var c=a.slice(1);return r=parseInt(c.substr(0,2),16),g=parseInt(c.substr(2,2),16),b=parseInt(c.substr(4,2),16),"rgba("+r+", "+g+", "+b+", 1)"},d=i.annotationData.relation.get(a).pred,e=j.viewModel.typeContainer.relation.getColor(d);return{lineWidth:1,strokeStyle:c(e,1)}}}}(),k=function(){var b,f,g=function(a){j.domUtil.manipulate.remove(j.domUtil.selector.grid.get(a)),r.grid.destroy(a)},i={},k=function(a,b,c){var d=a+c;return i[d]?i[d]:i[d]=b(c)},l={reset:function(){i={},f=a.find(".textae-editor__body__text-box").offset()},getSpan:_.partial(k,"S",function(a){var b=j.domUtil.selector.span.get(a);if(0===b.length)throw new Error("span is not renderd : "+a);var c=b.offset();return{top:c.top-f.top,left:c.left-f.left,width:b.outerWidth(),height:b.outerHeight(),center:b.get(0).offsetLeft+b.outerWidth()/2}}),getGrid:_.partial(k,"G",function(a){return j.domUtil.selector.grid.get(a).offset()}),getEntity:function(a){var c=b.annotationData.entity.get(a).span,d=j.domUtil.selector.entity.get(a);if(0===d.length)throw new Error("entity is not rendered : "+a);var e=l.getGrid(c),f=d.get(0);return{top:e.top+f.offsetTop,center:e.left+f.offsetLeft+d.outerWidth()/2}}},m=function(a,b,c){var d=a.find("."+c);return 0===d.length&&(d=$("<"+b+">").addClass(c),a.append(d)),d},n=m(a,"div","textae-editor__body"),o=function(){return m(n,"div","textae-editor__body__annotation-box")},p=function(a){var b=function(){return m(n,"div","textae-editor__body__text-box")},c=function(a){return a.split("\n").map(function(a){return'<p class="textae-editor__body__text-box__paragraph">'+a+"</p>"}).join("\n")},d=function(a){var c={};return b().find("p").each(function(b,d){var e=$(d),f=$.extend({},a[b],{element:e});e.attr("id",f.id),c[f.id]=f}),c};b().html(c(a.sourceDoc)),j.renderer.paragraphs=d(a.paragraphs)},q=function(a){var b=function(a){a.span.topLevel().forEach(function(a){r.span.render(a)}),r.grid.arrangePositionAll()},c=function(a){r.relation.reset(),a.relation.all().forEach(function(a){_.defer(_.partial(r.relation.render,a))})};o().empty(),l.reset(),r.grid.reset(),b(a),c(a)},r={span:function(){var a=function(a){var b=function(b,c){var d=a.begin-c,e=a.end-c;if(0>d||b.length<e)throw new Error("oh my god! I cannot render this span. "+a.toStringOnlyThis()+", textNode "+b.textContent);var f=document.createRange();return f.setStart(b,d),f.setEnd(b,e),f},c=function(){var c=function(a){var c=j.renderer.paragraphs[a.paragraph.id];return textNodeInParagraph=c.element.contents().filter(function(){return 3===this.nodeType}).get(0),b(textNodeInParagraph,c.begin)},d=a.getBigBrother();if(d)return b(document.getElementById(d.id).nextSibling,d.end);if(a.parent){var e=j.domUtil.selector.span.get(a.parent.id).contents().filter(function(){return 3===this.nodeType}).get(0);return b(e,a.parent.begin)}return c(a)},d=document.createElement("span");return d.setAttribute("id",a.id),d.setAttribute("title",a.id),d.setAttribute("class","textae-editor__span"),c(a.id).surroundContents(d),a},c=function(a){a.entities.forEach(_.compose(r.entity.render,b.annotationData.entity.get))},d=function(a){return a.getTypes().forEach(c),a},e=function(a){return null!==document.getElementById(a.id)},f=function(a){return!a},h=function(a){var b=function(a){a.children.forEach(function(a){b(a)}),r.span.destroy(a)};return a.children.filter(e).forEach(b),a},i=function(a){return a.children.filter(_.compose(f,e)).forEach(r.span.render),a};return{render:_.compose(i,d,a,h),remove:function(a){for(var b=document.getElementById(a.id),c=b.parentNode;b.firstChild;)c.insertBefore(b.firstChild,b);j.domUtil.manipulate.remove(b),c.normalize(),g(a.id)}}}(),entity:function(){var a=function(a,b){return $("#"+h.makeTypeId(a,b))},c=function(a){var b=a.outerWidth(),c=a.find(".textae-editor__entity").toArray().map(function(a){return a.offsetWidth}).reduce(function(a,b){return a+b},0);a.css({left:c>b?(b-c)/2:0})},d=function(a){return 0===b.annotationData.span.get(a).getTypes().length},e=function(d){var e=function(a){return 0===b.annotationData.span.get(d.span).getTypes().filter(function(b){return b.name===a}).length},f=j.domUtil.manipulate.remove(j.domUtil.selector.entity.get(d.id)).attr("type");e(f)?a(d.span,f).remove():c(a(d.span,f).find(".textae-editor__entity-pane"))},f=function(a){e(a),r.entity.render(a)},i=function(d){var e=function(b,c){var d=function(a,b){var c=h.makeTypeId(a,b),d=$("<div>").attr("id","P-"+c).addClass("textae-editor__entity-pane"),e=b;if(String(b).indexOf("http")>-1){var f=/\(?(?:(http|https|ftp):\/\/)?(?:((?:[^\W\s]|\.|-|[:]{1})+)@{1})?((?:www.)?(?:[^\W\s]|\.|-)+[\.][^\W\s]{2,4}|localhost(?=\/)|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::(\d*))?([\/]?[^\s\?]*[\/]{1})*(?:\/?([^\s\n\?\[\]\{\}\#]*(?:(?=\.)){1}|[^\s\n\?\[\]\{\}\.\#]*)?([\.]{1}[^\s\?\#]*)?)?(?:\?{1}([^\s\n\#\[\]]*))?([\#][^\s\n]*)?\)?/gi,g=f.exec(b);e=g[6]?g[6]+(g[7]||""):g[5]?g[5].split("/").filter(function(a){return""!==a}).pop():g[3]}var i=$("<div>").addClass("textae-editor__type-label").text(e).css({"background-color":j.viewModel.typeContainer.entity.getColor(b)});return $("<div>").attr("id",c).addClass("textae-editor__type").append(i).append(d)},e=function(a){var b=j.domUtil.selector.grid.get(a);return 0===b.length?r.grid.render(a):b},f=a(b,c);return 0===f.length&&(f=d(b,c),e(b).append(f)),f},f=function(a){var c=$("<div>").attr("id",h.makeEntityDomId(a.id)).attr("title",a.id).attr("type",a.type).addClass("textae-editor__entity").css({"border-color":j.viewModel.typeContainer.entity.getColor(a.type)});return b.annotationData.modification.all().filter(function(b){return b.obj===a.id}).map(function(a){return"textae-editor__entity-"+a.pred.toLowerCase()}).forEach(function(a){c.addClass(a)}),c};d.type=String(d.type);var g=e(d.span,d.type).find(".textae-editor__entity-pane").append(f(d));c(g)},k=function(a){d(a.span)?g(a.span):e(a)};return{render:i,change:f,remove:k}}(),grid:function(){var a={},d=function(a){var b=l.getSpan(a),c=$("<div>").attr("id","G"+a).addClass("textae-editor__grid").addClass("hidden").css({width:b.width});return o().append(c),c},f=function(b,c){var d=a[b.id];return d&&d.top===c.top&&d.left===c.left?void 0:c},g=function(a){_.compact(a.getTypes().map(function(a){return a.entities}).reduce(c.flatten,[]).map(b.annotationData.entity.assosicatedRelations).reduce(c.flatten,[]).map(e)).forEach(function(a){a.arrangePosition()})},h=function(a){return a?j.domUtil.selector.grid.get(a.id):void 0},i=function(b,c){return c?(h(b).css(c),a[b.id]=c,g(b),b):void 0},k=function(a){var b=function(a){var b=l.getSpan(a.id);return{top:b.top-j.viewModel.viewMode.marginBottomOfGrid-h(a).outerHeight(),left:b.left}},c=function(a){var b=function(a){var c=0===a.children.length?0:Math.max.apply(null,a.children.map(function(a){return b(a)}));return h(a).outerHeight()+c+j.viewModel.viewMode.marginBottomOfGrid},c=l.getSpan(a.id),d=b(a);return{top:c.top-j.viewModel.viewMode.marginBottomOfGrid-d,left:c.left}};return 0===a.children.length?b(a):c(a)},m=function(a){return a&&a.hasClass("hidden")?a:void 0},n=function(a){a&&a.removeClass("hidden")},p=function(a){var b=_.compose(_.partial(i,a),_.partial(f,a));_.compose(n,m,h,b,k)(a)};return{reset:function(){a={}},render:d,arrangePositionAll:function(){var a=function(b){b.children.forEach(function(b){a(b)}),b.getTypes().length>0&&p(b)};l.reset(),b.annotationData.span.topLevel().forEach(function(b){_.defer(_.partial(a,b))})},destroy:function(b){delete a[b]}}}(),relation:function(){var c=function(){var a=jsPlumb.getInstance({ConnectionsDetachable:!1,Endpoint:["Dot",{radius:1}]});return a.setRenderMode(a.SVG),a.Defaults.Container=o(),a}(),f=function(a){var c=b.annotationData.relation.get(a).subj,d=b.annotationData.relation.get(a).obj,e=l.getEntity(c),f=l.getEntity(d),g=e.center,h=f.center,i=e.top,j=f.top,k=Math.abs(g-h),m=Math.abs(i-j),n=k*r.relation.settings.xrate+m*r.relation.settings.yrate+r.relation.settings.c_offset;return n/=2.4},g={width:7,length:9,location:1,id:"normal-arrow"},h={width:14,length:18,location:1,id:"hover-arrow"},i={cssClass:"textae-editor__relation__label",id:"label"},k=function(a){var b=e(a);b.endpoints[0].repaint(),b.endpoints[1].repaint(),b.removeOverlay("normal-arrow"),b.setConnector(["Bezier",{curviness:f(a)}]),b.addOverlay(["Arrow",g])},m=function(a){var b=function(b){b.removeOverlay(g.id),b.addOverlay(["Arrow",h]),b.setPaintStyle(_.extend(a(),{lineWidth:3}))},c=function(b){b.removeOverlay(h.id),b.addOverlay(["Arrow",g]),b.setPaintStyle(_.extend(a(),{lineWidth:1}))},d=function(a){a.getOverlay(i.id).addClass("hover")},e=function(a){a.getOverlay(i.id).removeClass("hover")};return{pointup:function(){b(this),d(this)},pointdown:function(){this.hasClass("ui-selected")||(c(this),e(this))}}},n={hasClass:function(a){return this.connector.canvas.classList.contains(a)}},p=function(b){var e=_.partial(j.viewModel.getConnectorStrokeStyle,b.id),h=c.connect({source:j.domUtil.selector.entity.get(b.subj),target:j.domUtil.selector.entity.get(b.obj),anchors:["TopCenter","TopCenter"],connector:["Bezier",{curviness:f(b.id)}],paintStyle:e(),parameters:{id:b.id},cssClass:"textae-editor__relation",overlays:[["Arrow",g],["Label",_.extend(i,{label:"["+b.id+"] "+b.pred})]]});return h.arrangePosition=_.debounce(_.partial(k,b.id),20),_.extend(h,m(e),n),h.bind("mouseenter",function(a){a.pointup()}).bind("mouseexit",function(a){a.pointdown()}),d[b.id]=h,a.trigger("textae.editor.jsPlumbConnection.add",h),h},q=function(a){var b=e(a.id);if(!b)throw"no connector";var c=b.getOverlays().filter(function(a){return"Label"===a.type})[0];if(!c)throw"no label overlay";c.setLabel("["+a.id+"] "+a.pred),b.setPaintStyle(j.viewModel.getConnectorStrokeStyle(a.id))},s=function(a){c.detach(e(a.id)),delete d[a.id]};return{settings:{connOpacity:.6,xrate:.6,yrate:.05,c_offset:20},reset:function(){c.reset(),d={},j.domUtil.selector.relation.emptyRelationIdsSelected()},render:p,change:q,remove:s}}()};return{init:function(a){b=a,b.annotationData.bind("change-text",p),b.annotationData.bind("all.change",q),b.annotationData.bind("span.add",r.span.render),b.annotationData.bind("span.remove",r.span.remove),b.annotationData.bind("entity.add",_.compose(r.grid.arrangePositionAll,r.entity.render)),b.annotationData.bind("entity.change",_.compose(r.grid.arrangePositionAll,r.entity.change)),b.annotationData.bind("entity.remove",_.compose(r.grid.arrangePositionAll,r.entity.remove)),b.annotationData.bind("relation.add",r.relation.render),b.annotationData.bind("relation.change",r.relation.change),b.annotationData.bind("relation.remove",r.relation.remove)},helper:function(){return{changeLineHeight:function(b){a.find(".textae-editor__body__text-box").css({"line-height":100*b+"%"})},getLineHeight:function(){return parseInt(a.find(".textae-editor__body__text-box").css("line-height"))/16},changeTypeGap:function(b){a.find(".textae-editor__type").css({height:18*b+18+"px","padding-top":18*b+"px"}),r.grid.arrangePositionAll()},redraw:r.grid.arrangePositionAll}}()}}(),l={selector:{getSelecteds:function(){return a.find(".ui-selected")},hasSelecteds:function(){return j.domUtil.selector.getSelecteds().length>0},span:{get:function(b){return a.find("#"+b)},getSelecteds:function(){return a.find(".textae-editor__span.ui-selected").map(function(){return this.id}).get()},hasSelecteds:function(){return j.domUtil.selector.span.getSelecteds().length>0},isSelectOne:function(){return 1===j.domUtil.selector.span.getSelecteds().length},select:function(a){j.domUtil.manipulate.select(j.domUtil.selector.span.get(a))}},entity:{get:function(a){return $("#"+h.makeEntityDomId(a))},getSelecteds:function(){return a.find(".textae-editor__entity.ui-selected").map(function(){return this.title}).get()},hasSelecteds:function(){return j.domUtil.selector.entity.getSelecteds().length>0},select:function(a){j.domUtil.manipulate.select(j.domUtil.selector.entity.get(a))},deselect:function(a){j.domUtil.manipulate.deselect(j.domUtil.selector.entity.get(a))}},relation:function(){var a=[],b=function(b){return a.indexOf(b)>-1},c=function(a){a.addClass("ui-selected"),a.pointup()},d=function(a){a.removeClass("ui-selected"),a.pointdown()},f=_.compose(c,e),g=_.compose(d,e);return{getSelecteds:function(){return a},hasSelecteds:function(){return a.length>0},select:function(c){b(c)||(a.push(c),j.viewModel.buttonStateHelper.updateByRelation(),f(c))},deselect:function(b){var c=a.indexOf(b);c>-1&&(g(b),a.splice(c,1),j.viewModel.buttonStateHelper.updateByRelation())},clearRelationSelection:function(){a.forEach(g),j.domUtil.selector.relation.emptyRelationIdsSelected()},emptyRelationIdsSelected:function(){a=[],j.viewModel.buttonStateHelper.updateByRelation()},toggle:function(a){b(a)?j.domUtil.selector.relation.deselect(a):j.domUtil.selector.relation.select(a)}}}(),grid:{get:function(b){return a.find("#G"+b)}}},manipulate:function(){var a=function(a){return $(a).hasClass("ui-selected")},b=function(){a(this)||$(this).addClass("ui-selected").trigger("selectChanged",!0)},c=function(){a(this)&&$(this).removeClass("ui-selected").trigger("selectChanged",!1)},d=function(){a(this)?c.apply(this):b.apply(this)},e=function(){var a=$(this);c.call(a.add(a.find(".ui-selected"))),a.remove()},f=function(a,b){return $(b).each(a)};return{select:_.partial(f,b),deselect:_.partial(f,c),toggle:_.partial(f,d),remove:_.partial(f,e),selectOnly:function(a){j.domUtil.manipulate.deselect(j.domUtil.selector.getSelecteds().not(a)),j.domUtil.selector.relation.clearRelationSelection(),j.domUtil.manipulate.select(a)},unselect:function(){j.domUtil.manipulate.deselect(j.domUtil.selector.getSelecteds()),j.domUtil.selector.relation.clearRelationSelection()},dismissBrowserSelection:function(){var a=window.getSelection();a.collapse(document.body,0)}}}(),hover:function(){var a=function(a,b){i.annotationData.entity.assosicatedRelations(b).map(e).forEach(a)};return{on:_.partial(a,function(a){a.pointup()}),off:_.partial(a,function(a){a.pointdown()})}}()};return{init:function(){j.viewModel.buttonStateHelper.init(),j.renderer.init(i)},renderer:k,domUtil:l,viewModel:f}}(this),k=function(b){var d=function(a){a=a||window.event,a.cancelBubble=!0,a.bubbles=!1,a.stopPropagation&&a.stopPropagation()},e=function(a){var b,c=$(a).parent(),d=c.attr("id");if(c.hasClass("textae-editor__body__text-box__paragraph"))b=j.renderer.paragraphs[d].begin;else{if(!c.hasClass("textae-editor__span"))return void console.log(d);b=i.annotationData.span.get(d).begin}for(var e=a.parentElement.childNodes,f=0;e[f]!=a;f++)b+="#text"==e[f].nodeName?e[f].nodeValue.length:$("#"+e[f].id).text().length;return b},f=function(a){var b=e(a.focusNode);return b+=a.focusOffset},g=function(a){var b=e(a.anchorNode);return b+a.anchorOffset},l=function(a){for(var b=a;k.spanConfig.isNonEdgeCharacter(i.annotationData.sourceDoc.charAt(b));)b++;for(;!k.spanConfig.isDelimiter(i.annotationData.sourceDoc.charAt(b))&&b>0&&!k.spanConfig.isDelimiter(i.annotationData.sourceDoc.charAt(b-1));)b--;return b},m=function(a){for(var b=a;k.spanConfig.isNonEdgeCharacter(i.annotationData.sourceDoc.charAt(b-1));)b--;for(;!k.spanConfig.isDelimiter(i.annotationData.sourceDoc.charAt(b))&&b<i.annotationData.sourceDoc.length;)b++;return b},n=function(a){for(var b=a;b<i.annotationData.sourceDoc.length&&(k.spanConfig.isNonEdgeCharacter(i.annotationData.sourceDoc.charAt(b))||!k.spanConfig.isDelimiter(i.annotationData.sourceDoc.charAt(b-1)));)b++;return b},o=function(a){for(var b=a;b>0&&(k.spanConfig.isNonEdgeCharacter(i.annotationData.sourceDoc.charAt(b-1))||!k.spanConfig.isDelimiter(i.annotationData.sourceDoc.charAt(b)));)b--;return b},p=function(b){if(b.anchorNode.parentElement.id!==b.focusNode.parentElement.id)return console.log(b.anchorNode.parentElement.id,b.focusNode.parentElement.id),!1;var c=g(b),d=f(b);if(c>d){var e=c;c=d,d=e}var n=i.annotationData.sourceDoc.substring(c,d);return k.spanConfig.nonEdgeCharacters.forEach(function(a){n=n.replace(a,"")}),0===n.length?(j.domUtil.manipulate.dismissBrowserSelection(),!0):(j.domUtil.manipulate.unselect(),function(b,c){var d=h.makeSpanId(b,c);if(!i.annotationData.span.get(d)){var e=[k.command.factory.spanCreateCommand({begin:b,end:c})];j.viewModel.modeAccordingToButton["replicate-auto"].value()&&c-b<=a.BLOCK_THRESHOLD&&e.push(k.command.factory.spanReplicateCommand({begin:b,end:c})),k.command.invoke(e)}}(l(c),m(d)),!0)},q=function(a,b,c){return a!==h.makeSpanId(b,c)?[k.command.factory.spanMoveCommand(a,b,c)]:void 0},r=function(a,b){var c=[],d=f(b),e=b.getRangeAt(0),g=document.createRange();if(g.selectNode(b.anchorNode),e.compareBoundaryPoints(Range.START_TO_START,g)<0){var h=l(d);c=q(a,h,i.annotationData.span.get(a).end)}else{var j=m(d);c=q(a,i.annotationData.span.get(a).begin,j)}k.command.invoke(c)},s=function(a,b){var c=[],d=f(b),e=b.getRangeAt(0),g=document.createRange();g.selectNode(b.focusNode);var l,m=function(a){return[k.command.factory.spanRemoveCommand(a)]};if(e.compareBoundaryPoints(Range.START_TO_START,g)>0){var p=o(d);p>i.annotationData.span.get(a).begin?(l=h.makeSpanId(i.annotationData.span.get(a).begin,p),c=i.annotationData.span.get(l)?m(a):q(a,i.annotationData.span.get(a).begin,p)):(j.domUtil.selector.span.select(a),k.userEvent.editHandler.removeSelectedElements())
}else{var r=n(d);r<i.annotationData.span.get(a).end?(l=h.makeSpanId(r,i.annotationData.span.get(a).end),c=i.annotationData.span.get(l)?m(a):q(a,r,i.annotationData.span.get(a).end)):(j.domUtil.selector.span.select(a),k.userEvent.editHandler.removeSelectedElements())}k.command.invoke(c)},t=function(a){if(j.domUtil.selector.span.isSelectOne()){var b=j.domUtil.selector.span.getSelecteds()[0],c=i.annotationData.span.get(b);return c.begin<a&&a<c.end}return!1},u=function(a){if(a.anchorNode.parentNode.parentNode===a.focusNode.parentNode)return j.domUtil.manipulate.unselect(),r(a.anchorNode.parentNode.id,a),j.domUtil.manipulate.dismissBrowserSelection(),!0;if(t(g(a))){var b=j.domUtil.selector.span.getSelecteds()[0];return j.domUtil.selector.span.get(b).parent().attr("id")===a.focusNode.parentNode.id?(r(b,a),j.domUtil.manipulate.dismissBrowserSelection(),!0):(alert("A span cannot be expanded to make a boundary crossing."),j.domUtil.manipulate.dismissBrowserSelection(),!0)}return!1},v=function(a){if(a.anchorNode.parentNode===a.focusNode.parentNode.parentNode)return j.domUtil.manipulate.unselect(),s(a.focusNode.parentNode.id,a),j.domUtil.manipulate.dismissBrowserSelection(),!0;if(t(f(a))){var b=j.domUtil.selector.span.getSelecteds()[0];return a.focusNode.parentNode.id===b?(s(b,a),j.domUtil.manipulate.dismissBrowserSelection(),!0):(alert("A span cannot be shrinked to make a boundary crossing."),j.domUtil.manipulate.dismissBrowserSelection(),!0)}return!1},w=function(){alert("It is ambiguous for which span you want to adjust the boundary. Select the span, and try again."),j.domUtil.manipulate.dismissBrowserSelection()},x=function(a){return 3!==a.anchorNode.nodeType||3!==a.focusNode.nodeType?!0:p(a)?!1:u(a)?!1:(w(),!1)},y=function(a){return 3!==a.anchorNode.nodeType||3!==a.focusNode.nodeType?!0:p(a)?!1:u(a)?!1:v(a)?!1:(w(),!1)},z=function(){var a=window.getSelection();return a.isCollapsed?(k.userEvent.viewHandler.cancelSelect(),j.domUtil.manipulate.dismissBrowserSelection(),!0):x(a)},A=function(a){var b=window.getSelection();if(b.isCollapsed){if(a.shiftKey&&j.domUtil.selector.span.isSelectOne()){var c=j.domUtil.selector.span.getSelecteds()[0],d=$(this).attr("id");j.domUtil.manipulate.unselect(),i.annotationData.span.range(c,d).forEach(function(a){j.domUtil.selector.span.select(a)})}else a.ctrlKey||a.metaKey?j.domUtil.manipulate.toggle(a.target):j.domUtil.manipulate.selectOnly(a.target);return!1}return y(b)},B=function(a,b,c){var d=b.add(c);return a?b.hasClass("ui-selected")?j.domUtil.manipulate.deselect(d):j.domUtil.manipulate.select(d):j.domUtil.manipulate.selectOnly(d),!1},C=function(a){var b=$(a.target);return B(a.ctrlKey||a.metaKey,b,b.next().children())},D=function(a){var b=$(a.target);return B(a.ctrlKey||a.metaKey,b.prev(),b.children())},E=function(){j.viewModel.buttonStateHelper.updateBySpan()},F=function(a){var b=$(a.target).parent();b.children().length===b.find(".ui-selected").length?j.domUtil.manipulate.select(b.prev()):j.domUtil.manipulate.deselect(b.prev()),j.viewModel.buttonStateHelper.updateByEntity()},G=function(a,b){var c=a.getParameter("id");b.ctrlKey||b.metaKey?j.domUtil.selector.relation.toggle(c):(j.domUtil.manipulate.unselect(),j.domUtil.selector.relation.select(c))},H=null,I=function(a,b){return H&&H(a,b),d(b),!1},J=function(){k.userEvent.viewHandler.hideDialogs(),b.tool.selectMe(),j.viewModel.buttonStateHelper.propagate()},K=function(){var a=function(){var a,b=-1,c=-1,d=[],e=function(){a&&a()};return{init:function(b){void 0!==b&&(a=b.bind(this))},reset:function(){b=-1,c=-1,d=[],e()},push:function(a){d.splice(c+1,d.length-c,a),c++,e()},next:function(){return c++,e(),d[c]},prev:function(){var a=d[c];return c--,e(),a},saved:function(){b=c,e()},hasAnythingToUndo:function(){return c>-1},hasAnythingToRedo:function(){return c<d.length-1},hasAnythingToSave:function(){return c!=b}}}(),b=function(a){a.forEach(function(a){a.execute()})},c=function(){i.annotationData.relation.some()?(j.renderer.helper.changeLineHeight(10),k.userEvent.viewHandler.setViewMode("instance")):i.annotationData.span.multiEntities().length>0?(j.renderer.helper.changeLineHeight(4),k.userEvent.viewHandler.setViewMode("instance")):(j.renderer.helper.changeLineHeight(4),k.userEvent.viewHandler.setViewMode("term"))};return{init:function(b){a.init(b),a.reset()},reset:function(b){i.annotationData.reset(b),a.reset(),c()},updateSavePoint:function(){a.saved()},invoke:function(c){c&&c.length>0&&(b(c),a.push(c))},undo:function(){var c=function(a){return a=Object.create(a),a.reverse(),a.map(function(a){return a.revert()})};a.hasAnythingToUndo()&&(j.domUtil.manipulate.unselect(),b(c(a.prev())))},redo:function(){a.hasAnythingToRedo()&&(j.domUtil.manipulate.unselect(),b(a.next()))},factory:function(){var a=function(a){console.log("[controller.command.invoke]",a)};return{spanCreateCommand:function(b){return{execute:function(){var c=i.annotationData.span.add({begin:b.begin,end:b.end});j.domUtil.selector.span.select(c.id),this.revert=_.partial(k.command.factory.spanRemoveCommand,c.id),a("create a new span, spanId:"+c.id)}}},spanRemoveCommand:function(b){return{execute:function(){var c=i.annotationData.span.get(b);i.annotationData.span.remove(b),this.revert=_.partial(k.command.factory.spanCreateCommand,{begin:c.begin,end:c.end}),a("remove a span, spanId:"+b)}}},spanMoveCommand:function(b,c,d){return{execute:function(){var e=[],f=h.makeSpanId(c,d);i.annotationData.span.get(f)||(e.push(k.command.factory.spanRemoveCommand(b)),e.push(k.command.factory.spanCreateCommand({begin:c,end:d})),i.annotationData.span.get(b).getTypes().forEach(function(a){a.entities.forEach(function(b){e.push(k.command.factory.entityCreateCommand(f,a.name,b))})})),e.forEach(function(a){a.execute()});var g=h.parseSpanId(b);this.revert=_.partial(k.command.factory.spanMoveCommand,f,g.begin,g.end),a("move a span, spanId:"+b+", newBegin:"+c+", newEnd:"+d)}}},spanReplicateCommand:function(b){var c=function(c){var d=c.map(function(a){return a.revert()});return function(){return{execute:function(){d.forEach(function(a){a.execute()}),a("revert replicate a span, begin:"+b.begin+", end:"+b.end)}}}};return{execute:function(){var d=i.getReplicationSpans(b,k.spanConfig).map(k.command.factory.spanCreateCommand);d.forEach(function(a){a.execute()});d.map(function(a){return a.revert()});this.revert=c(d),a("replicate a span, begin:"+b.begin+", end:"+b.end)}}},entityCreateCommand:function(b,c,d){return{execute:function(){var e=i.annotationData.entity.add({id:d,span:b,type:c});j.domUtil.selector.entity.select(e.id),this.revert=_.partial(k.command.factory.entityRemoveCommand,e.id,b,c),a("create a new entity, spanId:"+b+", type:"+c+"  entityId:"+e.id)}}},entityRemoveCommand:function(b){return{execute:function(){var c=i.annotationData.entity.get(b);i.annotationData.entity.remove(b),this.revert=_.partial(k.command.factory.entityCreateCommand,c.span,c.type,b),a("remove a entity, spanId:"+c.span+", type:"+c.type+", entityId:"+b)}}},entityChangeTypeCommand:function(b,c){return{execute:function(){var d=i.annotationData.entity.get(b).type,e=i.annotationData.entity.changeType(b,c);this.revert=_.partial(k.command.factory.entityChangeTypeCommand,b,d),a("change type of a entity, spanId:"+e.span+", type:"+d+", entityId:"+b+", newType:"+c)}}},relationCreateCommand:function(b,c,d,e){return{execute:function(){var f=i.annotationData.relation.add({id:e,pred:d,subj:b,obj:c});_.delay(_.partial(j.domUtil.selector.relation.select,f.id),100),this.revert=_.partial(k.command.factory.relationRemoveCommand,f.id),a("create a new relation relationId:"+f.id+", subject:"+b+", object:"+c+", predicate:"+d)}}},relationRemoveCommand:function(b){return{execute:function(){var c=i.annotationData.relation.get(b),d=c.subj,e=c.obj,f=c.pred;i.annotationData.relation.remove(b),this.revert=_.partial(k.command.factory.relationCreateCommand,d,e,f,b),a("remove a relation relationId:"+b+", subject:"+d+", object:"+e+", predicate:"+f)}}},relationChangePredicateCommand:function(b,c){return{execute:function(){var d=i.annotationData.relation.get(b).pred;i.annotationData.relation.changePredicate(b,c),this.revert=_.partial(k.command.factory.relationChangePredicateCommand,b,d),a("change predicate of relation, relationId:"+b+", subject:"+i.annotationData.relation.get(b).subj+", object:"+i.annotationData.relation.get(b).obj+", predicate:"+d+", newPredicate:"+c)}}}}}()}}(),L=function(){var a;return{editHandler:function(){return{replicate:function(){j.domUtil.selector.span.isSelectOne()?k.command.invoke([k.command.factory.spanReplicateCommand(i.annotationData.span.get(j.domUtil.selector.span.getSelecteds()[0]))]):alert("You can replicate span annotation when there is only span selected.")},createEntity:function(){var a=j.domUtil.selector.span.getSelecteds().map(function(a){return k.command.factory.entityCreateCommand(a,j.viewModel.typeContainer.entity.getDefaultType())});k.command.invoke(a)},setEntityType:function(){var b=$(this).attr("label");return a(b),!1},newLabel:function(){if(j.domUtil.selector.entity.hasSelecteds()||j.domUtil.selector.relation.hasSelecteds()){var b=prompt("Please enter a new label","");b&&a(b)}},removeSelectedElements:function(){var a=function(){var a=function(a){return a.reduce(function(a,b){return-1===a.indexOf(b)&&a.push(b),a},[])},b=[],c=[],d=[];return{addSpanId:function(a){b.push(a)},addEntityId:function(a){c.push(a)},addRelations:function(a){d=d.concat(a)},getAll:function(){return a(d).map(k.command.factory.relationRemoveCommand).concat(a(c).map(function(a){return k.command.factory.entityRemoveCommand(a)}),a(b).map(k.command.factory.spanRemoveCommand))}}}(),b=function(b){a.addEntityId(b),a.addRelations(i.annotationData.entity.assosicatedRelations(b))};j.domUtil.selector.span.getSelecteds().forEach(function(c){a.addSpanId(c),i.annotationData.span.get(c).getTypes().forEach(function(a){a.entities.forEach(function(a){b(a)})})}),j.domUtil.selector.entity.getSelecteds().forEach(function(a){b(a)}),a.addRelations(j.domUtil.selector.relation.getSelecteds()),j.domUtil.selector.relation.emptyRelationIdsSelected(),k.command.invoke(a.getAll())},copyEntities:function(){j.viewModel.clipBoard=function(){return j.domUtil.selector.span.getSelecteds().map(function(a){return i.annotationData.span.get(a).getTypes().map(function(a){return a.entities}).reduce(c.flatten)}).reduce(c.flatten,[])}().concat(j.domUtil.selector.entity.getSelecteds()).reduce(function(a,b){return a.indexOf(b)<0&&a.push(b),a},[])},pasteEntities:function(){var a=j.domUtil.selector.span.getSelecteds().map(function(a){return j.viewModel.clipBoard.map(function(b){return k.command.factory.entityCreateCommand(a,i.annotationData.entity.get(b).type)})}).reduce(c.flatten,[]);k.command.invoke(a)}}}(),viewHandler:function(){var d={},e=function(){var c=function(a,b,c){var d=a();if(d.length>0){var e=d.map(function(a){return b(a,c)});k.command.invoke(e)}};return{relationEdit:function(){var e=function(a){if(0===j.domUtil.selector.entity.getSelecteds().length)j.domUtil.manipulate.selectOnly(a.target);else{var b=j.domUtil.selector.entity.getSelecteds()[0],c=$(a.target).attr("title");b===c?j.domUtil.selector.entity.deselect(b):(j.domUtil.selector.entity.select(c),_.defer(function(){if(k.command.invoke([k.command.factory.relationCreateCommand(b,c,j.viewModel.typeContainer.relation.getDefaultType())]),a.ctrlKey||a.metaKey)j.domUtil.selector.entity.deselect(c);else{if(a.shiftKey)return j.domUtil.manipulate.dismissBrowserSelection(),j.domUtil.selector.entity.deselect(b),j.domUtil.selector.entity.select(c),!1;j.domUtil.selector.entity.deselect(b),j.domUtil.selector.entity.deselect(c)}}))}};b.off("mouseup",".textae-editor__body").off("mouseup",".textae-editor__span").off("mouseup",".textae-editor__type-label").off("mouseup",".textae-editor__entity-pane").off("selectChanged",".textae-editor__entity").off("mouseup",".textae-editor__entity").on("mouseup",".textae-editor__entity",e),d.typeContainer=j.viewModel.typeContainer.relation,a=_.partial(c,j.domUtil.selector.relation.getSelecteds,k.command.factory.relationChangePredicateCommand),H=G},noRelationEdit:function(){var e=function(a){if(a.ctrlKey||a.metaKey)j.domUtil.manipulate.toggle(a.target);else{var b=$(a.target).parent();j.domUtil.manipulate.selectOnly(1===b.children().length?b.prev().add(b.children()):a.target)}return!1};b.on("mouseup",".textae-editor__body",z).on("mouseup",".textae-editor__span",A).on("mouseup",".textae-editor__type-label",C).on("mouseup",".textae-editor__entity-pane",D).on("selectChanged",".textae-editor__entity",F).off("mouseup",".textae-editor__entity").on("mouseup",".textae-editor__entity",e),d.typeContainer=j.viewModel.typeContainer.entity,a=_.partial(c,j.domUtil.selector.entity.getSelecteds,k.command.factory.entityChangeTypeCommand),H=null}}}(),f=function(){var a=function(){k.userEvent.viewHandler.hideDialogs(),j.domUtil.manipulate.unselect()},b={toTerm:function(){a(),e.noRelationEdit(),j.viewModel.viewMode.setTerm(),f=d.termCentric},toInstance:function(){a(),e.noRelationEdit(),j.viewModel.viewMode.setInstance(),f=d.instanceRelation},toRelation:function(){a(),e.relationEdit(),j.viewModel.viewMode.setRelation(),f=d.relationEdit}},c=function(){},d={termCentric:{name:"Term Centric",onInstance:b.toInstance,onRelation:b.toRelation,offInstance:c,offRelation:c},instanceRelation:{name:"Instance / Relation",onRelation:b.toRelation,offInstance:b.toTerm,onInstance:c,offRelation:c},relationEdit:{name:"Relation Edit",offRelation:b.toInstance,offInstance:b.toTerm,onInstance:b.toInstance,onRelation:c}};return{init:function(){b.toTerm()}}}(),g=function(){$(window).trigger("resize")},h=function(a){return _.debounce(a,300)},l=h(_.compose(g,j.renderer.helper.changeLineHeight)),m=h(j.renderer.helper.changeTypeGap);return{init:function(){f.init()},showPallet:function(){var a=function(a){return function(){k.userEvent.viewHandler.hidePallet(),a.call(this)}},b=function(b){var c=function(c){var d=$("<input>").addClass("textae-editor__entity-pallet__entity-type__radio").attr({type:"radio",name:"etype",label:c}).change(a(function(){return b.setDefaultType($(this).attr("label")),!1}));return c===b.getDefaultType()&&d.attr({title:"default type",checked:"checked"}),d},d=function(a){return a?$("<a>").attr({href:a,target:"_blank"}).append($("<span>").addClass("textae-editor__entity-pallet__link")):void 0},e=function(a){return a?$("<td>").append(a):$("<td>")},f=_.compose(e,c),g=function(a){return $("<td>").addClass("textae-editor__entity-pallet__entity-type__label").attr("label",a).text(a)},h=_.compose(e,d,b.getUri);return b.getSortedNames().map(function(a){var c=f(a),d=g(a),e=h(a);return $("<tr>").addClass("textae-editor__entity-pallet__entity-type").css({"background-color":b.getColor(a)}).append([c,d,e])})},c=function(b){return $("<div>").addClass("textae-editor__entity-pallet").append($("<table>")).css("position","fixed").on("click",".textae-editor__entity-pallet__entity-type__label",a(b)).hide()},e=function(a){var b=$(".textae-editor__entity-pallet");return 0!==b.length?b.find("table").empty().end().css("width","auto"):($("body").append(a),a)},f=function(a){return a.find("table").append(b(d.typeContainer)).end()},g=function(a){return a.outerHeight()+"px"===a.css("max-height")?a.css("overflow-y","scroll"):a.css("overflow-y","")},h=_.compose(g,f,e,c);return function(a){d.typeContainer.getSortedNames().length>0&&h(k.userEvent.editHandler.setEntityType).css(a).show()}}(),hidePallet:function(){$(".textae-editor__entity-pallet").hide()},hideDialogs:function(){k.userEvent.viewHandler.hidePallet(),b.tool.cancel()},redraw:function(){j.renderer.helper.redraw()},cancelSelect:function(){return window.getSelection().isCollapsed?(j.domUtil.manipulate.unselect(),void k.userEvent.viewHandler.hideDialogs()):(j.domUtil.manipulate.dismissBrowserSelection(),!0)},selectLeftSpan:function(){if(j.domUtil.selector.span.isSelectOne()){var a=i.annotationData.span.get(j.domUtil.selector.span.getSelecteds()[0]);j.domUtil.manipulate.unselect(),a.left&&j.domUtil.selector.span.select(a.left.id)}},selectRightSpan:function(){if(j.domUtil.selector.span.isSelectOne()){var a=i.annotationData.span.get(j.domUtil.selector.span.getSelecteds()[0]);j.domUtil.manipulate.unselect(),a.right&&j.domUtil.selector.span.select(a.right.id)}},showSettingDialog:function(){var a;return function(){var d=function(){return $("<div>").addClass("textae-editor__setting-dialog")},e=function(a){return a.append($("<div>").append('<label class="textae-editor__setting-dialog__label">Line Height').append($("<input>").attr({type:"number",step:1,min:3,max:10,value:j.renderer.helper.getLineHeight()}).addClass("textae-editor__setting-dialog__line-height"))).on("change",".textae-editor__setting-dialog__line-height",function(){l($(this).val())})},g=function(a){return a.append($("<div>").append('<label class="textae-editor__setting-dialog__label">Instance/Relation View').append($("<input>").attr({type:"checkbox"}).addClass("textae-editor__setting-dialog__term-centric-view"))).on("click",".textae-editor__setting-dialog__term-centric-view",function(){$(this).is(":checked")?f.onInstance():f.offInstance()})},h=function(b){return b.append($("<div>").append('<label class="textae-editor__setting-dialog__label">Type Gap').append($("<input>").attr({type:"number",step:1,min:0,max:5}).addClass("textae-editor__setting-dialog__type_gap"))).on("change",".textae-editor__setting-dialog__type_gap",function(){a=$(this).val(),m(a)})},i=function(a){return c.getDialog(b.editorId,"textae.dialog.setting","Chage Settings",a,!0)},k=function(a){return a.find(".textae-editor__setting-dialog__term-centric-view").prop({checked:j.viewModel.viewMode.isTerm()?null:"checked"}).end()},n=function(b){return b.find(".textae-editor__setting-dialog__type_gap").prop({value:a?a:j.viewModel.viewMode.isTerm()?0:1}).end()},o=function(a){return a.open()};_.compose(o,n,k,i,h,g,e,d)()}}(),toggleRelationEditMode:function(){j.viewModel.modeAccordingToButton["relation-edit-mode"].value()?f.offRelation():f.onRelation()},setViewMode:function(a){"term"===a?f.offInstance():"instance"===a?f.onInstance():"relation"===a&&f.onRelation()}}}()}}(),M={delimiterCharacters:null,nonEdgeCharacters:null,defaults:{"delimiter characters":[" ",".","!","?",",",":",";","-","/","&","(",")","{","}","[","]","+","*","\\",'"',"'","\n",""],"non-edge characters":[" ","\n"]},set:function(a){var b=$.extend({},this.defaults,a);void 0!==b["delimiter characters"]&&(this.delimiterCharacters=b["delimiter characters"]),void 0!==b["non-edge characters"]&&(this.nonEdgeCharacters=b["non-edge characters"])},isNonEdgeCharacter:function(a){return this.nonEdgeCharacters.indexOf(a)>=0},isDelimiter:function(a){return this.delimiterCharacters.indexOf("ANY")>=0?1:this.delimiterCharacters.indexOf(a)>=0}};return{init:function(){b.on("mousedown",function(a){return a.shiftKey?!1:void 0}),b.on("mouseup",".textae-editor__body,.textae-editor__span,.textae-editor__grid,.textae-editor__entity",J).on("selectChanged",".textae-editor__span",E).on("selectChanged",".textae-editor__entity",F).on("mouseenter",".textae-editor__entity",function(){j.domUtil.hover.on($(this).attr("title"))}).on("mouseleave",".textae-editor__entity",function(){j.domUtil.hover.off($(this).attr("title"))}),b.on("textae.editor.jsPlumbConnection.add",function(a,b){b.bind("click",I)}),k.command.init(function(){j.viewModel.buttonStateHelper.enabled("write",this.hasAnythingToSave()),j.viewModel.buttonStateHelper.enabled("undo",this.hasAnythingToUndo()),j.viewModel.buttonStateHelper.enabled("redo",this.hasAnythingToRedo()),window.onbeforeunload=this.hasAnythingToSave()?function(){return"There is a change that has not been saved. If you leave now, you will lose it."}:null}),k.userEvent.viewHandler.init()},command:K,userEvent:L,spanConfig:M}}(this),l=function(a){var b=function(a){j.viewModel.typeContainer.setDefinedEntityTypes(a["entity types"]),j.viewModel.typeContainer.setDefinedRelationTypes(a["relation types"]),void 0!==a.css&&$("#css_area").html('<link rel="stylesheet" href="'+a.css+'"/>')};k.spanConfig.set();var d=$.extend(c.getUrlParameters(location.search),{config:a.attr("config"),target:a.attr("target")});if(d.config&&""!==d.config){var e=c.ajaxAccessor.getSync(d.config);null!==e?(k.spanConfig.set(e),b(e)):alert("could not read the span configuration from the location you specified.")}d.target&&""!==d.target&&f.getAnnotationFromServer(d.target)};return this.api={start:function(a){j.init(),k.init(),l(a)},handleKeyInput:function(a,b){var c={A:f.showAccess,C:k.userEvent.editHandler.copyEntities,D:k.userEvent.editHandler.removeSelectedElements,DEL:k.userEvent.editHandler.removeSelectedElements,E:k.userEvent.editHandler.createEntity,Q:k.userEvent.viewHandler.showPallet,R:k.userEvent.editHandler.replicate,S:f.showSave,V:k.userEvent.editHandler.pasteEntities,W:k.userEvent.editHandler.newLabel,X:k.command.redo,Y:k.command.redo,Z:k.command.undo,ESC:k.userEvent.viewHandler.cancelSelect,LEFT:k.userEvent.viewHandler.selectLeftSpan,RIGHT:k.userEvent.viewHandler.selectRightSpan};c[a]&&c[a](b)},handleButtonClick:function(a,b){var c={"textae.control.button.read.click":f.showAccess,"textae.control.button.write.click":f.showSave,"textae.control.button.undo.click":k.command.undo,"textae.control.button.redo.click":k.command.redo,"textae.control.button.replicate.click":k.userEvent.editHandler.replicate,"textae.control.button.replicate_auto.click":j.viewModel.modeAccordingToButton["replicate-auto"].toggle,"textae.control.button.relation_edit_mode.click":k.userEvent.viewHandler.toggleRelationEditMode,"textae.control.button.entity.click":k.userEvent.editHandler.createEntity,"textae.control.button.change_label.click":k.userEvent.editHandler.newLabel,"textae.control.button.pallet.click":k.userEvent.viewHandler.showPallet,"textae.control.button.delete.click":k.userEvent.editHandler.removeSelectedElements,"textae.control.button.copy.click":k.userEvent.editHandler.copyEntities,"textae.control.button.paste.click":k.userEvent.editHandler.pasteEntities,"textae.control.button.setting.click":k.userEvent.viewHandler.showSettingDialog};c[a](b)},redraw:k.userEvent.viewHandler.redraw},this},h=function(){var a={enable:function(a){a.removeClass("textae-control__icon--disabled")},disable:function(a){a.addClass("textae-control__icon--disabled")},isDisable:function(a){return a.hasClass("textae-control__icon--disabled")},push:function(a){a.addClass("textae-control__icon--pushed")},unpush:function(a){a.removeClass("textae-control__icon--pushed")},isPushed:function(a){return a.hasClass("textae-control__icon--pushed")}},b=function(a){var b=function(){return $("<span>").addClass("textae-control__title").append($("<a>").attr("href","http://bionlp.dbcls.jp/textae/").text("TextAE"))},c=function(){var a=function(a,b){var c=$("<span>").addClass("textae-control__icon").addClass("textae-control__"+a+"-button").attr("title",b);return f[a]={instance:c,eventName:"textae.control.button."+a.replace(/-/g,"_")+".click"},c},b=function(b){var c=[$("<span>").addClass("textae-control__separator")];return $.each(b,function(b,d){c.push(a(b,d))}),c};return $("<span>").append([{read:"Access [A]",write:"Save [S]"},{undo:"Undo [Z]",redo:"Redo [X]"},{replicate:"Replicate span annotation [R]","replicate-auto":"Auto replicate (Toggle)","relation-edit-mode":"Edit Relation"},{entity:"New entity [E]",pallet:"Select label [Q]","change-label":"Change label [W]"},{"delete":"Delete [D]",copy:"Copy [C]",paste:"Paste [V]"},{setting:"Setting"},{help:"Help [H]",about:"About"}].map(b).reduce(function(a,b){return a.concat(b)}))};a.append(b()).append(c())},c=function(b,d){if(1===arguments.length)$.each(arguments[0],function(a,b){c(a,b)});else if(2===arguments.length){var e=f[b],g="click",h=this.trigger.bind(this,"textae.control.button.click",e.eventName);e&&(d?(e.instance.off(g).on(g,h),a.enable(e.instance)):(e.instance.off(g),a.disable(e.instance)))}}.bind(this),d=function(a){c($.extend({},f,a))},e=function(b,c){var d=f[b].instance;c?a.push(d):a.unpush(d)},f={};return b(this),c({read:!0,"replicate-auto":!0,help:!0,about:!0}),this.updateAllButtonEnableState=d,this.updateButtonPushState=e,this},i=function(){{var a=function(){var a=c.makeInformationModal({className:"textae-control__help",addContentsFunc:function(){this.append($("<h3>").text("Help (Keyboard short-cuts)")).append($("<div>").addClass("textae-tool__key-help"))}}),b=c.makeInformationModal({className:"textae-control__about",addContentsFunc:function(){this.html("<h3>About TextAE (Text Annotation Editor)</h3><p>TextAEPubAnnotation</p><p>PubAnnotationPubMed</p><p>Entrez Gene ID</p><p></p><p>PubAnnotation</p><p></p>")}});return{control:null,editors:$.extend([],{getNewId:function(){return"editor"+this.length},select:function(a){this.selected=a,console.log(a.editorId)},selectFirst:function(){this.select(this[0])},selected:null}),infoModals:{help:a,about:b,hideAll:_.compose(a.hide,b.hide)}}}(),b=function(){var a={},b=function(b){a={top:b.clientY,left:b.clientX}},c=_.debounce(b,30);return $("html").on("mousemove",c),function(){return a}}(),d={handleKeyInput:function(c){"H"===c?a.infoModals.help.show():(a.editors.selected&&a.editors.selected.api.handleKeyInput(c,b()),"ESC"===c&&a.infoModals.hideAll())},handleButtonClick:function(c){switch(c){case"textae.control.button.help.click":a.infoModals.help.show();break;case"textae.control.button.about.click":a.infoModals.about.show();break;default:a.editors.selected&&a.editors.selected.api.handleButtonClick(c,b())}},handleEditor:{select:function(b){a.editors.select(b)},"public":{cancel:function(){a.infoModals.hideAll()},changeButtonState:function(b){a.control&&a.control.updateAllButtonEnableState(b)},pushReplicateAuto:function(b){a.control&&a.control.updateReplicateAutoButtonPushState(b)},push:function(b,c){a.control&&a.control.updateButtonPushState(b,c)}}}};!function(){var b=function(){var a={27:"ESC",46:"DEL",37:"LEFT",39:"RIGHT"},b=function(b){return b>=65&&90>=b?String.fromCharCode(b):a[b]?a[b]:void 0},c=function(a){return a.keyCode},e=_.compose(d.handleKeyInput,b,c),f=e;$(document).on("keyup",function(a){f(a)}),$("body").on("dialogopen",".ui-dialog",function(){f=function(){}}).on("dialogclose",".ui-dialog",function(){f=e})},c=function(){$(window).on("resize",_.debounce(function(){a.editors.forEach(function(a){_.defer(a.api.redraw)})},20))};$(_.compose(c,b))}()}return{setControl:function(b){b.on("textae.control.button.click",function(){d.handleButtonClick.apply(null,_.rest(arguments))}),a.control=b},pushEditor:function(b){a.editors.push(b),$.extend(b,{editorId:a.editors.getNewId(),tool:$.extend({selectMe:_.partial(d.handleEditor.select,b)},d.handleEditor.public)})},selectFirstEditor:function(){a.editors.selectFirst()}}}();a.fn.textae=function(){return function(){if(this.hasClass("textae-editor"))this.each(function(){var a=$(this);return i.pushEditor(a),f.apply(a),a.api.start(a),a}),i.selectFirstEditor();else if(this.hasClass("textae-control")){var a=h.apply(this);return i.setControl(a),a}}}(),$(function(){$(".textae-control").textae(),$(".textae-editor").textae()})}(jQuery);