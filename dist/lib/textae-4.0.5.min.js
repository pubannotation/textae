/*! textae 4.0.5 01-07-2014 */
!function(a){var c=function(){var a=function(){var a={};return{bind:function(b,c){if(!_.isFunction(c))throw new Error("Only a function is bindable!");return a[b]=a[b]||[],a[b].push(c),this},unbind:function(b,c){return a[b]?(a[b]=_.reject(a[b],function(a){return a===c}),this):this},trigger:function(b,c){return a[b]&&a[b].forEach(function(a){a(c)}),c}}};return{ajaxAccessor:function(){var a=function(a){return!a||""===a};return{getSync:function(b){if(!a(b)){var c=null;return $.ajax({type:"GET",url:b,async:!1}).done(function(a){c=a}),c}},getAsync:function(b,c,d){a(b)||$.ajax({type:"GET",url:b,cache:!1}).done(function(a){void 0!==c&&c(a)}).fail(function(){alert("connection failed.")}).always(function(){void 0!==d&&d()})},post:function(b,c,d,e,f){a(b)||(console.log("POST data",c),$.ajax({type:"post",url:b,contentType:"application/json",data:c,crossDomain:!0,xhrFields:{withCredentials:!0}}).done(d).fail(e).always(f))}}}(),getUrlParameters:function(a){var b=a?String(a).replace(/^\?(.*)/,"$1"):"",c=b.length>0?b.split("&"):[];return c.map(function(a){var b=a.split("=");return{key:b[0],val:b[1]}}).reduce(function(a,b){return a[b.key]=b.val?b.val:!0,a},{})},makeInformationModal:function(){var a=function(){var a=function(){var a=$("."+this.className);return 0===a.length&&(a=$("<div>").addClass("textae__information-modal").addClass(this.className).hide(),this.addContentsFunc.call(a),$("body").append(a)),a},b=function(a){var b=$(window);a.css({position:"absolute",top:(b.height()-a.height())/2+b.scrollTop(),left:(b.width()-a.width())/2+b.scrollLeft()})};$(".textae__information-modal").hide();var c=a.call(this);b(c),c.show()},b=function(){$("."+this.className).hide()},c=function(c){return{show:a.bind(c),hide:b.bind(c)}};return $(function(){$("body").on("mouseup",".textae__information-modal",function(){$(this).hide()})}),c}(),getDialog:function(){var a={};return function(b,c,d,e,f){var g=function(a){var b=$("<div>").attr("id",a).attr("title",d).hide().append(e);return $.extend(b,{open:function(){this.dialog({resizable:!1,width:550,height:220,modal:!0,buttons:f?{}:{Cancel:function(){$(this).dialog("close")}}})},close:function(){this.dialog("close")}}),b},h=b+"."+c;if(a.hasOwnProperty(h))return a[h];var i=g(h);return $.extend(e,{dialogClose:function(){i.close()}}),$("body").append(i),a[h]=i,i}}(),extendBindable:function(b){return _.extend({},b,a())}}}(),d=function(a){var b=[];return{makeSpanId:function(b,c){return a.editorId+"__S"+b+"_"+c},parseSpanId:function(b){var c=b.replace(a.editorId+"__S","").split("_");return{begin:Number(c[0]),end:Number(c[1])}},makeTypeId:function(a,c){return-1===b.indexOf(c)&&b.push(c),a+"-"+b.indexOf(c)},makeEntityDomId:function(b){return a.editorId+"__E"+b},makeParagraphId:function(b){return a.editorId+"__P"+b}}},e=function(a){var b=function(a,b){return a.all().filter(function(a){return a.begin<b.begin&&b.begin<a.end&&a.end<b.end||b.begin<a.begin&&a.begin<b.end&&b.end<a.end}).length>0},d=function(){var e,f=function(a,b){var c=b().filter(function(b){return b[0]===a}).map(function(a){return a.slice(1)});return a+(0===c.length?1:Math.max.apply(null,c)+1)},g=function(){var b={},c=[],e=function(c){var e={isChildOf:function(d){if(!d)return!1;var e=a.makeSpanId(d.begin,d.end);if(!b[e])throw new Error("maybeParent is removed. "+d.toStringOnlyThis());return d.begin<=c.begin&&c.end<=d.end},toStringOnlyThis:function(){return"span "+this.begin+":"+this.end+":"+d.sourceDoc.substring(this.begin,this.end)},toString:function(a){a=a||1;var b=this.children&&this.children.length>0?"\n"+this.children.map(function(b){return new Array(a+1).join("	")+b.toString(a+1)}).join("\n"):"";return this.toStringOnlyThis()+b},getBigBrother:function(){var a;return this.parent?(a=this.parent.children.indexOf(this),0===a?null:this.parent.children[a-1]):(a=d.span.topLevel().indexOf(this),0===a||d.span.topLevel()[a-1].paragraph!==this.paragraph?null:d.span.topLevel()[a-1])},getTypes:function(){var b=this.id;return d.entity.all().filter(function(a){return b===a.span}).reduce(function(b,c){var d=a.makeTypeId(c.span,c.type),e=b.filter(function(a){return a.id===d});return e.length>0?e[0].entities.push(c.id):b.push({id:d,name:c.type,entities:[c.id]}),b},[])},getEntities:function(){return _.flatten(this.getTypes().map(function(a){return a.entities}))}};if(!d.isBoundaryCrossingWithOtherSpans(c)){var f=a.makeSpanId(c.begin,c.end);if(!d.span.get(f)){var g=$.extend({id:f,paragraph:k.findParagraph(c)},c,e);return b[f]=g,g}}},f=function(a,b){return a.begin-b.begin||b.end-a.end},g=function(){var a=d.span.all().sort(f),b=[];a.map(function(a,b,c){return $.extend(a,{children:[],left:0!==b?c[b-1]:null,right:b!==c.length-1?c[b+1]:null})}).forEach(function(a){var c=b[b.length-1];a.isChildOf(a.left)?(a.left.children.push(a),a.parent=a.left):a.left&&a.isChildOf(a.left.parent)?(a.left.parent.children.push(a),a.parent=a.left.parent):a.isChildOf(c)?(c.children.push(a),a.parent=c):(a.parent=null,b.push(a))}),b.toString=function(){return this.map(function(a){return a.toString()}).join("\n")},c=b},h={add:function(a){var b=e(a);return g(),d.trigger("span.add",b)},concat:function(a){a&&(a.forEach(e),g())},get:function(a){return b[a]},all:function(){return $.map(b,function(a){return a})},range:function(a,c){var d=b[a],e=b[c];if(f(d,e)>0){var g=d;d=e,e=g}return Object.keys(b).filter(function(a){var c=b[a];return d.begin<=c.begin&&c.end<=e.end})},topLevel:function(){return c},multiEntities:function(){return d.span.all().filter(function(a){var b=a.getTypes().filter(function(a){return a.entities.length>1});return b.length>0})},remove:function(a){var c=d.span.get(a);delete b[a],g(),d.trigger("span.remove",c)},clear:function(){b={},c=[]}};return h}(),h=function(){var a={},b=function(){return Object.keys(a)},c=_.partial(f,"E",b),e=function(b){return b.id=b.id||c(),a[b.id]=b,b},g={add:function(a){return d.trigger("entity.add",e(a))},concat:function(a){a&&a.forEach(e)},get:function(b){return a[b]},all:function(){return _.map(a,_.identity)},types:function(){return d.entity.all().map(function(a){return a.type})},assosicatedRelations:function(a){return d.relation.all().filter(function(b){return b.obj===a||b.subj===a}).map(function(a){return a.id})},changeType:function(a,b){var c=d.entity.get(a);return c.type=b,d.trigger("entity.change",c),c},remove:function(b){var c=d.entity.get(b);return c&&(delete a[b],d.trigger("entity.remove",c)),c},clear:function(){a={}}};return g}(),i=function(){var a={},b=function(){return Object.keys(a)},c=_.partial(f,"R",b),e=function(b){return b.id=b.id||c(),a[b.id]=b,b},g={add:function(a){return d.trigger("relation.add",e(a))},concat:function(a){a&&a.forEach(e)},get:function(b){return a[b]},all:function(){return _.map(a,_.identity)},some:function(){return _.some(a)},types:function(){return Object.keys(a).map(function(b){return a[b].pred})},changePredicate:function(b,c){a[b].pred=c,d.trigger("relation.change",a[b])},remove:function(b){d.trigger("relation.remove",a[b]),delete a[b]},clear:function(){a={}}};return g}(),j=function(){var a=[];return{concat:function(b){b&&(a=a.concat(b))},all:function(){return a},clear:function(){a=[]}}}(),k=function(){var b;return{set:function(c){var d=0;b=c.split("\n").map(function(b,c){var e={id:a.makeParagraphId(c),begin:d,end:d+b.length};return d+=b.length+1,e})},get:function(){return b},findParagraph:function(a){var c=b.filter(function(b){return a.begin>=b.begin&&a.end<=b.end});return c.length>0?c[0]:null}}}(),l=c.extendBindable({span:g,entity:h,relation:i,modification:j,sourceDoc:"",reset:function(){var b=function(a){return e=a,a},c=function(a,b){var c=b.text;if(!c)throw"read failed.";return a.sourceDoc=c,k.set(c),l.trigger("change-text",{sourceDoc:c,paragraphs:k.get()}),b},f=function(b,c){var d=c.denotations;return b.span.clear(),b.entity.clear(),d&&(b.span.concat(d.map(function(a){return a.span})),b.entity.concat(d.map(function(b){return{id:b.id,span:a.makeSpanId(b.span.begin,b.span.end),type:b.obj}}))),c},g=function(a,b){var c=b.relations;return a.relation.clear(),a.relation.concat(c),b},h=function(a,b){var c=b.modifications;return a.modification.clear(),a.modification.concat(c),b};return function(a){var e=_.compose(_.partial(h,this),_.partial(g,this),_.partial(f,this),_.partial(c,this),b);try{e(a),l.trigger("all.change",d)}catch(i){throw alert(i),i}}}(),toJson:function(){var a=d.entity.all().filter(function(a){return d.span.get(a.span)}).map(function(a){var b=d.span.get(a.span);return{id:a.id,span:{begin:b.begin,end:b.end},obj:a.type}});return JSON.stringify($.extend(e,{denotations:a,relations:d.relation.all()}))},isBoundaryCrossingWithOtherSpans:_.partial(b,g)});return l}(),e=function(){var a=function(a){var b={},c=function(){f.trigger(a+".change")},d={name:a,add:function(d){b[d]=d,f.trigger(a+".select",d),c()},all:function(){return _.toArray(b)},has:function(a){return _.contains(b,a)},some:function(){return _.some(b)},single:function(){var a=d.all();return 1===a.length?a[0]:null},toggle:function(a){d.has(a)?d.remove(a):d.add(a)},remove:function(d){delete b[d],f.trigger(a+".deselect",d),c()},clear:function(){_.each(d.all(),d.remove),b={},c()}};return d},b=function(a){_.each(a,function(a){a.clear()})},d=function(a){return a.map(function(a){return a.some()}).reduce(function(a,b){return a||b})},e=["span","entity","relation"].map(function(b){return a(b)}),f=c.extendBindable(_.extend(e.reduce(function(a,b){return a[b.name]=b,a},{}),{clear:_.partial(b,e),some:_.partial(d,e)}));return f}();return{annotationData:d,selectionModel:e,getReplicationSpans:function(a,b){var c=function(a){for(var b=String.prototype.indexOf.bind(d.sourceDoc,d.sourceDoc.substring(a.begin,a.end)),c=a.end-a.begin,e=[],f=0,g=b(f);-1!==g;g=b(f))e.push({begin:g,end:g+c}),f=g+c;return e},e=function(b){return b.begin===a.begin},f=function(a){var c=d.sourceDoc.charAt(a.begin-1),e=d.sourceDoc.charAt(a.end);return b.isDelimiter(c)&&b.isDelimiter(e)},g=function(a){return d.span.all().filter(function(b){return b.begin===a.begin&&b.end===a.end}).length>0};return c(a).filter(function(a){return!e(a)&&f(a)&&!g(a)&&!d.isBoundaryCrossingWithOtherSpans(a)})}}},f=function(a,b){var d="",e=function(a){var b=function(){this.addClass("textae-editor_wait")},c=function(){this.removeClass("textae-editor_wait")};return{startWait:b.bind(a),endWait:c.bind(a)}}(a),f=function(a){return function(){if($messageArea=a.find(".textae-editor__footer .textae-editor__footer__message"),0===$messageArea.length){$messageArea=$("<div>").addClass("textae-editor__footer__message");var b=$("<div>").addClass("textae-editor__footer").append($messageArea);a.append(b)}return $messageArea}}(a),g=function(a){""!==a&&(f().html('(Target: <a href="'+a+'">'+a+"</a>)"),d=a)},h=function(a){e.startWait(),c.ajaxAccessor.getAsync(a,function(b){j.trigger("load",b),g(a)},function(){e.endWait()})},i=function(){var a=function(a){return a.openAndSetParam||(a.openAndSetParam=_.compose(a.open.bind(a),function(b){this.find('[type="text"].url').val(d).trigger("keyup"),a.params=b})),a},i=_.compose(a,c.getDialog),k=function(a){var c=function(a){var b=new FileReader;b.onload=function(){var a=JSON.parse(this.result);j.trigger("load",a)},b.readAsText(a.files[0])},d=function(a){return $('<input type="button" value="Open" disabled="disabled" />').addClass(a)},e=function(){return!l.params||window.confirm(b)},f=d("server"),g=d("local"),k=$("<div>").append($('<div class="textae-editor__load-dialog__row">').append($('<label class="textae-editor__load-dialog__label">Server</label>'),$('<input type="text" class="textae-editor__load-dialog__file-name url" />'),f)).on("keyup",'[type="text"]',function(){this.value?f.removeAttr("disabled"):f.attr("disabled","disabled")}).on("click","input.server",function(){if(e()){var a=k.find(".textae-editor__load-dialog__file-name").val();h(a)}k.dialogClose()}).append($('<div class="textae-editor__load-dialog__row">').append($('<label class="textae-editor__load-dialog__label">Local</label>'),$('<input class="textae-editor__load-dialog__file" type="file" />'),g)).on("change",'[type="file"]',function(){this.files.length>0?g.removeAttr("disabled"):g.attr("disabled","disabled")}).on("click","input.local",function(){e()&&c(k.find('[type="file"]')[0]),k.dialogClose()}),l=i(a,"textae.dialog.load","Load Annotations",k);return l},l=function(a){var b=function(){f().html("annotation saved").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),g(d)}),j.trigger("save"),e.endWait()},h=function(){f().html("could not save").fadeIn().fadeOut(5e3,function(){$(this).html("").removeAttr("style"),g(d)}),e.endWait()},l=function(a,d){e.startWait(),c.ajaxAccessor.post(a,{annotations:d},b,h,function(){e.endWait()})},m=function(a){var b=new Blob([a],{type:"application/json"});return URL.createObjectURL(b)},n=function(){var b=k(a).find("input[type='file']"),c=b.prop("files")[0];return c?c.name:"annotations.json"},o=$("<div>").append($('<div class="textae-editor__save-dialog__row">').append($('<label class="textae-editor__save-dialog__label">Server</label>'),$('<input type="text" class="textae-editor__save-dialog__server-file-name url" />'),$('<input type="button" class="textae-editor__save-dialog__save-server-button" value="Save" />'))).on("click",".textae-editor__save-dialog__save-server-button",function(){var a=o.find(".textae-editor__save-dialog__server-file-name").val();l(a,p.params),o.dialogClose()}).append($('<div class="textae-editor__save-dialog__row">').append($('<label class="textae-editor__save-dialog__label">Local</label>'),$('<input type="text" class="textae-editor__save-dialog__local-file-name">'),$('<a class="download" href="#">Download</a>'))).on("click","a.download",function(){var a=m(p.params);$(this).attr("href",a).attr("download",o.find(".textae-editor__save-dialog__local-file-name").val()),j.trigger("save"),o.dialogClose()}).append($('<div class="textae-editor__save-dialog__row">').append($('<label class="textae-editor__save-dialog__label"></label>'),$('<a class="viewsource" href="#">Click to see the json source in a new window.</a>'))).on("click","a.viewsource",function(){var a=m(p.params);return window.open(a,"_blank"),j.trigger("save"),o.dialogClose(),!1}),p=i(a,"textae.dialog.save","Save Annotations",o);return p.on("dialogopen",function(){var a=n();p.find(".textae-editor__save-dialog__local-file-name").val(a)}),p};return{showLoad:function(a,b){k(a).openAndSetParam(b)},showSave:function(a,b){l(a).openAndSetParam(b)}}}(),j=c.extendBindable({getAnnotationFromServer:h,showAccess:_.partial(i.showLoad,a.editorId),showSave:_.partial(i.showSave,a.editorId)});return j},h=function(){var a={BLOCK_THRESHOLD:100},h=d(this),i=e(h),j=function(a){var c={},d=function(a){return c[a]},e=function(){var b=function(a,b){var c={},d="something";return{setDefinedTypes:function(a){c=a},setDefaultType:function(a){d=a},getDefaultType:function(){return d||this.getSortedNames()[0]},getColor:function(a){return c[a]&&c[a].color||b},getUri:function(a){return c[a]&&c[a].uri||void 0},getSortedNames:function(){if(a){var b=a().concat(Object.keys(c)).reduce(function(a,b){return a[b]=a[b]?a[b]+1:1,a},{}),d=Object.keys(b);return d.sort(function(a,c){var d=b[c]-b[a];return 0!==d?d:a>c?1:a>c?-1:0}),d}return[]}}},c=function(a,b){void 0!==b&&(a.setDefinedTypes(b.map(function(a){return a}).reduce(function(a,b){return a[b.name]=b,a},{})),a.setDefaultType(b.filter(function(a){return a["default"]===!0}).map(function(a){return a.name}).shift()||""))},d=b(i.annotationData.entity.types,"#77DDDD"),f=b(i.annotationData.relation.types,"#555555");return{clipBoard:[],modeAccordingToButton:function(){var b=function(b){var c=!1,d=function(a){return void 0===a?c:(c=a,void f())},e=function(){c=!c,f()},f=function(){a.tool.push(b,c)};return{name:b,value:d,toggle:e,propagate:f}},c=["replicate-auto","relation-edit-mode"].map(b).reduce(function(a,b){return a[b.name]=b,a},{});return _.extend(c,{propagate:function(){_.each(this,function(a){a.propagate&&a.propagate()})}})}(),buttonStateHelper:function(){var b=function(){return i.selectionModel.entity.some()||i.selectionModel.relation.some()},c={},d=function(a,b){b?delete c[a]:c[a]=!1},e=function(){d("entity",i.selectionModel.span.some())},f=function(){d("paste",j.viewModel.clipBoard.length>0&&i.selectionModel.span.some())},g=function(){d("replicate",i.selectionModel.span.single())},h=function(){d("pallet",b())},k=function(){d("change-label",b())},l=function(){d("delete",i.selectionModel.some())},m=function(){d("copy",i.selectionModel.span.some()||i.selectionModel.entity.some())},n=function(){l(),m()},o=function(){a.tool.changeButtonState(a,c),j.viewModel.modeAccordingToButton.propagate()};return{propagate:o,init:function(){n(),e(),f(),g(),h(),k(),o()},enabled:function(a,b){d(a,b),o()},updateBySpan:function(){n(),e(),f(),g(),o()},updateByEntity:function(){n(),h(),k(),o()},updateByRelation:function(){l(),h(),k(),o()}}}(),viewMode:function(){var b=function(b){a.removeClass("textae-editor_term-mode").removeClass("textae-editor_instance-mode").removeClass("textae-editor_relation-mode").addClass("textae-editor_"+b+"-mode")},c=function(a){j.viewModel.modeAccordingToButton["relation-edit-mode"].value(a)},d=function(a){var b=l.selector.entity.get(a),c=b.parent(),d=c.prev();c.children().length===c.find(".ui-selected").length?k.addClass(d):k.removeClass(d),j.viewModel.buttonStateHelper.updateByEntity()};return{marginBottomOfGrid:0,isTerm:function(){return a.hasClass("textae-editor_term-mode")},setTerm:function(){b("term"),c(!1),j.viewModel.viewMode.marginBottomOfGrid=0,i.selectionModel.unbind("entity.select",d).unbind("entity.deselect",d).unbind("entity.change",d).bind("entity.select",d).bind("entity.deselect",d).bind("entity.change",e.buttonStateHelper.updateByEntity)},setInstance:function(){b("instance"),c(!1),j.viewModel.viewMode.marginBottomOfGrid=2,i.selectionModel.unbind("entity.select",d).unbind("entity.deselect",d).unbind("entity.change",e.buttonStateHelper.updateByEntity).bind("entity.select",d).bind("entity.deselect",d).bind("entity.change",e.buttonStateHelper.updateByEntity)},setRelation:function(){b("relation"),c(!0),j.viewModel.viewMode.marginBottomOfGrid=2,i.selectionModel.unbind("entity.select",d).unbind("entity.deselect",d).unbind("entity.change",e.buttonStateHelper.updateByEntity)},setEditable:function(b){b?a.addClass("textae-editor_editable"):a.removeClass("textae-editor_editable")}}}(),typeContainer:{entity:d,setDefinedEntityTypes:_.partial(c,d),relation:f,setDefinedRelationTypes:_.partial(c,f)}}}(),f=function(){var f,i=function(){var a={},b=function(b,c){return a[b]=c,c},c=function(b){return a[b]},d=function(b){delete a[b]},e=function(){a={}};return{set:b,get:c,remove:d,clear:e}},l=_.extend(new i,{isGridPrepared:function(a){var b=f.annotationData.entity.get(a).span;return l.get(b)}}),m=function(){var b=new i,c=function(a,c,d){var e=a+d;return b.get(e)?b.get(e):b.set(e,c(d))},d=_.partial(c,"TEXT_NODE",function(){return a.find(".textae-editor__body__text-box").offset()}),e=function(a){var b=j.domUtil.selector.span.get(a);if(0===b.length)throw new Error("span is not renderd : "+a);var c=b.offset();return{top:c.top-d().top,left:c.left-d().left,width:b.outerWidth(),height:b.outerHeight(),center:b.get(0).offsetLeft+b.outerWidth()/2}},g=function(a){var b=f.annotationData.entity.get(a).span,c=j.domUtil.selector.entity.get(a);if(0===c.length)throw new Error("entity is not rendered : "+a);var d=l.get(b),e=c.get(0);return{top:d.top+e.offsetTop,center:d.left+e.offsetLeft+c.outerWidth()/2}};return{reset:b.clear,getSpan:_.partial(c,"S",e),getEntity:_.partial(c,"E",g)}}(),n=function(a,b,c){var d=a.find("."+c);return 0===d.length&&(d=$("<"+b+">").addClass(c),a.append(d)),d},o=_.partial(n,a,"div","textae-editor__body"),p=function(){return n(o(),"div","textae-editor__body__annotation-box")},q=function(a){var b=function(){return n(o(),"div","textae-editor__body__text-box")},c=function(a){return a.split("\n").map(function(a){return'<p class="textae-editor__body__text-box__paragraph-margin"><span class="textae-editor__body__text-box__paragraph">'+a+"</span></p>"}).join("\n")},d=function(a){var c={};return b().find(".textae-editor__body__text-box__paragraph").each(function(b,d){var e=$(d),f=$.extend({},a[b],{element:e});e.attr("id",f.id),c[f.id]=f}),c};b().html(c(a.sourceDoc)),j.renderer.paragraphs=d(a.paragraphs)},s=function(a){var b=function(a){a.span.topLevel().forEach(function(a){u.span.render(a)})},c=function(a){u.relation.reset(),a.relation.all().forEach(u.relation.render)};p().empty(),t.reset(),b(a),c(a)},t=function(){var a=function(a,b){var c=l.get(a.id);return c&&c.top===b.top&&c.left===b.left?void 0:b},b=function(a){_.compact(_.flatten(a.getEntities().map(f.annotationData.entity.assosicatedRelations)).map(d)).forEach(function(a){a.arrangePosition()})},c=function(a){return a?j.domUtil.selector.grid.get(a.id):void 0},e=function(a,d){return d?(c(a).css(d),l.set(a.id,d),b(a),a):void 0},g=function(a){var b=function(a){var b=m.getSpan(a.id);return{top:b.top-j.viewModel.viewMode.marginBottomOfGrid-c(a).outerHeight(),left:b.left}},d=function(a){var b=function(a){var d=0===a.children.length?0:Math.max.apply(null,a.children.map(function(a){return b(a)}));return c(a).outerHeight()+d+j.viewModel.viewMode.marginBottomOfGrid},d=m.getSpan(a.id),e=b(a);return{top:d.top-j.viewModel.viewMode.marginBottomOfGrid-e,left:d.left}};return 0===a.children.length?b(a):d(a)},h=function(a){return a&&a.hasClass("hidden")?a:void 0},i=function(a){a&&a.removeClass("hidden")},k=function(b){var d=_.compose(_.partial(e,b),_.partial(a,b));_.compose(i,h,c,d,g)(b)},n=function(a){a.children.forEach(function(a){n(a)}),a.getTypes().length>0&&k(a)},o=function(){m.reset(),f.annotationData.span.topLevel().forEach(function(a){_.defer(_.partial(n,a))})};return{arrangePositionAll:_.debounce(o,10),reset:l.clear,destroy:l.remove}}(),u=function(){var e=function(a){return a.remove()},i=function(a){e(j.domUtil.selector.grid.get(a)),t.destroy(a)},k=function(){var a=function(a,b){var c=m.getSpan(b),d=$("<div>").attr("id","G"+b).addClass("textae-editor__grid").addClass("hidden").css({width:c.width});return a.append(d),d},b=function(b){k.render=_.partial(a,b)};return{init:b,render:null}}(),n=function(a){return f.annotationData.modification.all().filter(function(b){return b.obj===a}).map(function(a){return"textae-editor__"+a.pred.toLowerCase()}).join(" ")},o=function(){var a=function(a){var b=function(a,b){var c=a.begin-b,d=a.end-b;return{start:c,end:d}},c=function(a,b,c){if(a.start<0||b.length<a.end)throw new Error("oh my god! I cannot render this span. "+c.toStringOnlyThis()+", textNode "+b.textContent)},d=function(a,b){var c=document.createRange();return c.setStart(a,b.start),c.setEnd(a,b.end),c},e=function(a,e,f){var g=b(a,e);return c(g,f,a),d(f,g)},f=function(){return 3===this.nodeType},g=function(a){return a.contents().filter(f).get(0)},h=function(a){return j.renderer.paragraphs[a].element},i=function(a,b,c){var d=_.compose(g,a),f=d(c.id);return e(b,c.begin,f)},k=_.partial(i,j.domUtil.selector.span.get),l=_.partial(i,h),m=a.getBigBrother();return m?e(a,m.end,document.getElementById(m.id).nextSibling):a.parent?k(a,a.parent):l(a,a.paragraph)},b=function(b,c){return a(b).surroundContents(c),b},c=function(a){var b=document.createElement("span");return b.setAttribute("id",a.id),b.setAttribute("title",a.id),b.setAttribute("class","textae-editor__span"),b},d=function(a){return b(a,c(a))},g=function(a){a.entities.forEach(_.compose(p.render,f.annotationData.entity.get))},h=function(a){return a.getTypes().forEach(g),a},k=function(a){return null!==document.getElementById(a.id)},l=function(a){return!a},m=function(a){for(var b=document.getElementById(a.id),c=b.parentNode;b.firstChild;)c.insertBefore(b.firstChild,b);e($(b)),c.normalize(),i(a.id)},n=function(a){var b=function(a){a.children.forEach(function(a){b(a)}),m(a)};return a.children.filter(k).forEach(b),a},o=function(a){return a.children.filter(_.compose(l,k)).forEach(q),a},q=_.compose(o,h,d,n);return{render:q,remove:m}}(),p=function(){var a=function(a,b){return $("#"+h.makeTypeId(a,b))},b=function(a){var b=a.outerWidth(),c=a.find(".textae-editor__entity").toArray().map(function(a){return a.offsetWidth}).reduce(function(a,b){return a+b},0);a.css({left:c>b?(b-c)/2:0})},c=function(a){return 0===f.annotationData.span.get(a).getTypes().length},d=function(c){var d=function(a){return 0===f.annotationData.span.get(c.span).getTypes().filter(function(b){return b.name===a}).length},g=e(j.domUtil.selector.entity.get(c.id)).attr("type");d(g)?a(c.span,g).remove():b(a(c.span,g).find(".textae-editor__entity-pane"))},g=function(a){d(a),l(a)},l=function(c){var d=function(b,c){var d=function(a){return String(a).indexOf("http")>-1},e=function(a){if(d(a)){var b=/\(?(?:(http|https|ftp):\/\/)?(?:((?:[^\W\s]|\.|-|[:]{1})+)@{1})?((?:www.)?(?:[^\W\s]|\.|-)+[\.][^\W\s]{2,4}|localhost|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::(\d*))?([\/]?[^\s\?]*[\/]{1})*(?:\/?([^\s\n\?\[\]\{\}\#]*(?:(?=\.)){1}|[^\s\n\?\[\]\{\}\.\#]*)?([\.]{1}[^\s\?\#]*)?)?(?:\?{1}([^\s\n\#\[\]]*))?([\#][^\s\n]*)?\)?/gi,c=b.exec(a);if(c)return c[9]?c[9].slice(1):c[6]?c[6]+(c[7]||""):c[5]?c[5].split("/").filter(function(a){return""!==a}).pop():c[3]}return a},f=function(a){return d(a)?a:j.viewModel.typeContainer.entity.getUri(a)?j.viewModel.typeContainer.entity.getUri(a):void 0},g=function(a,b){var c=h.makeTypeId(a,b),d=$("<div>").attr("id","P-"+c).addClass("textae-editor__entity-pane"),g=$("<div>").addClass("textae-editor__type-label").css({"background-color":j.viewModel.typeContainer.entity.getColor(b)}),i=f(b);return i?g.append($('<a target="_blank"/>').attr("href",i).text(e(b))):g.text(e(b)),$("<div>").attr("id",c).addClass("textae-editor__type").append(g).append(d)},i=function(a){var b=j.domUtil.selector.grid.get(a);return 0===b.length?k.render(a):b},l=a(b,c);return 0===l.length&&(l=g(b,c),i(b).append(l)),l},e=function(a){var b=$("<div>").attr("id",h.makeEntityDomId(a.id)).attr("title",a.id).attr("type",a.type).addClass("textae-editor__entity").css({"border-color":j.viewModel.typeContainer.entity.getColor(a.type)});return b.addClass(n(a.id)),b};c.type=String(c.type);var f=d(c.span,c.type).find(".textae-editor__entity-pane").append(e(c));b(f)},m=function(a){c(a.span)?i(a.span):d(a)};return{render:l,change:g,remove:m}}(),q=function(){var e,h=function(a){var b=jsPlumb.getInstance({ConnectionsDetachable:!1,Endpoint:["Dot",{radius:1}]});return b.setRenderMode(b.SVG),b.Defaults.Container=a,b},i=function(a){e=h(a)},k=function(a){return{sourceId:f.annotationData.relation.get(a).subj,targetId:f.annotationData.relation.get(a).obj}},o=function(a){var b=k(a),c=m.getEntity(b.sourceId),d=m.getEntity(b.targetId),e=c.center,f=d.center,g=c.top,h=d.top,i=Math.abs(e-f),j=Math.abs(g-h),l=i*q.settings.xrate+j*q.settings.yrate+q.settings.c_offset;return l/=2.4},p={width:7,length:9,location:1,id:"normal-arrow"},s={width:14,length:18,location:1,id:"hover-arrow"},t={cssClass:"textae-editor__relation__label",id:"label"},u=function(a){var b=d(a);b.endpoints[0].repaint(),b.endpoints[1].repaint(),b.removeOverlay("normal-arrow"),b.setConnector(["Bezier",{curviness:o(a)}]),b.addOverlay(["Arrow",p]),b.isVisible()||b.setVisible(!0)},v=function(a){var b=function(b){b.removeOverlay(p.id),b.addOverlay(["Arrow",s]),b.setPaintStyle(_.extend(a(),{lineWidth:3}))},c=function(b){b.removeOverlay(s.id),b.addOverlay(["Arrow",p]),b.setPaintStyle(a())},d=function(a){a.getOverlay(t.id).addClass("hover")},e=function(a){a.getOverlay(t.id).removeClass("hover")},f=function(a){a.getOverlay("label").addClass("ui-selected")},g=function(a){a.getOverlay("label").removeClass("ui-selected")},h=function(a){a.addClass("ui-selected")},i=function(a){a.removeClass("ui-selected")};return{pointup:function(){this.hasClass("ui-selected")||(b(this),d(this))},pointdown:function(){this.hasClass("ui-selected")||(c(this),e(this))},select:function(){b(this),e(this),f(this),h(this)},deselect:function(){c(this),g(this),i(this)}}},w=function(a){return this.connector.canvas.classList.contains(a)},x=function(a){var b=k(a);return l.isGridPrepared(b.sourceId)&&l.isGridPrepared(b.targetId)},y=function(a){var c=function(a){var c=a.slice(1);return r=parseInt(c.substr(0,2),16),g=parseInt(c.substr(2,2),16),b=parseInt(c.substr(4,2),16),"rgba("+r+", "+g+", "+b+", 1)"},d=f.annotationData.relation.get(a).pred,e=j.viewModel.typeContainer.relation.getColor(d);return{lineWidth:1,strokeStyle:c(e,1)}},z=function(a,b){return e.connect({source:j.domUtil.selector.entity.get(a.subj),target:j.domUtil.selector.entity.get(a.obj),anchors:["TopCenter","TopCenter"],connector:["Bezier",b],paintStyle:y(a.id),parameters:{id:a.id},cssClass:"textae-editor__relation",overlays:[["Arrow",p],["Label",_.extend({},t,{label:"["+a.id+"] "+a.pred,cssClass:t.cssClass+" "+n(a.id)})]]})},A=function(b){var d=!x(b.id),e=d?{}:{curviness:o(b.id)},f=z(b,e);d&&f.setVisible(!1);var g=_.partial(y,b.id);return _.extend(f,v(g),{arrangePosition:_.debounce(_.partial(u,b.id),20),hasClass:w}),f.bind("mouseenter",function(a){a.pointup()}).bind("mouseexit",function(a){a.pointdown()}),c[b.id]=f,a.trigger("textae.editor.jsPlumbConnection.add",f),f},B=function(a){var b=d(a.id);if(!b)throw"no connector";var c=b.getOverlays().filter(function(a){return"Label"===a.type})[0];if(!c)throw"no label overlay";c.setLabel("["+a.id+"] "+a.pred),b.setPaintStyle(y(a.id))},C=function(a){e.detach(d(a.id)),delete c[a.id]};return{settings:{connOpacity:.6,xrate:.6,yrate:.05,c_offset:20},init:i,reset:function(){e.reset(),c={}},render:A,change:B,remove:C}}();return{init:function(a){k.init(a),q.init(a)},span:o,entity:p,relation:q}}(),v=function(a){return a.id},w=function(){var a=function(a){var b=j.domUtil.selector.span.get(a);k.addClass(b)},b=function(a){var b=j.domUtil.selector.span.get(a);k.removeClass(b)},c=function(a){var b=j.domUtil.selector.entity.get(a);k.addClass(b)},g=function(a){var b=j.domUtil.selector.entity.get(a);k.removeClass(b)},h=function(a){var b=function(a){a&&a.select()},c=_.compose(b,d);c(a)},i=function(a){var b=function(a){a&&a.deselect()},c=_.compose(b,d);c(a)};f.selectionModel.bind("span.select",a).bind("span.deselect",b).bind("span.change",e.buttonStateHelper.updateBySpan).bind("entity.select",c).bind("entity.deselect",g).bind("relation.select",h).bind("relation.deselect",i).bind("relation.change",e.buttonStateHelper.updateByRelation)},x=_.partial(_.compose,t.arrangePositionAll);return{init:function(a){u.init(p()),f=a,f.annotationData.bind("change-text",q).bind("all.change",_.compose(f.selectionModel.clear,s)).bind("span.add",x(u.span.render)).bind("span.remove",x(u.span.remove)).bind("span.remove",_.compose(f.selectionModel.span.remove,v)).bind("entity.add",x(u.entity.render)).bind("entity.change",x(u.entity.change)).bind("entity.remove",x(u.entity.remove)).bind("entity.remove",_.compose(f.selectionModel.entity.remove,v)).bind("relation.add",u.relation.render).bind("relation.change",u.relation.change).bind("relation.remove",u.relation.remove).bind("relation.remove",_.compose(f.selectionModel.relation.remove,v)),w()},helper:function(){return{changeLineHeight:function(b){a.find(".textae-editor__body__text-box").css({"line-height":b+"px","margin-top":b/2+"px"})},getLineHeight:function(){return parseInt(a.find(".textae-editor__body__text-box").css("line-height"))/16},changeTypeGap:function(b){a.find(".textae-editor__type").css({height:18*b+18+"px","padding-top":18*b+"px"}),t.arrangePositionAll()},redraw:t.arrangePositionAll}}()}}(),k=function(){var a=function(a){return a.addClass("ui-selected")},b=function(a){return a.removeClass("ui-selected")};return{addClass:a,removeClass:b}}(),l={selector:{span:{get:function(b){return a.find("#"+b)}},entity:{get:function(a){return $("#"+h.makeEntityDomId(a))}},grid:{get:function(b){return a.find("#G"+b)}}},manipulate:{dismissBrowserSelection:function(){var a=window.getSelection();a.collapse(document.body,0)}},hover:function(){var a=function(a,b){i.annotationData.entity.assosicatedRelations(b).map(d).forEach(a)};return{on:_.partial(a,function(a){a.pointup()
}),off:_.partial(a,function(a){a.pointdown()})}}()};return{init:function(){j.viewModel.buttonStateHelper.init(),j.renderer.init(i)},renderer:f,domUtil:l,viewModel:e}}(this),k=function(b){var d=function(a){a=a||window.event,a.cancelBubble=!0,a.bubbles=!1,a.stopPropagation&&a.stopPropagation()},e=function(){var b=function(a){var b,c=$(a).parent(),d=c.attr("id");if(c.hasClass("textae-editor__body__text-box__paragraph"))b=j.renderer.paragraphs[d].begin;else{if(!c.hasClass("textae-editor__span"))return void console.log(d);b=i.annotationData.span.get(d).begin}for(var e=a.parentElement.childNodes,f=0;e[f]!=a;f++)b+="#text"==e[f].nodeName?e[f].nodeValue.length:$("#"+e[f].id).text().length;return b},c=function(a){var c=b(a.focusNode);return c+=a.focusOffset},d=function(a){var c=b(a.anchorNode);return c+a.anchorOffset},e=function(a){for(var b=a;k.spanConfig.isNonEdgeCharacter(i.annotationData.sourceDoc.charAt(b));)b++;for(;b>0&&!k.spanConfig.isDelimiter(i.annotationData.sourceDoc.charAt(b))&&!k.spanConfig.isDelimiter(i.annotationData.sourceDoc.charAt(b-1));)b--;return b},f=function(a){for(var b=a;k.spanConfig.isNonEdgeCharacter(i.annotationData.sourceDoc.charAt(b-1));)b--;for(;!k.spanConfig.isDelimiter(i.annotationData.sourceDoc.charAt(b))&&b<i.annotationData.sourceDoc.length;)b++;return b},g=function(a){for(var b=a;b<i.annotationData.sourceDoc.length&&(k.spanConfig.isNonEdgeCharacter(i.annotationData.sourceDoc.charAt(b))||!k.spanConfig.isDelimiter(i.annotationData.sourceDoc.charAt(b-1)));)b++;return b},l=function(a){for(var b=a;b>0&&(k.spanConfig.isNonEdgeCharacter(i.annotationData.sourceDoc.charAt(b-1))||!k.spanConfig.isDelimiter(i.annotationData.sourceDoc.charAt(b)));)b--;return b},m=function(b,c){if(i.annotationData.isBoundaryCrossingWithOtherSpans({begin:b,end:c}))return void j.domUtil.manipulate.dismissBrowserSelection();var d=h.makeSpanId(b,c);if(i.annotationData.span.get(d))return void j.domUtil.manipulate.dismissBrowserSelection();var e=[u.factory.spanCreateCommand({begin:b,end:c})];j.viewModel.modeAccordingToButton["replicate-auto"].value()&&c-b<=a.BLOCK_THRESHOLD&&e.push(u.factory.spanReplicateCommand({begin:b,end:c})),u.invoke(e),j.domUtil.manipulate.dismissBrowserSelection()},n=function(a){if(a.anchorNode.parentElement.id!==a.focusNode.parentElement.id)return console.log(a.anchorNode.parentElement.id,a.focusNode.parentElement.id),!1;var b=d(a),g=c(a);if(b>g){var h=b;b=g,g=h}var l=i.annotationData.sourceDoc.substring(b,g);return k.spanConfig.nonEdgeCharacters.forEach(function(a){l=l.replace(a,"")}),0===l.length?(j.domUtil.manipulate.dismissBrowserSelection(),!0):(i.selectionModel.clear(),m(e(b),f(g)),!0)},o=function(a,b,c){return a!==h.makeSpanId(b,c)?[u.factory.spanMoveCommand(a,b,c)]:void 0},p=function(a,b){var d=[],g=c(b),h=b.getRangeAt(0),j=document.createRange();if(j.selectNode(b.anchorNode),h.compareBoundaryPoints(Range.START_TO_START,j)<0){var k=e(g);d=o(a,k,i.annotationData.span.get(a).end)}else{var l=f(g);d=o(a,i.annotationData.span.get(a).begin,l)}u.invoke(d)},q=function(a,b){var d=[],e=c(b),f=b.getRangeAt(0),j=document.createRange();j.selectNode(b.focusNode);var m,n=function(a){return[u.factory.spanRemoveCommand(a)]};if(f.compareBoundaryPoints(Range.START_TO_START,j)>0){var p=l(e);p>i.annotationData.span.get(a).begin?(m=h.makeSpanId(i.annotationData.span.get(a).begin,p),d=i.annotationData.span.get(m)?n(a):o(a,i.annotationData.span.get(a).begin,p)):(i.selectionModel.span.add(a),k.userEvent.editHandler.removeSelectedElements())}else{var q=g(e);q<i.annotationData.span.get(a).end?(m=h.makeSpanId(q,i.annotationData.span.get(a).end),d=i.annotationData.span.get(m)?n(a):o(a,q,i.annotationData.span.get(a).end)):(i.selectionModel.span.add(a),k.userEvent.editHandler.removeSelectedElements())}u.invoke(d)},r=function(a){var b=i.selectionModel.span.single();if(b){var c=i.annotationData.span.get(b);return c.begin<a&&a<c.end}return!1},s=function(a){if(a.anchorNode.parentNode.parentNode===a.focusNode.parentNode)return i.selectionModel.clear(),p(a.anchorNode.parentNode.id,a),j.domUtil.manipulate.dismissBrowserSelection(),!0;if(r(d(a))){var b=i.selectionModel.span.all()[0];return j.domUtil.selector.span.get(b).parent().attr("id")===a.focusNode.parentNode.id?(p(b,a),j.domUtil.manipulate.dismissBrowserSelection(),!0):(alert("A span cannot be expanded to make a boundary crossing."),j.domUtil.manipulate.dismissBrowserSelection(),!0)}return!1},t=function(a){if(a.anchorNode.parentNode===a.focusNode.parentNode.parentNode)return i.selectionModel.clear(),q(a.focusNode.parentNode.id,a),j.domUtil.manipulate.dismissBrowserSelection(),!0;if(r(c(a))){var b=i.selectionModel.span.all()[0];return a.focusNode.parentNode.id===b?(q(b,a),j.domUtil.manipulate.dismissBrowserSelection(),!0):(alert("A span cannot be shrinked to make a boundary crossing."),j.domUtil.manipulate.dismissBrowserSelection(),!0)}return!1},v=function(){alert("It is ambiguous for which span you want to adjust the boundary. Select the span, and try again."),j.domUtil.manipulate.dismissBrowserSelection()};return{createSpanIfOneParent:n,expandIfable:s,shrinkIfable:t,overParagraph:v}}(),f=function(a){return 3!==a.anchorNode.nodeType||3!==a.focusNode.nodeType?!0:e.createSpanIfOneParent(a)?!1:e.expandIfable(a)?!1:(e.overParagraph(),!1)},g=function(a){return 3!==a.anchorNode.nodeType||3!==a.focusNode.nodeType?!0:e.createSpanIfOneParent(a)?!1:e.expandIfable(a)?!1:e.shrinkIfable(a)?!1:(e.overParagraph(),!1)},l=function(){var a=window.getSelection();return a.isCollapsed?(k.userEvent.viewHandler.cancelSelect(),j.domUtil.manipulate.dismissBrowserSelection(),!0):f(a)},m=function(a){var b=window.getSelection();if(b.isCollapsed){var c=i.selectionModel.span.single();if(a.shiftKey&&c){var d=$(this).attr("id");i.selectionModel.clear(),i.annotationData.span.range(c,d).forEach(function(a){i.selectionModel.span.add(a)})}else a.ctrlKey||a.metaKey?i.selectionModel.span.toggle(a.target.id):(i.selectionModel.clear(),i.selectionModel.span.add(a.target.id));return!1}return g(b)},n=function(a,b,c){var d=function(a){a.each(function(){i.selectionModel.entity.add($(this).attr("title"))})},e=function(a){a.each(function(){i.selectionModel.entity.remove($(this).attr("title"))})};return a?b.hasClass("ui-selected")?e(c):d(c):(i.selectionModel.clear(),d(c)),!1},o=function(a){var b=$(a.target);return n(a.ctrlKey||a.metaKey,b,b.next().children())},p=function(a){var b=$(a.target);return n(a.ctrlKey||a.metaKey,b.prev(),b.children())},q=function(a,b){var c=a.getParameter("id");b.ctrlKey||b.metaKey?i.selectionModel.relation.toggle(c):(i.selectionModel.clear(),i.selectionModel.relation.add(c))},r=null,s=function(a,b){return r&&r(a,b),d(b),!1},t=function(){k.userEvent.viewHandler.hideDialogs(),b.tool.selectMe(),j.viewModel.buttonStateHelper.propagate()},u=c.extendBindable(function(){var a=function(){var a=-1,b=-1,c=[],d=function(){return b>-1},e=function(){return b<c.length-1},f=function(){return b!=a},g=function(){u.trigger("change",{hasAnythingToSave:f(),hasAnythingToUndo:d(),hasAnythingToRedo:e()})};return{reset:function(){a=-1,b=-1,c=[],g()},push:function(a){c.splice(b+1,c.length-b,a),b++,g()},next:function(){return b++,g(),c[b]},prev:function(){var a=c[b];return b--,g(),a},saved:function(){a=b,g()},hasAnythingToSave:f,hasAnythingToUndo:d,hasAnythingToRedo:e}}(),b=function(a){a.forEach(function(a){a.execute()})};return{reset:function(b){i.annotationData.reset(b),a.reset()},updateSavePoint:function(){a.saved()},hasAnythingToSave:a.hasAnythingToSave,invoke:function(c){c&&c.length>0&&(b(c),a.push(c))},undo:function(){var c=function(a){return a=Object.create(a),a.reverse(),a.map(function(a){return a.revert()})};a.hasAnythingToUndo()&&(i.selectionModel.clear(),b(c(a.prev())))},redo:function(){a.hasAnythingToRedo()&&(i.selectionModel.clear(),b(a.next()))},factory:function(){var a=function(a){console.log("[command.invoke]",a)};return{spanCreateCommand:function(b){return{execute:function(){var c=i.annotationData.span.add({begin:b.begin,end:b.end});i.selectionModel.span.add(c.id),this.revert=_.partial(u.factory.spanRemoveCommand,c.id),a("create a new span, spanId:"+c.id)}}},spanRemoveCommand:function(b){return{execute:function(){var c=i.annotationData.span.get(b);i.annotationData.span.remove(b),this.revert=_.partial(u.factory.spanCreateCommand,{begin:c.begin,end:c.end}),a("remove a span, spanId:"+b)}}},spanMoveCommand:function(b,c,d){return{execute:function(){var e=[],f=h.makeSpanId(c,d);i.annotationData.span.get(f)||(e.push(u.factory.spanRemoveCommand(b)),e.push(u.factory.spanCreateCommand({begin:c,end:d})),i.annotationData.span.get(b).getTypes().forEach(function(a){a.entities.forEach(function(b){e.push(u.factory.entityCreateCommand(f,a.name,b))})})),e.forEach(function(a){a.execute()});var g=h.parseSpanId(b);this.revert=_.partial(u.factory.spanMoveCommand,f,g.begin,g.end),a("move a span, spanId:"+b+", newBegin:"+c+", newEnd:"+d)}}},spanReplicateCommand:function(b){var c=function(c){var d=c.map(function(a){return a.revert()});return function(){return{execute:function(){d.forEach(function(a){a.execute()}),a("revert replicate a span, begin:"+b.begin+", end:"+b.end)}}}};return{execute:function(){var d=i.getReplicationSpans(b,k.spanConfig).map(u.factory.spanCreateCommand);d.forEach(function(a){a.execute()});d.map(function(a){return a.revert()});this.revert=c(d),a("replicate a span, begin:"+b.begin+", end:"+b.end)}}},entityCreateCommand:function(b,c,d){return{execute:function(){var e=i.annotationData.entity.add({id:d,span:b,type:c});i.selectionModel.entity.add(e.id),this.revert=_.partial(u.factory.entityRemoveCommand,e.id,b,c),a("create a new entity, spanId:"+b+", type:"+c+"  entityId:"+e.id)}}},entityRemoveCommand:function(b){return{execute:function(){var c=i.annotationData.entity.get(b);i.annotationData.entity.remove(b),this.revert=_.partial(u.factory.entityCreateCommand,c.span,c.type,b),a("remove a entity, spanId:"+c.span+", type:"+c.type+", entityId:"+b)}}},entityChangeTypeCommand:function(b,c){return{execute:function(){var d=i.annotationData.entity.get(b).type,e=i.annotationData.entity.changeType(b,c);this.revert=_.partial(u.factory.entityChangeTypeCommand,b,d),a("change type of a entity, spanId:"+e.span+", type:"+d+", entityId:"+b+", newType:"+c)}}},relationCreateCommand:function(b,c,d,e){return{execute:function(){var f=i.annotationData.relation.add({id:e,pred:d,subj:b,obj:c});_.delay(_.partial(i.selectionModel.relation.add,f.id),100),this.revert=_.partial(u.factory.relationRemoveCommand,f.id),a("create a new relation relationId:"+f.id+", subject:"+b+", object:"+c+", predicate:"+d)}}},relationRemoveCommand:function(b){return{execute:function(){var c=i.annotationData.relation.get(b),d=c.subj,e=c.obj,f=c.pred;i.annotationData.relation.remove(b),this.revert=_.partial(u.factory.relationCreateCommand,d,e,f,b),a("remove a relation relationId:"+b+", subject:"+d+", object:"+e+", predicate:"+f)}}},relationChangePredicateCommand:function(b,c){return{execute:function(){var d=i.annotationData.relation.get(b).pred;i.annotationData.relation.changePredicate(b,c),this.revert=_.partial(u.factory.relationChangePredicateCommand,b,d),a("change predicate of relation, relationId:"+b+", subject:"+i.annotationData.relation.get(b).subj+", object:"+i.annotationData.relation.get(b).obj+", predicate:"+d+", newPredicate:"+c)}}}}}()}}()),v=function(){var a;return{editHandler:function(){return{replicate:function(){var a=i.selectionModel.span.single();a?u.invoke([u.factory.spanReplicateCommand(i.annotationData.span.get(a))]):alert("You can replicate span annotation when there is only span selected.")},createEntity:function(){var a=i.selectionModel.span.all().map(function(a){return u.factory.entityCreateCommand(a,j.viewModel.typeContainer.entity.getDefaultType())});u.invoke(a)},setEntityType:function(){var b=$(this).attr("label");return a(b),!1},newLabel:function(){if(i.selectionModel.entity.some()||i.selectionModel.relation.some()){var b=prompt("Please enter a new label","");b&&a(b)}},removeSelectedElements:function(){var a=function(){var a=[],b=[],c=[];return{addSpanId:function(b){a.push(b)},addEntityId:function(a){b.push(a)},addRelations:function(a){c=c.concat(a)},getAll:function(){return _.uniq(c).map(u.factory.relationRemoveCommand).concat(_.uniq(b).map(function(a){return u.factory.entityRemoveCommand(a)}),_.uniq(a).map(u.factory.spanRemoveCommand))}}}(),b=function(b){a.addEntityId(b),a.addRelations(i.annotationData.entity.assosicatedRelations(b))};i.selectionModel.span.all().forEach(function(c){a.addSpanId(c),i.annotationData.span.get(c).getTypes().forEach(function(a){a.entities.forEach(function(a){b(a)})})}),i.selectionModel.entity.all().forEach(function(a){b(a)}),a.addRelations(i.selectionModel.relation.all()),u.invoke(a.getAll())},copyEntities:function(){j.viewModel.clipBoard=_.uniq(function(){return _.flatten(i.selectionModel.span.all().map(function(a){return i.annotationData.span.get(a).getEntities()}))}().concat(i.selectionModel.entity.all()))},pasteEntities:function(){var a=_.flatten(i.selectionModel.span.all().map(function(a){return j.viewModel.clipBoard.map(function(b){return u.factory.entityCreateCommand(a,i.annotationData.entity.get(b).type)})}));u.invoke(a)}}}(),viewHandler:function(){var d={},e=function(){var c=function(a,b,c){var d=a();if(d.length>0){var e=d.map(function(a){return b(a,c)});u.invoke(e)}},e=function(){return b.off("mouseup",".textae-editor__body").off("mouseup",".textae-editor__span").off("mouseup",".textae-editor__type-label").off("mouseup",".textae-editor__entity-pane").off("mouseup",".textae-editor__entity")};return{relationEdit:function(){var b=function(a){if(i.selectionModel.entity.some()){var b=i.selectionModel.entity.all()[0],c=$(a.target).attr("title");b===c?i.selectionModel.entity.remove(b):(i.selectionModel.entity.add(c),_.defer(function(){if(u.invoke([u.factory.relationCreateCommand(b,c,j.viewModel.typeContainer.relation.getDefaultType())]),a.ctrlKey||a.metaKey)i.selectionModel.entity.remove(c);else{if(a.shiftKey)return j.domUtil.manipulate.dismissBrowserSelection(),i.selectionModel.entity.remove(b),i.selectionModel.entity.add(c),!1;i.selectionModel.entity.remove(b),i.selectionModel.entity.remove(c)}}))}else i.selectionModel.clear(),i.selectionModel.entity.add($(a.target).attr("title"))};e().on("mouseup",".textae-editor__entity",b),d.typeContainer=j.viewModel.typeContainer.relation,a=_.partial(c,i.selectionModel.relation.all,u.factory.relationChangePredicateCommand),r=q},noRelationEdit:function(){var b=function(a){var b=$(a.target);return a.ctrlKey||a.metaKey?i.selectionModel.entity.toggle(b.attr("title")):(i.selectionModel.clear(),i.selectionModel.entity.add(b.attr("title"))),!1};e().on("mouseup",".textae-editor__body",l).on("mouseup",".textae-editor__span",m).on("mouseup",".textae-editor__type-label",o).on("mouseup",".textae-editor__entity-pane",p).on("mouseup",".textae-editor__entity",b),d.typeContainer=j.viewModel.typeContainer.entity,a=_.partial(c,i.selectionModel.entity.all,u.factory.entityChangeTypeCommand),r=null},noEdit:function(){e(),d.typeContainer=null,a=null,r=null}}}(),f=function(){var a=function(){k.userEvent.viewHandler.hideDialogs(),i.selectionModel.clear()},b={toTerm:function(){a(),e.noRelationEdit(),j.viewModel.viewMode.setTerm(),j.viewModel.viewMode.setEditable(!0),j.renderer.helper.redraw(),f=d.termCentric},toInstance:function(){a(),e.noRelationEdit(),j.viewModel.viewMode.setInstance(),j.viewModel.viewMode.setEditable(!0),j.renderer.helper.redraw(),f=d.instanceRelation},toRelation:function(){a(),e.relationEdit(),j.viewModel.viewMode.setRelation(),j.viewModel.viewMode.setEditable(!0),j.renderer.helper.redraw(),f=d.relationEdit},toViewTerm:function(){a(),e.noEdit(),j.viewModel.viewMode.setTerm(),j.viewModel.viewMode.setEditable(!1),j.renderer.helper.redraw(),f=d.viewTerm},toViewInstance:function(){a(),e.noEdit(),j.viewModel.viewMode.setInstance(),j.viewModel.viewMode.setEditable(!1),j.renderer.helper.redraw(),f=d.viewInstance}},c=function(){j.renderer.helper.redraw()},d={termCentric:_.extend({},b,{name:"Term Centric",toTerm:c}),instanceRelation:_.extend({},b,{name:"Instance / Relation",toInstance:c}),relationEdit:_.extend({},b,{name:"Relation Edit",toRelation:c}),viewTerm:_.extend({},b,{name:"View Only",toTerm:c,toInstance:b.toViewInstance,toRelation:c,toViewTerm:c}),viewInstance:_.extend({},b,{name:"View Only",toTerm:b.toViewTerm,toInstance:c,toRelation:c,toViewInstance:c})};return{init:function(){b.toTerm()}}}(),g=function(){$(window).trigger("resize")},h=function(a){return _.debounce(a,300)},n=function(a){return 16*a},s=h(_.compose(g,j.renderer.helper.changeLineHeight,n)),t=h(j.renderer.helper.changeTypeGap);return{init:function(){f.init()},showPallet:function(){var a=function(a){return function(){k.userEvent.viewHandler.hidePallet(),a.call(this)}},b=function(b){var c=function(c){var d=$("<input>").addClass("textae-editor__entity-pallet__entity-type__radio").attr({type:"radio",name:"etype",label:c}).change(a(function(){return b.setDefaultType($(this).attr("label")),!1}));return c===b.getDefaultType()&&d.attr({title:"default type",checked:"checked"}),d},d=function(a){return a?$("<a>").attr({href:a,target:"_blank"}).append($("<span>").addClass("textae-editor__entity-pallet__link")):void 0},e=function(a){return a?$("<td>").append(a):$("<td>")},f=_.compose(e,c),g=function(a){return $("<td>").addClass("textae-editor__entity-pallet__entity-type__label").attr("label",a).text(a)},h=_.compose(e,d,b.getUri);return b.getSortedNames().map(function(a){var c=f(a),d=g(a),e=h(a);return $("<tr>").addClass("textae-editor__entity-pallet__entity-type").css({"background-color":b.getColor(a)}).append([c,d,e])})},c=function(b){return $("<div>").addClass("textae-editor__entity-pallet").append($("<table>")).css("position","fixed").on("click",".textae-editor__entity-pallet__entity-type__label",a(b)).hide()},e=function(a){var b=$(".textae-editor__entity-pallet");return 0!==b.length?b.find("table").empty().end().css("width","auto"):($("body").append(a),a)},f=function(a){return a.find("table").append(b(d.typeContainer)).end()},g=function(a){return a.outerHeight()+"px"===a.css("max-height")?a.css("overflow-y","scroll"):a.css("overflow-y","")},h=_.compose(g,f,e,c);return function(a){d.typeContainer&&d.typeContainer.getSortedNames().length>0&&h(k.userEvent.editHandler.setEntityType).css(a).show()}}(),hidePallet:function(){$(".textae-editor__entity-pallet").hide()},hideDialogs:function(){k.userEvent.viewHandler.hidePallet(),b.tool.cancel()},redraw:function(){j.renderer.helper.redraw()},cancelSelect:function(){return window.getSelection().isCollapsed?(i.selectionModel.clear(),void k.userEvent.viewHandler.hideDialogs()):(j.domUtil.manipulate.dismissBrowserSelection(),!0)},selectLeftSpan:function(){var a=i.selectionModel.span.single();if(a){var b=i.annotationData.span.get(a);i.selectionModel.clear(),b.left&&i.selectionModel.span.add(b.left.id)}},selectRightSpan:function(){var a=i.selectionModel.span.single();if(a){var b=i.annotationData.span.get(a);i.selectionModel.clear(),b.right&&i.selectionModel.span.add(b.right.id)}},showSettingDialog:function(){var a;return function(){var d=function(){return $("<div>").addClass("textae-editor__setting-dialog")},e=function(a){return a.append($("<div>").append('<label class="textae-editor__setting-dialog__label">Line Height').append($("<input>").attr({type:"number",step:1,min:3,max:10,value:j.renderer.helper.getLineHeight()}).addClass("textae-editor__setting-dialog__line-height"))).on("change",".textae-editor__setting-dialog__line-height",function(){s($(this).val())})},g=function(a){return a.append($("<div>").append('<label class="textae-editor__setting-dialog__label">Instance/Relation View').append($("<input>").attr({type:"checkbox"}).addClass("textae-editor__setting-dialog__term-centric-view"))).on("click",".textae-editor__setting-dialog__term-centric-view",function(){$(this).is(":checked")?f.toInstance():f.toTerm()})},h=function(b){return b.append($("<div>").append('<label class="textae-editor__setting-dialog__label">Type Gap').append($("<input>").attr({type:"number",step:1,min:0,max:5}).addClass("textae-editor__setting-dialog__type_gap"))).on("change",".textae-editor__setting-dialog__type_gap",function(){a=$(this).val(),t(a)})},i=function(a){return c.getDialog(b.editorId,"textae.dialog.setting","Chage Settings",a,!0)},k=function(a){return a.find(".textae-editor__setting-dialog__term-centric-view").prop({checked:j.viewModel.viewMode.isTerm()?null:"checked"}).end()},l=function(b){return b.find(".textae-editor__setting-dialog__type_gap").prop({value:a?a:j.viewModel.viewMode.isTerm()?0:1}).end()},m=function(a){return a.open()};_.compose(m,l,k,i,h,g,e,d)()}}(),toggleRelationEditMode:function(){j.viewModel.modeAccordingToButton["relation-edit-mode"].value()?f.toInstance():f.toRelation()},setViewMode:function(a){f["to"+a]&&f["to"+a]()}}}()}}(),w={delimiterCharacters:null,nonEdgeCharacters:null,defaults:{"delimiter characters":[" ",".","!","?",",",":",";","-","/","&","(",")","{","}","[","]","+","*","\\",'"',"'","\n",""],"non-edge characters":[" ","\n"]},set:function(a){var b=$.extend({},this.defaults,a);void 0!==b["delimiter characters"]&&(this.delimiterCharacters=b["delimiter characters"]),void 0!==b["non-edge characters"]&&(this.nonEdgeCharacters=b["non-edge characters"])},isNonEdgeCharacter:function(a){return this.nonEdgeCharacters.indexOf(a)>=0},isDelimiter:function(a){return this.delimiterCharacters.indexOf("ANY")>=0?1:this.delimiterCharacters.indexOf(a)>=0}};return{init:function(a){b.on("mousedown",function(a){return a.shiftKey?!1:void 0}).on("mousedown",".textae-editor__type",function(){return!1}).on("mousedown",".textae-editor__body__text-box__paragraph-margin",function(a){return"textae-editor__body__text-box__paragraph-margin"===a.target.className?!1:void 0}),b.on("mouseup",".textae-editor__body,.textae-editor__span,.textae-editor__grid,.textae-editor__entity",t).on("mouseenter",".textae-editor__entity",function(){j.domUtil.hover.on($(this).attr("title"))}).on("mouseleave",".textae-editor__entity",function(){j.domUtil.hover.off($(this).attr("title"))}),b.on("textae.editor.jsPlumbConnection.add",function(a,b){b.bind("click",s)}),u.bind("change",function(b){j.viewModel.buttonStateHelper.enabled("write",b.hasAnythingToSave),j.viewModel.buttonStateHelper.enabled("undo",b.hasAnythingToUndo),j.viewModel.buttonStateHelper.enabled("redo",b.hasAnythingToRedo),window.onbeforeunload=b.hasAnythingToSave?function(){return a}:null}),k.userEvent.viewHandler.init()},command:u,userEvent:v,spanConfig:w}}(this);return this.api=function(a){var b=function(a){var b=$.extend(c.getUrlParameters(location.search),{config:a.attr("config"),target:a.attr("target"),mode:a.attr("mode")}),d=a.text();return a.empty(),b.annotation={inlineAnnotation:d,url:b.target},b},d=function(a){var b=23,c=6,d=64,e=_.max(i.annotationData.span.all().map(function(d){var e=b+c,f=function(b){e+=b.getTypes().length*a+j.viewModel.viewMode.marginBottomOfGrid,b.parent&&f(b.parent)};return f(d),e}).concat(d));j.renderer.helper.changeLineHeight(e)},e=function(a){i.annotationData.relation.some()||i.annotationData.span.multiEntities().length>0?(k.userEvent.viewHandler.setViewMode(a+"Instance"),d(36)):(k.userEvent.viewHandler.setViewMode(a+"Term"),d(18))},g=_.partial(e,""),h=_.compose(function(){j.viewModel.buttonStateHelper.enabled("replicate-auto",!1),j.viewModel.buttonStateHelper.enabled("relation-edit-mode",!1)},_.partial(e,"View")),l=function(a,b){var d=function(a){var b=function(a){j.viewModel.typeContainer.setDefinedEntityTypes(a["entity types"]),j.viewModel.typeContainer.setDefinedRelationTypes(a["relation types"]),void 0!==a.css&&$("#css_area").html('<link rel="stylesheet" href="'+a.css+'"/>')};if(k.spanConfig.set(),a.config){var d=c.ajaxAccessor.getSync(a.config);null!==d?(k.spanConfig.set(d),b(d)):alert("could not read the span configuration from the location you specified.")}},e=function(a){var b="edit"===a.mode?g:h;i.annotationData.bind("all.change",b)},f=function(a){var c=a.annotation;c&&(c.inlineAnnotation?(k.command.reset(JSON.parse(c.inlineAnnotation)),_.defer(k.userEvent.viewHandler.redraw)):c.url&&b.getAnnotationFromServer(c.url))};d(a),e(a),f(a)},m=function(b){var c=f(a,b);return c.bind("save",k.command.updateSavePoint),c.bind("load",k.command.reset),c},n=function(a,b,c){a[b]&&a[b](c)},o=function(b){var c=function(){b.showAccess(k.command.hasAnythingToSave())},d=function(){b.showSave(i.annotationData.toJson())},e={A:c,C:k.userEvent.editHandler.copyEntities,D:k.userEvent.editHandler.removeSelectedElements,DEL:k.userEvent.editHandler.removeSelectedElements,E:k.userEvent.editHandler.createEntity,Q:k.userEvent.viewHandler.showPallet,R:k.userEvent.editHandler.replicate,S:d,V:k.userEvent.editHandler.pasteEntities,W:k.userEvent.editHandler.newLabel,X:k.command.redo,Y:k.command.redo,Z:k.command.undo,ESC:k.userEvent.viewHandler.cancelSelect,LEFT:k.userEvent.viewHandler.selectLeftSpan,RIGHT:k.userEvent.viewHandler.selectRightSpan},f={"textae.control.button.read.click":c,"textae.control.button.write.click":d,"textae.control.button.undo.click":k.command.undo,"textae.control.button.redo.click":k.command.redo,"textae.control.button.replicate.click":k.userEvent.editHandler.replicate,"textae.control.button.replicate_auto.click":j.viewModel.modeAccordingToButton["replicate-auto"].toggle,"textae.control.button.relation_edit_mode.click":k.userEvent.viewHandler.toggleRelationEditMode,"textae.control.button.entity.click":k.userEvent.editHandler.createEntity,"textae.control.button.change_label.click":k.userEvent.editHandler.newLabel,"textae.control.button.pallet.click":k.userEvent.viewHandler.showPallet,"textae.control.button.delete.click":k.userEvent.editHandler.removeSelectedElements,"textae.control.button.copy.click":k.userEvent.editHandler.copyEntities,"textae.control.button.paste.click":k.userEvent.editHandler.pasteEntities,"textae.control.button.setting.click":k.userEvent.viewHandler.showSettingDialog};a.api={handleKeyInput:_.partial(n,e),handleButtonClick:_.partial(n,f),redraw:k.userEvent.viewHandler.redraw}},p=function(a){var c="There is a change that has not been saved. If you procceed now, you will lose it.",d=b(a);j.init(),k.init(c);var e=m(c);l(d,e),o(e)};return{start:p}}(this),this},i=function(){var a={enable:function(a){a.removeClass("textae-control__icon--disabled")},disable:function(a){a.addClass("textae-control__icon--disabled")},isDisable:function(a){return a.hasClass("textae-control__icon--disabled")},push:function(a){a.addClass("textae-control__icon--pushed")},unpush:function(a){a.removeClass("textae-control__icon--pushed")},isPushed:function(a){return a.hasClass("textae-control__icon--pushed")}},b=function(a){var b=function(){return $("<span>").addClass("textae-control__title").append($("<a>").attr("href","http://bionlp.dbcls.jp/textae/").text("TextAE"))},c=function(){var a=function(a,b){var c=$("<span>").addClass("textae-control__icon").addClass("textae-control__"+a+"-button").attr("title",b);return f[a]={instance:c,eventName:"textae.control.button."+a.replace(/-/g,"_")+".click"},c},b=function(b){var c=[$("<span>").addClass("textae-control__separator")];return $.each(b,function(b,d){c.push(a(b,d))}),c};return $("<span>").append([{read:"Access [A]",write:"Save [S]"},{undo:"Undo [Z]",redo:"Redo [X]"},{replicate:"Replicate span annotation [R]","replicate-auto":"Auto replicate (Toggle)","relation-edit-mode":"Edit Relation"},{entity:"New entity [E]",pallet:"Select label [Q]","change-label":"Change label [W]"},{"delete":"Delete [D]",copy:"Copy [C]",paste:"Paste [V]"},{setting:"Setting"},{help:"Help [H]",about:"About"}].map(b).reduce(function(a,b){return a.concat(b)}))};a.append(b()).append(c())},c=function(b,d){if(1===arguments.length)$.each(arguments[0],function(a,b){c(a,b)});else if(2===arguments.length){var e=f[b],g="click",h=this.trigger.bind(this,"textae.control.button.click",e.eventName);e&&(d?(e.instance.off(g).on(g,h),a.enable(e.instance)):(e.instance.off(g),a.disable(e.instance)))}}.bind(this),d=function(a){c($.extend({},f,a))},e=function(b,c){var d=f[b].instance;c?a.push(d):a.unpush(d)},f={};return b(this),c({read:!0,"replicate-auto":!0,help:!0,about:!0}),this.updateAllButtonEnableState=d,this.updateButtonPushState=e,this},j=function(){{var a=function(){var a=c.makeInformationModal({className:"textae-control__help",addContentsFunc:function(){this.append($("<h3>").text("Help (Keyboard short-cuts)")).append($("<div>").addClass("textae-tool__key-help"))}}),b=c.makeInformationModal({className:"textae-control__about",addContentsFunc:function(){this.html("<h3>About TextAE (Text Annotation Editor)</h3><p>TextAEPubAnnotation</p><p>PubAnnotationPubMed</p><p>Entrez Gene ID</p><p></p><p>PubAnnotation</p><p></p>")}});return{control:null,editors:$.extend([],{getNewId:function(){return"editor"+this.length},select:function(a){this.selected=a,console.log(a.editorId)},selectFirst:function(){this.select(this[0])},selected:null}),infoModals:{help:a,about:b,hideAll:_.compose(a.hide,b.hide)}}}(),b=function(){var a={},b=function(b){a={top:b.clientY,left:b.clientX}},c=_.debounce(b,30);return $("html").on("mousemove",c),function(){return a}}(),d={handleKeyInput:function(c){"H"===c?a.infoModals.help.show():(a.editors.selected&&a.editors.selected.api.handleKeyInput(c,b()),"ESC"===c&&a.infoModals.hideAll())},handleButtonClick:function(c){switch(c){case"textae.control.button.help.click":a.infoModals.help.show();break;case"textae.control.button.about.click":a.infoModals.about.show();break;default:a.editors.selected&&a.editors.selected.api.handleButtonClick(c,b())}},handleEditor:{select:function(b){a.editors.select(b)},"public":{cancel:function(){a.infoModals.hideAll()},changeButtonState:function(b,c){a.control&&b===a.editors.selected&&a.control.updateAllButtonEnableState(c)},push:function(b,c){a.control&&a.control.updateButtonPushState(b,c)}}}};!function(){var b=function(){var a={27:"ESC",46:"DEL",37:"LEFT",39:"RIGHT"},b=function(b){return b>=65&&90>=b?String.fromCharCode(b):a[b]?a[b]:void 0},c=function(a){return a.keyCode},e=_.compose(d.handleKeyInput,b,c),f=e;$(document).on("keyup",function(a){f(a)}),$("body").on("dialogopen",".ui-dialog",function(){f=function(){}}).on("dialogclose",".ui-dialog",function(){f=e})},c=function(){$(window).on("resize",_.debounce(function(){a.editors.forEach(function(a){_.defer(a.api.redraw)})},20))};$(_.compose(c,b))}()}return{setControl:function(b){b.on("textae.control.button.click",function(){d.handleButtonClick.apply(null,_.rest(arguments))}),a.control=b},pushEditor:function(b){a.editors.push(b),$.extend(b,{editorId:a.editors.getNewId(),tool:$.extend({selectMe:_.partial(d.handleEditor.select,b)},d.handleEditor.public)})},selectFirstEditor:function(){a.editors.selectFirst()}}}();a.fn.textae=function(){return function(){if(this.hasClass("textae-editor"))this.each(function(){var a=$(this);return j.pushEditor(a),h.apply(a),a.api.start(a),a}),j.selectFirstEditor();else if(this.hasClass("textae-control")){var a=i.apply(this);return j.setControl(a),a}}}(),$(function(){$(".textae-control").textae(),$(".textae-editor").textae()})}(jQuery);